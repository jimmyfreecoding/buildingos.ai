[
    {
        "id": "f788b38babc60666",
        "type": "tab",
        "label": "IOT统一平台",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "900ba3388f213e1f",
        "type": "tab",
        "label": "物联网时序数据",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8042f0ad90564885",
        "type": "tab",
        "label": "AI摄像头",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "394aac3a21e63bca",
        "type": "tab",
        "label": "气象站",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "53d9bed59d4906b4",
        "type": "tab",
        "label": "边缘网关",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c1600d84541be6c7",
        "type": "tab",
        "label": "MQTT to TimescaleDB 1w/s sample",
        "disabled": true,
        "info": ""
    },
    {
        "id": "0e45c8c7cafe4e98",
        "type": "mqtt-broker",
        "name": "mqtt服务器",
        "broker": "emqx",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "5",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "3b690b97c528cfca",
        "type": "postgreSQLConfig",
        "name": "",
        "host": "postgres",
        "hostFieldType": "str",
        "port": 5432,
        "portFieldType": "num",
        "database": "buildingos",
        "databaseFieldType": "str",
        "ssl": "false",
        "sslFieldType": "bool",
        "applicationName": "",
        "applicationNameType": "str",
        "max": 10,
        "maxFieldType": "num",
        "idle": 1000,
        "idleFieldType": "num",
        "connectionTimeout": 10000,
        "connectionTimeoutFieldType": "num",
        "user": "buildingos",
        "userFieldType": "str",
        "password": "buildingos_prod_2024",
        "passwordFieldType": "str"
    },
    {
        "id": "8d95443694bab17c",
        "type": "modbus-client",
        "name": "485B",
        "clienttype": "serial",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "127.0.0.1",
        "tcpPort": "502",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyS4",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": "9600",
        "serialDatabits": "8",
        "serialStopbits": "1",
        "serialParity": "none",
        "serialConnectionDelay": "200",
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": "1",
        "commandDelay": "1",
        "clientTimeout": "200",
        "reconnectOnTimeout": true,
        "reconnectTimeout": "2000",
        "parallelUnitIdsAllowed": true
    },
    {
        "id": "9d637136d961055b",
        "type": "modbus-client",
        "name": "485C",
        "clienttype": "serial",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "127.0.0.1",
        "tcpPort": "502",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyS1",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": "9600",
        "serialDatabits": "8",
        "serialStopbits": "1",
        "serialParity": "none",
        "serialConnectionDelay": "100",
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": "1",
        "commandDelay": "1",
        "clientTimeout": "200",
        "reconnectOnTimeout": true,
        "reconnectTimeout": "2000",
        "parallelUnitIdsAllowed": true
    },
    {
        "id": "1b551f8c3299877d",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "边缘网关设备配置上报",
        "topic": "/iot/discover/devices",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 440,
        "y": 180,
        "wires": [
            [
                "579b3b2b59340666"
            ]
        ]
    },
    {
        "id": "c80c88e343074d88",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 62",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 180,
        "wires": []
    },
    {
        "id": "579b3b2b59340666",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let result = msg.payload\nif (result.gateway && result.layer && result.devices && result.layers){\n    let gateway = result.gateway\n    let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", gateway)\n    if(gateways[0] == undefined){\n        msg.error = \"无效网关：\"+gateway\n        return msg\n    }\n\n    //清理数据\n    let where = \"\"\n    for(let i = 0; i < result.layers.length; i++){\n        where += \" and layer != '\"+result.layers[i]+\"' \"\n    }\n    let d_iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? \" + where, gateways[0].id)\n    for(let i = 0; i < d_iot_devices.length; i++){\n        await global.get(\"mysql_query\")(\"delete from iot_device_action where gatewayID = ? and deviceID = ?\", [gateways[0].id, d_iot_devices[i].id])\n        await global.get(\"mysql_query\")(\"delete from iot_device where id = ?\", d_iot_devices[i].id)\n    }\n\n    //现有库数据过滤被删除数据\n    let s_iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ?\", [gateways[0].id, result.layer])\n    let s_iot_devices_obj = {}\n    for (let i = 0; i < s_iot_devices.length; i++){\n        s_iot_devices_obj[s_iot_devices[i].id] = true\n    }\n\n\n    let items = result.devices\n    for(let i = 0; i < items.length; i++){\n        let code = items[i].code\n        let name = items[i].name\n        let type = items[i].type\n        let protocol = items[i].protocol\n        let iotType = items[i].iottype\n        let channel = items[i].channel\n        let gatewayID = gateways[0].id\n        let gatewayName = gateways[0].name\n        let layer = result.layer\n        let spaceCode = gateways[0].spaceCode\n        let spaceName = gateways[0].spaceName\n        let areaCode = gateways[0].areaCode\n        let areaName = gateways[0].areaName\n        let floorCode = gateways[0].floorCode\n        let floorName = gateways[0].floorName\n        let floorAreaType = \"\"\n        let floorAreaCode = \"\"\n        let floorAreaName = \"\"\n        if(items[i].area){\n            let areaArr = items[i].area.split(\"_\")\n            if(areaArr[2]){\n                floorAreaType = areaArr[0]\n                floorAreaCode = areaArr[1]\n                floorAreaName = areaArr[2]\n            }\n        }\n\n        let createtime = parseInt(new Date().getTime() / 1000)\n\n        let values = [code, name, type, protocol, iotType, channel, gatewayID, gatewayName, layer, spaceCode, spaceName, areaCode, areaName, floorCode, floorName, floorAreaType, floorAreaCode, floorAreaName, createtime]\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gatewayID, layer, code])\n        if (iot_devices[0] == undefined){\n            await global.get(\"mysql_query\")('insert into iot_device(code, name, type, protocol, iotType, channel, gatewayID, gatewayName, layer, spaceCode, spaceName, areaCode, areaName, floorCode, floorName, floorAreaType, floorAreaCode, floorAreaName, createtime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n            iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gatewayID, layer, code])\n            if (iot_devices[0] == undefined){\n                msg.error = \"添加设备失败,code:\" + code\n                return msg\n            }\n        }else{\n            await global.get(\"mysql_query\")('update iot_device set code = ?, name = ?, type = ?, protocol = ?, iotType = ?, channel = ?, gatewayID = ?, gatewayName = ?, layer = ?, spaceCode = ?, spaceName = ?, areaCode = ?, areaName = ?, floorCode = ?, floorName = ?, floorAreaType = ?, floorAreaCode = ?, floorAreaName = ?, createtime = ? where id = \"' + iot_devices[0].id +'\" limit 1', values)\n            if (s_iot_devices_obj[iot_devices[0].id]){\n                delete s_iot_devices_obj[iot_devices[0].id]\n            }\n        }\n\n        await global.get(\"mysql_query\")(\"delete from iot_device_action where gatewayID = ? and deviceID = ?\", [gatewayID, iot_devices[0].id])\n        if (items[i].actions){\n            let actions = items[i].actions\n            for (let j = 0; j < actions.length; j++) {\n                let gatewayID = gateways[0].id\n                let deviceID = iot_devices[0].id\n                let name = actions[j].name\n                let type = actions[j].type\n                let createtime = parseInt(new Date().getTime() / 1000)\n                let actionValues = [gatewayID, deviceID, name, type, createtime]\n                await global.get(\"mysql_query\")('insert into iot_device_action(gatewayID, deviceID, name, type, createtime) values (?,?,?,?,?)', actionValues)\n            }\n        }\n    }\n\n    Object.keys(s_iot_devices_obj).forEach(async function(id) {\n        await global.get(\"mysql_query\")(\"delete from iot_device_action where gatewayID = ? and deviceID = ?\", [gateways[0].id, id])\n        await global.get(\"mysql_query\")(\"delete from iot_device where id = ?\", id)\n    });\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 180,
        "wires": [
            [
                "c80c88e343074d88"
            ]
        ]
    },
    {
        "id": "b74a64229ae18a48",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取网关所在楼层区域及设备",
        "func": "\n/**\n * 数据结构\n{\n    \"floors\":[\n        {\n            \"floorCode\":\"20\",\n            \"floorName\":\"20f\",\n            \"areas\": [\n                {\n                    \"areaCode\": \"d\",\n                    \"areaName\": \"工位D区\",\n                    \"areaType\": \"area\"\n                },\n                {\n                    \"areaCode\": \"2001\",\n                    \"areaName\": \"2001会议室\",\n                    \"areaType\": \"meetingroom\"\n                },\n                {\n                    \"areaCode\": \"ck\",\n                    \"areaName\": \"库房\",\n                    \"areaType\": \"room\"\n                }\n            ]\n        }\n    ]\n}\n */\nlet macaddr = msg.payload.mac\nlet layer = msg.payload.layer\nif(!macaddr || !layer){\n    msg.error = \"无效请求\"\n    return msg\n}\nlet iot_gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where deleteFlag = 1 and macaddr = ?\", macaddr)\nif (!iot_gateways[0]){\n    msg.error = \"无效网关\"\n    return msg\n}\n\nlet result = {}\nresult.spaceCode = iot_gateways[0].spaceCode\nresult.spaceName = iot_gateways[0].spaceName\nresult.floorAreaCode = iot_gateways[0].areaCode\nresult.floorAreaName = iot_gateways[0].areaName\n\nresult.floors = []\nlet floor = {}\nfloor.floorCode = iot_gateways[0].floorCode\nfloor.floorName = iot_gateways[0].floorName\nfloor.areas = []\n\nlet floor_areas = await global.get(\"mysql_query\")(\"select * from floor_area where deleteFlag = 1 and spaceCode = ? and areaCode = ? and floorCode = ?\", [iot_gateways[0].spaceCode, iot_gateways[0].areaCode, iot_gateways[0].floorCode])\nfor(let i = 0; i < floor_areas.length; i++){\n    floor.areas.push({\n        areaCode:floor_areas[i].code,\n        areaName: floor_areas[i].name,\n        areaType: \"area\",\n    })\n}\n\nlet floor_pub_areas = await global.get(\"mysql_query\")(\"select * from floor_pub_area where deleteFlag = 1 and spaceCode = ? and areaCode = ? and floorCode = ?\", [iot_gateways[0].spaceCode, iot_gateways[0].areaCode, iot_gateways[0].floorCode])\nfor(let i = 0; i < floor_pub_areas.length; i++){\n    floor.areas.push({\n        areaCode:floor_pub_areas[i].code,\n        areaName: floor_pub_areas[i].name,\n        areaType: \"pubArea\",\n    })\n}\n\nlet floor_rooms = await global.get(\"mysql_query\")(\"select * from floor_room where deleteFlag = 1 and spaceCode = ? and areaCode = ? and floorCode = ?\", [iot_gateways[0].spaceCode, iot_gateways[0].areaCode, iot_gateways[0].floorCode])\nfor (let i = 0; i < floor_rooms.length; i++) {\n    floor.areas.push({\n        areaCode: floor_rooms[i].code,\n        areaName: floor_rooms[i].name,\n        areaType: \"room\",\n    })\n}\n\nlet floor_mrooms = await global.get(\"mysql_query\")(\"select * from floor_mroom where deleteFlag = 1 and spaceCode = ? and areaCode = ? and floorCode = ?\", [iot_gateways[0].spaceCode, iot_gateways[0].areaCode, iot_gateways[0].floorCode])\nfor (let i = 0; i < floor_mrooms.length; i++) {\n    floor.areas.push({\n        areaCode: floor_mrooms[i].code,\n        areaName: floor_mrooms[i].name,\n        areaType: \"meetingroom\",\n    })\n}\n\nlet floor_toilets = await global.get(\"mysql_query\")(\"select * from floor_toilet where deleteFlag = 1 and spaceCode = ? and areaCode = ? and floorCode = ?\", [iot_gateways[0].spaceCode, iot_gateways[0].areaCode, iot_gateways[0].floorCode])\nfor (let i = 0; i < floor_toilets.length; i++) {\n    floor.areas.push({\n        areaCode: floor_toilets[i].code,\n        areaName: floor_toilets[i].name,\n        areaType: \"toilet\",\n    })\n}\nresult.floors.push(floor)\n\n\nresult.devices = []\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1 and gatewayID = ? and layer = ?\", [iot_gateways[0].id, layer])\nfor (let i = 0; i < iot_devices.length; i++) {\n    let iot_device_actions = await global.get(\"mysql_query\")(\"select name,type from iot_device_action where gatewayID = ? and deviceID = ?\", [iot_gateways[0].id, iot_devices[i].id])\n    \n    //配置模式\n    let typesObj = {\n        airconditioning:[{\n            name:\"开\",\n            type:\"on\"\n        },{\n            name:\"关\",\n            type:\"off\"\n        },{\n            name:\"调温\",\n            type:\"temperature\"\n        },{\n            name:\"模式\",\n            type:\"mode\"\n        },{\n            name:\"风速\",\n            type:\"fan\"\n        }\n        // ,{\n        //     name:\"报警\",\n        //     type:\"alarm\"\n        // }\n        ],\n        light: [{\n            name: \"开\",\n            type: \"on\"\n        }, {\n            name: \"关\",\n            type: \"off\"\n        }],\n        pad: [{\n            name: \"开\",\n            type: \"status\"\n        }, {\n            name: \"关\",\n            type: \"play\"\n        }, {\n            name: \"关\",\n            type: \"fullscreen\"\n        }, {\n            name: \"关\",\n            type: \"bind\"\n        }, {\n            name: \"关\",\n            type: \"refresh\"\n        }],\n        airsensor:[{\n            name: \"\",\n            type: \"pm25\"\n        },{\n            name: \"\",\n            type: \"pm10\"\n        },{\n            name: \"\",\n            type: \"tvoc\"\n        },{\n            name: \"\",\n            type: \"co2\"\n        },{\n            name: \"\",\n            type: \"formaldehyde\"\n        },{\n            name: \"\",\n            type: \"temperature\"\n        },{\n            name: \"\",\n            type: \"humidity\"\n        },{\n            name: \"\",\n            type: \"light\"\n        }]\n    }\n    let modesObj = {\n        airconditioning: {\n            protocol:\"TCP\",\n            channel:\"RJ45\"\n        },\n        light: {\n            protocol: \"modbus\",\n            channel: \"RS485\"\n        },\n        pad: {\n            protocol:\"TCP\",\n            channel:\"RJ45\"\n        },\n        airsensor: {\n            protocol: \"modbus\",\n            channel: \"RS485\"\n        },\n    }\n    if (!iot_device_actions || iot_device_actions.length == 0){\n        iot_device_actions = []\n        if (typesObj[iot_devices[i].type]){\n            for (let pp = 0; pp < typesObj[iot_devices[i].type].length; pp++){\n                iot_device_actions.push({\n                    gatewayID: iot_gateways[0].id,\n                    deviceID: iot_devices[i].id,\n                    name: typesObj[iot_devices[i].type][pp].name,\n                    type: typesObj[iot_devices[i].type][pp].type\n                })\n            }\n        }\n    }\n    if (!iot_devices[i].protocol && modesObj[iot_devices[i].type]){\n        iot_devices[i].protocol = modesObj[iot_devices[i].type].protocol\n        iot_devices[i].channel = modesObj[iot_devices[i].type].channel\n    }\n    result.devices.push({\n        code: iot_devices[i].code,\n        name: iot_devices[i].name,\n        type: iot_devices[i].type,\n        iottype: iot_devices[i].iotType,\n        protocol: iot_devices[i].protocol,\n        channel: iot_devices[i].channel,\n        area: iot_devices[i].floorAreaType + \"_\" + iot_devices[i].floorAreaCode+ \"_\" + iot_devices[i].floorAreaName,\n        actions: iot_device_actions\n    })\n}\n\nmsg.payload = result\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 140,
        "wires": [
            [
                "80c58197172adc4e"
            ]
        ]
    },
    {
        "id": "9b3b3245156abafd",
        "type": "http in",
        "z": "f788b38babc60666",
        "name": "边缘网关初始化信息入口",
        "url": "/esaydevice/init",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 430,
        "y": 140,
        "wires": [
            [
                "b74a64229ae18a48"
            ]
        ]
    },
    {
        "id": "80c58197172adc4e",
        "type": "http response",
        "z": "f788b38babc60666",
        "name": "",
        "statusCode": "200",
        "headers": {
            "content-type": "application/json"
        },
        "x": 980,
        "y": 140,
        "wires": []
    },
    {
        "id": "7f7372ce6f776bcb",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "空气传感器数据接收",
        "topic": "/iot/status/airsensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 450,
        "y": 380,
        "wires": [
            [
                "86b93bd3d7f11299",
                "cd84f6b3eae539b2",
                "6c4ed9a5ae2f43c9"
            ]
        ]
    },
    {
        "id": "17de74e4d2bbd570",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "设备状态上报（照明、空调）",
        "topic": "/iot/status/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 420,
        "y": 260,
        "wires": [
            [
                "86052a2fda1de89f",
                "197d3e8280ce9351"
            ]
        ]
    },
    {
        "id": "8f0d3940c15fd033",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "边缘网关设备日志上报",
        "topic": "/iot/log/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 440,
        "y": 340,
        "wires": [
            [
                "5c5b6d0b275e9d42"
            ]
        ]
    },
    {
        "id": "6ae33de94a875347",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 68",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 340,
        "wires": []
    },
    {
        "id": "7b46c25d43c8f30d",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/airsensor/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1170,
        "y": 420,
        "wires": []
    },
    {
        "id": "6c4ed9a5ae2f43c9",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "空气数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = devices[i].status\n        if (!status || status.length <= 0 || status.online != 1){\n            continue\n        }\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        if(status.pm25 != undefined){\n            data.pm25 = parseInt(status.pm25)\n        }\n        if(status.pm10 != undefined){\n            data.pm10 = parseInt(status.pm10)\n        }\n        if (status.tvoc != undefined){\n            data.tvoc = parseInt(status.tvoc)\n        }\n        if (status.co2 != undefined){\n            data.co2 = parseInt(status.co2)\n        }\n        if (status.temperature != undefined) {\n            data.temperature = parseFloat(status.temperature)\n        }\n        if (status.humidity != undefined) {\n            data.humidity = parseFloat(status.humidity)\n        }\n        if (status.formaldehyde != undefined) {\n            data.formaldehyde = parseFloat(status.formaldehyde)\n        }\n        if (status.noise != undefined) {\n            data.noise = parseInt(status.noise)\n        }\n        if (status.light != undefined) {\n            data.light = parseInt(status.light)\n        }\n        if (status.so2 != undefined) {\n            data.so2 = parseInt(status.so2)\n        }\n        if (status.nh3 != undefined) {\n            data.nh3 = parseInt(status.nh3)\n        }\n        if (status.o3 != undefined) {\n            data.o3 = parseInt(status.o3)\n        }\n        if (status.o2 != undefined) {\n            data.o2 = parseInt(status.o2)\n        }\n        if (status.h2s != undefined) {\n            data.h2s = parseInt(status.h2s)\n        }\n        if (status.ch4 != undefined) {\n            data.ch4 = parseInt(status.ch4)\n        }\n        if (status.co != undefined) {\n            data.co = parseInt(status.co)\n        }\n        if (status.no2 != undefined) {\n            data.no2 = parseInt(status.no2)\n        }\n        if (status.h2 != undefined) {\n            data.h2 = parseInt(status.h2)\n        }\n        if (status.odor != undefined) {\n            data.odor = parseInt(status.odor)\n        }\n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 420,
        "wires": [
            [
                "7b46c25d43c8f30d"
            ]
        ]
    },
    {
        "id": "cd84f6b3eae539b2",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? and deleteFlag = 1 limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ?, statusUptime = ? where id = ? \", [status, statusUptime, iot_devices[0].id])\n\n        //如果空气数据异常走另外一个分支\n        if(item.status){\n            iot_devices[0].status = item.status\n            iot_devices[0].statusUptime = statusUptime\n            let newMsg = {}\n            newMsg.payload = iot_devices[0]\n            node.send(newMsg)\n        }\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 380,
        "wires": [
            [
                "9feb9b205953e8c1"
            ]
        ]
    },
    {
        "id": "42fb0c47235a27ae",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "状态报警设备处理",
        "func": "let device = msg.payload\nlet spaceId = flow.get(\"spaceId\")\nlet spaceCode = flow.get(\"spaceCode\")\nif (!spaceId) {\n    return\n}\nif (spaceCode != device.spaceCode){\n    return\n}\nif (device && device.status) {\n    let type = \"\" //设备类型报警\n    let typeName = \"\"\n    let deviceID = device.id\n    let deviceName = device.name\n    let deviceAddress = \"\"\n    let deviceFullName = \"/\" + device.spaceCode + \"/\" + device.areaCode + \"/\" + device.floorCode + \"/\" + device.floorAreaCode + \"/\" + device.name\n    let alarmCode = \"\"\n    let alarmMsg = \"\"\n    let baseUnit = \"\"\n    let baseValue = \"\"\n    let realValue = \"\"\n    let createTime = parseInt(new Date().getTime() / 1000)\n    let updateTime = createTime\n    if (device.status.online != 1) {\n        type = \"1\" //设备类型报警\n        typeName = \"设备告警\"\n        deviceAddress = \"online\"\n        alarmCode = \"\"\n        alarmMsg = \"设备离线\"\n    } else if (device.status.alarm == \"alarm\") {\n        type = \"1\" //设备类型报警\n        typeName = \"设备告警\"\n        alarmCode = device.status.alarmValue\n        deviceAddress = \"alarm\"\n        alarmMsg = \"设备异常\"\n        if (device.type == \"airconditioning\"){\n            type = \"2\"\n            typeName = \"空调告警\"\n            if (alarmCode == \"162\") {\n                alarmMsg = \"物业水循环异常\"\n            }else if (alarmCode == \"16\") {\n                alarmMsg = \"室外机组间通讯异常\"\n            }else if (alarmCode == \"3\") {\n                alarmMsg = \"室内外机或室内机间通讯异常\"\n            }\n        }else if (device.type == \"inundationsensor\"){\n            alarmMsg = \"漏水异常，导电率\"+alarmCode+\"，值越大水量越大\"\n        }\n    } else if (device.type == \"airconditioning\"){\n        // if (device.status && device.status.pretemperature == \"30\" && device.status.mode == \"3\" && device.status.fan == \"75\"){\n        //     type = \"2\"\n        //     typeName = \"空调告警\"\n        //     deviceAddress = \"air_force_start\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"空调进入强启模式\"\n        // }\n    } else if (device.type == \"airsensor\"){\n        let alarmConfig = flow.get(\"alarmConfig\")\n        let workdays = [1, 2, 3, 4, 5]\n        let weekdays = [0, 6]\n        let year = moment().format(\"YYYY\")\n        let day = moment().format(\"MM-DD\")\n        let week = moment().day()\n        let time = moment().format(\"HH:mm\")\n        let dayWeek = \"\"\n        let senceDay = flow.get(\"senceDay\")\n        if (senceDay[year] && senceDay[year][\"workday\"] && Array.isArray(senceDay[year][\"workday\"]) && senceDay[year][\"workday\"].includes(day)) {\n            dayWeek = \"workday\"\n        } else if (senceDay[year] && senceDay[year][\"holiday\"] && Array.isArray(senceDay[year][\"holiday\"]) && senceDay[year][\"holiday\"].includes(day)) {\n            dayWeek = \"weekend\"\n        } else if (workdays.includes(week)) {\n            dayWeek = \"workday\"\n        } else if (weekdays.includes(week)) {\n            dayWeek = \"weekend\"\n        }\n        if (!alarmConfig || !alarmConfig[device.spaceCode] || !alarmConfig[device.spaceCode][device.areaCode] || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode]\n            || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode] || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode][dayWeek]) {\n            return\n        }\n        let alarmSet = alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode][dayWeek]\n        if (!(time >= alarmSet.startTime && time <= alarmSet.endTime)) {\n            return\n        }\n\n        let temperature_low = alarmSet.temperature_low ? alarmSet.temperature_low : false\n        let temperature_high = alarmSet.temperature_high ? alarmSet.temperature_high : false\n        let humidity_low = alarmSet.humidity_low ? alarmSet.humidity_low : false\n        let humidity_high = alarmSet.humidity_high ? alarmSet.humidity_high : false\n        let pm25_high = alarmSet.pm25_high ? alarmSet.pm25_high : false\n        let co2_high = alarmSet.co2_high ? alarmSet.co2_high : false\n        let tvoc_high = alarmSet.tvoc_high ? alarmSet.tvoc_high : false\n        let formaldehyde_high = alarmSet.formaldehyde_high ? alarmSet.formaldehyde_high : false\n\n        if (temperature_low && device.status.temperature < temperature_low) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"temperature_low\"\n            alarmCode = \"\"\n            alarmMsg = \"环境温度低于\" + temperature_low + \"℃异常\"\n            baseUnit = \"℃\"\n            baseValue = temperature_low\n            realValue = device.status.temperature\n        }\n        if (temperature_high && device.status.temperature >= temperature_high) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"temperature_high\"\n            alarmCode = \"\"\n            alarmMsg = \"环境温度高于\" + temperature_high + \"℃异常\"\n            baseUnit = \"℃\"\n            baseValue = temperature_high\n            realValue = device.status.temperature\n        }\n        if (co2_high && device.status.co2 > co2_high) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"co2_high\"\n            alarmCode = \"\"\n            alarmMsg = \"环境CO2高于\" + co2_high + \"ppm异常\"\n            baseUnit = \"ppm\"\n            baseValue = co2_high\n            realValue = device.status.co2\n        }\n    }\n\n    if(!spaceId || !deviceID || !deviceAddress){\n        return\n    }\n\n    //记录告警日志\n    let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n    await global.get(\"mysql_query\")(\"insert into system_alarm (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n    //推送日志信息到TD\n    let data = {}\n    data.ts = new Date().getTime()\n    data.position = deviceFullName\n    data.space = device.spaceCode\n    data.floor_area = device.areaCode\n    data.floor = device.floorCode\n    data.area = device.floorAreaCode\n    data.device_code = device.code\n    data.device_id = device.id\n    data.type = type\n    data.type_name = typeName\n    data.device_address = deviceAddress\n    data.alarm_code = alarmCode\n    data.alarm_msg = alarmMsg\n    data.base_unit = baseUnit\n    data.base_value = baseValue\n    data.real_value = realValue\n    let newMsg = {}\n    newMsg.payload = data\n    node.send(newMsg)\n\n    //记录告警数据源\n    let system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and deviceID = ? and `status` = 0 and deviceAddress = ? limit 1\", [spaceId, device.id, deviceAddress])\n    if (system_alarm_sources[0] == undefined) {\n        let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime]\n        await global.get(\"mysql_query\")(\"insert into system_alarm_source (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n    } else {\n        await global.get(\"mysql_query\")(\"update system_alarm_source set updateTime = ? where id = ? limit 1\", [updateTime, system_alarm_sources[0].id])\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 890,
        "y": 240,
        "wires": [
            [
                "9caede29894e89de"
            ]
        ]
    },
    {
        "id": "59c799c491eb1b4c",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "初始化信息",
        "func": "return msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "flow.set(\"spaceCode\", \"GQ\")\n\nlet spaceMqttInfo = {\n    \"HGH-WC\":'{\"url\":\"ws://10.205.66.8:1884\",\"username\":\"zeekr_iot_platform\",\"password\":\"jp2cJFJ1AEeOFUPYcWLF\"}',\n    \"SH-IJ\":'{\"url\":\"ws://10.138.43.109:1884\",\"username\":\"zeekr\",\"password\":\"zeekr\"}'\n}\nglobal.set(\"spaceMqttInfo\", spaceMqttInfo)\n\n\nlet jsJson = function (str) {\n    try {\n        return JSON.parse(str)\n    } catch (error) {\n        return {}\n    }\n}\nflow.set(\"jsJson\", jsJson)\n\n\nconst pool = new pg.Pool({\n    user: 'buildingos',\n    host: 'postgres',\n    database: 'buildingos',\n    password: 'buildingos_prod_2024',\n    port: 5432,\n    max:3000\n});\n\n\n\n// 接收一个sql语句 以及所需的values\n// 这里接收第二参数values的原因是可以使用mysql的占位符 '?'\n// 比如 query(`select * from my_database where id = ?`, [1])\n\nlet mysql_format_to_tsh_sql = function(sql, index){\n    if (!index){\n        index = 1\n    }\n    if(sql.indexOf(\"?\") == -1){\n        return sql\n    }else{\n        sql = sql.replace(\"?\", \"$\"+index)\n        //node.error(sql)\n        ++index\n        return mysql_format_to_tsh_sql(sql, index)\n    }\n}\n\nlet mysql_format_to_tsh_sql_letter_lower_up_fix = function(sql){\n    //node.error(sql)\n    let newSql = \"\"\n    if (sql.indexOf(\"insert into\") != -1){\n        let ls = sql.indexOf(\"(\")\n        let rs = sql.indexOf(\")\")\n        let sql_pre = sql.substring(0, ls+1)\n        let sql_last = sql.substring(rs)\n        let sql_mid = sql.substring(ls+1, rs)\n        let midArr = sql_mid.split(\",\")\n        let sql_mid_new = \"\"\n        for (let i = 0; i < midArr.length; i++) {\n            let l = midArr[i].trim()\n            if(i == midArr.length - 1){\n                sql_mid_new += '\\\"' + l + '\\\"'\n            }else{\n                sql_mid_new += '\\\"' + l + '\\\",'\n            }\n            \n        }\n        newSql = sql_pre+sql_mid_new+sql_last\n    }else{\n        let sqlArr = sql.split(\" \")\n        let s = [\"=\", \">\", \"<\", \">=\", \"<=\", \"!=\"]\n        for (let i = 0; i < sqlArr.length; i++) {\n            let l = sqlArr[i]\n            if (s.includes(l) && sqlArr[i - 1]) {\n                sqlArr[i - 1] = '\\\"' + sqlArr[i - 1] + '\\\"'\n            }\n        }\n\n        for (let i = 0; i < sqlArr.length; i++) {\n            newSql += sqlArr[i] + \" \"\n        }\n    }\n    //node.error(newSql)\n    return newSql\n}\n\nlet mysql_query = async function (sql, values) {\n    // 返回一个 Promise\n    return new Promise((resolve, reject) => {\n        pool.connect().then(connection => {\n            sql = mysql_format_to_tsh_sql_letter_lower_up_fix(mysql_format_to_tsh_sql(sql))\n            if (!Array.isArray(values)){\n                values = [values]\n            }\n            connection.query(sql, values, (err, res) => {\n                // 结束会话\n                connection.release()\n                if (err) {\n                    reject(err)\n                } else {\n                    resolve(res.rows)\n                }\n            })\n        }).catch(err => reject(err))\n    })\n}\nglobal.set(\"mysql_query\", mysql_query)\n\nlet sleep = function (ms) {\n    return new Promise(resolve => setTimeout(resolve, ms))\n}\nglobal.set(\"sleep\", sleep)\n\nlet jsBigJson = function (str) {\n    try {\n        return jsonBigint.parse(str)\n    } catch (e) {\n        return {}\n    }\n}\nglobal.set(\"jsBigJson\", jsBigJson)\n\n\nlet randomString = function (length) {\n    let chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'\n    var result = '';\n    for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];\n    return result;\n}\nflow.set(\"randomString\", randomString)\n\nlet uuid = function () {\n    return md5(randomString(32));\n}\nflow.set(\"uuid\", uuid)\n",
        "finalize": "",
        "libs": [
            {
                "var": "crypto",
                "module": "crypto"
            },
            {
                "var": "moment",
                "module": "moment"
            },
            {
                "var": "jsonBigint",
                "module": "json-bigint"
            },
            {
                "var": "md5",
                "module": "md5"
            },
            {
                "var": "pg",
                "module": "pg"
            }
        ],
        "x": 210,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "9feb9b205953e8c1",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "状态报警设备处理",
        "func": "let device = msg.payload\nlet spaceId = flow.get(\"spaceId\")\nif (!spaceId || device.floorAreaCode == \"JF\") {\n    return\n}\nlet spaceCode = flow.get(\"spaceCode\")\nif (spaceCode != device.spaceCode) {\n    return\n}\nlet alarmConfig = flow.get(\"alarmConfig\")\nlet workdays = [1,2,3,4,5]\nlet weekdays = [0,6]\nlet year = moment().format(\"YYYY\")\nlet day = moment().format(\"MM-DD\")\nlet week = moment().day()\nlet time = moment().format(\"HH:mm\")\nlet dayWeek = \"\"\nlet senceDay = flow.get(\"senceDay\")\nif (senceDay && senceDay[year] && senceDay[year][\"workday\"] && Array.isArray(senceDay[year][\"workday\"]) && senceDay[year][\"workday\"].includes(day)) {\n    dayWeek = \"workday\"\n} else if (senceDay && senceDay[year] && senceDay[year][\"holiday\"] && Array.isArray(senceDay[year][\"holiday\"]) && senceDay[year][\"holiday\"].includes(day)) {\n    dayWeek = \"weekend\"\n} else if (workdays.includes(week)){\n    dayWeek = \"workday\"\n} else if (weekdays.includes(week)){\n    dayWeek = \"weekend\"\n}\n// if (!alarmConfig || !alarmConfig[device.spaceCode] || !alarmConfig[device.spaceCode][device.areaCode] || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode]\n//     || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode] || !alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode][dayWeek]){\n//     return\n// }\n// let alarmSet = alarmConfig[device.spaceCode][device.areaCode][device.floorCode][device.floorAreaCode][dayWeek]\n// if (!(time >= alarmSet.startTime && time <= alarmSet.endTime)){\n//     return\n// }\n\n//阈值参数设置 \nlet temperature_low = 23\nlet temperature_high = 27\nlet humidity_low = 30\nlet humidity_high = 60\nlet pm25_high = 75\nlet co2_high = 1000\nlet tvoc_high = 0.6\nlet formaldehyde_high = 0.08\n\n// let temperature_low = alarmSet.temperature_low ? alarmSet.temperature_low : false\n// let temperature_high = alarmSet.temperature_high ? alarmSet.temperature_high : false\n// let humidity_low = alarmSet.humidity_low ? alarmSet.humidity_low : false\n// let humidity_high = alarmSet.humidity_high ? alarmSet.humidity_high : false\n// let pm25_high = alarmSet.pm25_high ? alarmSet.pm25_high : false\n// let co2_high = alarmSet.co2_high ? alarmSet.co2_high : false\n// let tvoc_high = alarmSet.tvoc_high ? alarmSet.tvoc_high : false\n// let formaldehyde_high = alarmSet.formaldehyde_high ? alarmSet.formaldehyde_high : false\n\n\nif (device.status) {\n    let type = \"\" //设备类型报警\n    let typeName = \"\"\n    let deviceID = device.id\n    let deviceName = device.name\n    let deviceAddress = \"\"\n    let deviceFullName = \"/\" + device.spaceCode + \"/\" + device.areaCode + \"/\" + device.floorCode + \"/\" + device.floorAreaCode + \"/\" + device.name\n    let alarmCode = \"\"\n    let alarmMsg = \"\"\n    let baseUnit = \"\"\n    let baseValue = \"\"\n    let realValue = \"\"\n    let createTime = parseInt(new Date().getTime() / 1000)\n    let updateTime = createTime\n    if (device.status.online != 1) {\n        type = \"1\" //设备类型报警\n        typeName = \"设备告警\"\n        deviceAddress = \"online\"\n        alarmMsg = \"设备离线\"\n    } else {\n        if (temperature_low && device.status.temperature < temperature_low) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"temperature_low\"\n            alarmCode = \"\"\n            alarmMsg = \"环境温度低于\" + temperature_low +\"℃异常\"\n            baseUnit = \"℃\"\n            baseValue = temperature_low\n            realValue = device.status.temperature\n        }\n        if (temperature_high && device.status.temperature >= temperature_high) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"temperature_high\"\n            alarmCode = \"\"\n            alarmMsg = \"环境温度高于\" + temperature_high +\"℃异常\"\n            baseUnit = \"℃\"\n            baseValue = temperature_high\n            realValue = device.status.temperature\n        }\n        // if (device.status.humidity < humidity_low) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"humidity_low\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境湿度低于\" + humidity_low +\"%异常\"\n        //     baseUnit = \"%\"\n        //     baseValue = humidity_low\n        //     realValue = device.status.humidity\n        // }\n        // if (device.status.humidity > humidity_high) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"humidity_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境湿度高于\" + humidity_high +\"%异常\"\n        //     baseUnit = \"%\"\n        //     baseValue = humidity_high\n        //     realValue = device.status.humidity\n        // }\n        // if (device.status.pm25 > pm25_high) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"pm25_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境PM2.5高于\" + pm25_high +\"μg/m3异常\"\n        //     baseUnit = \"μg/m3\"\n        //     baseValue = pm25_high\n        //     realValue = device.status.pm25\n        // }\n        // if (device.status.pm10 / 1000 > 0.5) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"pm10_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境PM1.0高于0.5mg/m3异常\"\n        //     baseUnit = \"mg/m3\"\n        //     baseValue = \"0.5\"\n        //     realValue = device.status.pm10 / 1000\n        // }\n        if (co2_high && device.status.co2 > co2_high) {\n            type = \"3\" //设备类型报警\n            typeName = \"环境告警\"\n            deviceAddress = \"co2_high\"\n            alarmCode = \"\"\n            alarmMsg = \"环境CO2高于\" + co2_high +\"ppm异常\"\n            baseUnit = \"ppm\"\n            baseValue = co2_high\n            realValue = device.status.co2\n        }\n        // let now_formaldehyde = parseFloat(parseFloat(device.status.formaldehyde * 1.23).toFixed(2))\n        // if (now_formaldehyde > formaldehyde_high) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"formaldehyde_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境甲醛高于\" + formaldehyde_high +\"mg/m3异常\"\n        //     baseUnit = \"mg/m3\"\n        //     baseValue = formaldehyde_high\n        //     realValue = now_formaldehyde\n        // }\n        // let now_tvoc = parseFloat(parseFloat(device.status.tvoc * 0.0023).toFixed(1))\n        // if (now_tvoc > tvoc_high) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"tvoc_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境TVOC高于\" + tvoc_high +\"mg/m3异常\"\n        //     baseUnit = \"mg/m3\"\n        //     baseValue = tvoc_high\n        //     realValue = now_tvoc\n        // }\n        // if (device.status.so2 / 22.4 > 0.3) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"so2_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境SO2高于0.3mg/m3异常\"\n        //     baseUnit = \"mg/m3\"\n        //     baseValue = \"0.3\"\n        //     realValue = device.status.so2 / 22.4\n        // }\n        // if (device.status.nh3 / 22.4 > 10) {\n        //     type = \"3\" //设备类型报警\n        //     typeName = \"环境告警\"\n        //     deviceAddress = \"nh3_high\"\n        //     alarmCode = \"\"\n        //     alarmMsg = \"环境氨气高于10mg/m3异常\"\n        //     baseUnit = \"mg/m3\"\n        //     baseValue = \"10\"\n        //     realValue = device.status.nh3 / 22.4\n        // }\n    }\n    \n    if(!spaceId || !deviceID || !deviceAddress){\n        return\n    }\n\n    //记录告警日志\n    let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n    await global.get(\"mysql_query\")(\"insert into system_alarm (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n    //推送日志信息到TD\n    let data = {}\n    data.ts = new Date().getTime()\n    data.position = deviceFullName\n    data.space = device.spaceCode\n    data.floor_area = device.areaCode\n    data.floor = device.floorCode\n    data.area = device.floorAreaCode\n    data.device_code = device.code\n    data.device_id = device.id\n    data.type = type\n    data.type_name = typeName\n    data.device_address = deviceAddress\n    data.alarm_code = alarmCode\n    data.alarm_msg = alarmMsg\n    data.base_unit = baseUnit\n    data.base_value = baseValue\n    data.real_value = realValue\n    let newMsg = {}\n    newMsg.payload = data\n    node.send(newMsg)\n\n    //记录告警数据源\n    let system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and deviceID = ? and status = '0' and deviceAddress = ? limit 1\", [spaceId, device.id, deviceAddress])\n    if (system_alarm_sources[0] == undefined) {\n        let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime]\n        await global.get(\"mysql_query\")(\"insert into system_alarm_source (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n    } else {\n        await global.get(\"mysql_query\")(\"update system_alarm_source set updateTime = ? where id = ? \", [createTime, system_alarm_sources[0].id])\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 890,
        "y": 380,
        "wires": [
            [
                "51848907d487fd4d",
                "d8c6c1945d9c988c"
            ]
        ]
    },
    {
        "id": "7118e962c3650af9",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "电量传感器数据接收",
        "topic": "/iot/status/powersensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 450,
        "y": 700,
        "wires": [
            [
                "c139982d48cc7913",
                "bad970d3d6cc4876"
            ]
        ]
    },
    {
        "id": "88192edb34ae5fea",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 158",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 660,
        "wires": []
    },
    {
        "id": "c139982d48cc7913",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        // await global.get(\"mysql_query\")(\"update iot_device set status = ? ,statusUptime = ? where id = ? limit 1\", [status, statusUptime, iot_devices[0].id])\n        await global.get(\"mysql_query\")(\n            \"update iot_device set status = $1, statusUptime = $2 where id = $3\",\n            [status, statusUptime, iot_devices[0].id]\n        )\n        //统计总用电量\n        if(item.status && item.status.totalPower && item.status.totalKwh){\n            let deviceId = iot_devices[0].id\n            let kwh = item.status.totalKwh\n            let pushDate = moment().format(\"YYYY-MM-DD\")\n            let pushTime = moment().unix()\n            let values = [deviceId, kwh, pushDate, pushTime]\n            await global.get(\"mysql_query\")('insert into iot_power(deviceId, kwh, pushDate, pushTime) values (?,?,?,?)', values)\n\n            let iot_power_days = await global.get(\"mysql_query\")(\"select * from iot_power_day where deviceId = ? and pushDate = ? limit 1\", [deviceId, pushDate])\n            if (iot_power_days[0] == undefined) {\n                let todayKwh = 0\n                let todayPower = item.status.totalPower\n                let totalKwh = kwh\n                let values2 = [deviceId, todayKwh, todayPower, totalKwh, pushDate, pushTime]\n                await global.get(\"mysql_query\")('insert into iot_power_day(deviceId, todayKwh, todayPower, totalKwh, pushDate, pushTime) values (?,?,?,?,?,?)', values2)\n            }else{\n                let todayPower = item.status.totalPower\n                let totalKwh = kwh\n                let todayKwh = parseFloat(parseFloat(iot_power_days[0].todayKwh) + (totalKwh - parseFloat(iot_power_days[0].totalKwh))).toFixed(2)\n                let values2 = [todayPower, totalKwh, todayKwh, pushTime, iot_power_days[0].id]\n                await global.get(\"mysql_query\")('update iot_power_day set todayPower = ?, totalKwh = ?, todayKwh = ?, pushTime = ? where id = ?', values2)\n            }\n        }\n\n        //统计电箱每个回路按照分类的用电量\n        if (item.status && item.status.kwh && item.status.power && item.status.current) {\n            let kwh = item.status.kwh\n            let power = item.status.power\n            let current = item.status.current\n            let iot_power_loop_type_obj = flow.get(\"iot_power_loop_type_obj\")\n            let iot_power_loop_code_obj = flow.get(\"iot_power_loop_code_obj\")\n            let iot_power_loop_name_obj = flow.get(\"iot_power_loop_name_obj\")\n\n            for (let i = 1; i <= 27; i++) {\n                let loop = \"loop\" + i\n                if (kwh[loop] == undefined){\n                    continue\n                }\n                if(!iot_power_loop_type_obj[iot_devices[0].id] || !iot_power_loop_type_obj[iot_devices[0].id][loop]){\n                    continue\n                }\n                let loop_code = \"\"\n                let loop_name = \"\"\n                if (iot_power_loop_code_obj[iot_devices[0].id] && iot_power_loop_code_obj[iot_devices[0].id][loop]) {\n                    loop_code = iot_power_loop_code_obj[iot_devices[0].id][loop]\n                }\n                if (iot_power_loop_name_obj[iot_devices[0].id] && iot_power_loop_name_obj[iot_devices[0].id][loop]) {\n                    loop_name = iot_power_loop_name_obj[iot_devices[0].id][loop]\n                }\n\n                let data = {}\n                data.ts = new Date().getTime()\n                data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode + \"/\" + iot_devices[0].name\n                data.space = iot_devices[0].spaceCode\n                data.floor_area = iot_devices[0].areaCode\n                data.floor = iot_devices[0].floorCode\n                data.area = iot_devices[0].floorAreaCode\n                data.device_code = iot_devices[0].code\n                data.device_id = iot_devices[0].id\n                data.power = parseFloat(parseFloat(power[loop]).toFixed(2))\n                data.kwh = parseFloat(parseFloat(kwh[loop]).toFixed(2))\n                data.current = parseFloat(parseFloat(current[loop]).toFixed(2))\n                data.type = iot_power_loop_type_obj[iot_devices[0].id][loop]\n                data.loop = loop\n                data.loop_code = loop_code\n                data.loop_name = loop_name\n                let newMsg = {}\n                newMsg.payload = data\n                node.send(newMsg)\n                await global.get(\"sleep\")(300)\n            }\n        }\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 690,
        "y": 700,
        "wires": [
            [
                "88192edb34ae5fea",
                "61b8ecbd34a7641b"
            ]
        ]
    },
    {
        "id": "12616d8d7b9014c8",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "卫生间传感器数据接收",
        "topic": "/iot/status/wcsensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 440,
        "y": 840,
        "wires": [
            [
                "a364625e93b469bb",
                "71642243bb1deeed"
            ]
        ]
    },
    {
        "id": "1c36a41f3c6bb4e1",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 162",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 840,
        "wires": []
    },
    {
        "id": "a364625e93b469bb",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer || !item.status){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if (iot_devices[0] == undefined || !iot_devices[0]){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ?, statusUptime = ? where id = ?\", [status, statusUptime, iot_devices[0].id])\n\n        //卫生间使用次数计数\n        let oldStatus = flow.get(\"jsJson\")(iot_devices[0].status)\n        if(oldStatus.status == 0 && item.status.status == 1){\n            let floor_toilet_rooms = await global.get(\"mysql_query\")(\"select * from floor_toilet_room where sensorIndex = ? limit 1\", iot_devices[0].code)\n            if (floor_toilet_rooms[0]){\n                let spaceId = flow.get(\"spaceId\")\n                let toiletId = floor_toilet_rooms[0].toiletId\n                let toiletRoomId = floor_toilet_rooms[0].id\n                let sensorCode = floor_toilet_rooms[0].sensorIndex\n                let useCount = 1\n                let countDate = moment().format(\"YYYY-MM-DD\")\n                let updateTime = parseInt(new Date().getTime() / 1000)\n\n                let iot_toilet_room_uses = await global.get(\"mysql_query\")(\"select * from iot_toilet_room_use where spaceId = ? and toiletId = ? and toiletRoomId = ? and countDate = ? limit 1\", [spaceId, toiletId, toiletRoomId, countDate])\n                if (iot_toilet_room_uses[0] == undefined){\n                    let values = [spaceId, toiletId, toiletRoomId, sensorCode, useCount, countDate, updateTime]\n                    await global.get(\"mysql_query\")(\"insert into iot_toilet_room_use (spaceId, toiletId, toiletRoomId, sensorCode, useCount, countDate, updateTime) values (?,?,?,?,?,?,?)\", values)\n                }else{\n                    useCount = ++iot_toilet_room_uses[0].useCount\n                    await global.get(\"mysql_query\")(\"update iot_toilet_room_use set useCount = ?, updateTime = ? where id = ?\", [useCount, updateTime, iot_toilet_room_uses[0].id])\n                }\n            }\n        }\n    }\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 690,
        "y": 840,
        "wires": [
            [
                "1c36a41f3c6bb4e1"
            ]
        ]
    },
    {
        "id": "eca2184cfad2b479",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "人体传感器数据接收",
        "topic": "/iot/status/humensensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 450,
        "y": 960,
        "wires": [
            [
                "42d8c961da7c7a68",
                "2685630bd3642e07"
            ]
        ]
    },
    {
        "id": "67db7b78973ce68b",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 164",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 960,
        "wires": []
    },
    {
        "id": "42d8c961da7c7a68",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ?, statusUptime = ? where id = ?\", [status, statusUptime, iot_devices[0].id])\n    }\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 710,
        "y": 960,
        "wires": [
            [
                "67db7b78973ce68b"
            ]
        ]
    },
    {
        "id": "cc86737dd4c2abe8",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "卫生间使用情况",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet floor_toilets = await global.get(\"mysql_query\")(\"select * from floor_toilet where spaceCode = ?\", [spaceCode])\nif (floor_toilets[0] == undefined){\n    return null\n}\nlet today = moment().format(\"YYYY-MM-DD\")\nfor (let i = 0; i < floor_toilets.length; i++){\n    let iot_toilet_room_uses = await global.get(\"mysql_query\")(\"select sum(\\\"useCount\\\") as \\\"useCount\\\" from iot_toilet_room_use where toiletId = ? and countDate = ?\", [floor_toilets[i].id, today])\n    if (iot_toilet_room_uses[0] == undefined || !iot_toilet_room_uses[0].useCount){\n        continue\n    }\n    let data = {}\n    data.useCount = iot_toilet_room_uses[0].useCount\n    let newMsg = {}\n    newMsg.topic = \"/iot/status/wcinfo/\"+floor_toilets[i].spaceCode+\"/\"+floor_toilets[i].areaCode+\"/\"+floor_toilets[i].floorCode+\"/\"+floor_toilets[i].code\n    newMsg.payload = data\n    node.send(newMsg)\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 700,
        "y": 920,
        "wires": [
            [
                "cbdc8b976aa36212"
            ]
        ]
    },
    {
        "id": "591c8c9ddd62ae1c",
        "type": "inject",
        "z": "f788b38babc60666",
        "d": true,
        "name": "定时推送卫生间使用数据",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "360",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 430,
        "y": 920,
        "wires": [
            [
                "cc86737dd4c2abe8"
            ]
        ]
    },
    {
        "id": "cbdc8b976aa36212",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1070,
        "y": 920,
        "wires": []
    },
    {
        "id": "5f7923cd761f1048",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "电量使用情况",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet today = moment().format(\"YYYY-MM-DD\")\nlet iot_power_days = await global.get(\"mysql_query\")(\"select * from iot_power_day where pushDate = ?\", [today])\nif (iot_power_days[0] == undefined) {\n    return null\n}\nlet iot_power_days_obj = {}\nfor (let i = 0; i < iot_power_days.length; i++){\n    iot_power_days_obj[iot_power_days[i].deviceId] = iot_power_days[i]\n}\n\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where spaceCode = ? and type = 'powersensor' and deleteFlag = 1\", [spaceCode])\nif (iot_devices[0] == undefined){\n    return null\n}\nlet result = {}\nfor (let i = 0; i < iot_devices.length; i++){\n    let key = iot_devices[i].spaceCode + \"_\" + iot_devices[i].areaCode + \"_\" + iot_devices[i].floorCode\n    if (result[key] == undefined){\n        result[key] = {}\n    }\n    result[key].spaceCode = iot_devices[i].spaceCode\n    result[key].areaCode = iot_devices[i].areaCode\n    result[key].floorCode = iot_devices[i].floorCode\n    result[key].todayKwh = 0\n    result[key].todayPower = 0\n    if (iot_power_days_obj[iot_devices[i].id]){\n        result[key].todayKwh += parseFloat(iot_power_days_obj[iot_devices[i].id].todayKwh)\n        result[key].todayPower += parseFloat(iot_power_days_obj[iot_devices[i].id].todayPower)\n    }\n}\n\nObject.keys(result).forEach(function(k) {\n    let data = {}\n    data.todayKwh = result[k].todayKwh\n    data.todayPower = result[k].todayPower\n    let newMsg = {}\n    newMsg.topic = \"/iot/status/power/\" + result[k].spaceCode + \"/\" + result[k].areaCode + \"/\" + result[k].floorCode\n    newMsg.payload = data\n    node.send(newMsg)\n});",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 700,
        "y": 800,
        "wires": [
            [
                "d33293757f258506"
            ]
        ]
    },
    {
        "id": "b2409028472a11b6",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时推送电量数据",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "30",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 450,
        "y": 800,
        "wires": [
            [
                "5f7923cd761f1048"
            ]
        ]
    },
    {
        "id": "d33293757f258506",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1070,
        "y": 800,
        "wires": []
    },
    {
        "id": "8d63f5a37e891876",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/humensensor/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1160,
        "y": 1000,
        "wires": []
    },
    {
        "id": "2685630bd3642e07",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "人体数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = devices[i].status\n        if(!status || status.length <= 0){\n            continue\n        }\n        //不在线或状态不对的不记录\n        if (status.online != \"1\" || (status.status != \"busy\" && status.status != \"free\")){\n            continue\n        }\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        if(status.status == \"busy\"){\n            data.status = 1\n        }else if(status.status == \"free\"){\n            data.status = 0\n        }\n        \n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 1000,
        "wires": [
            [
                "8d63f5a37e891876"
            ]
        ]
    },
    {
        "id": "540fb7617cdc707f",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取属地所有区域",
        "func": "let result = []\nlet spaces = await global.get(\"mysql_query\")(\"select * from space where deleteFlag = 1\")\nfor (let i = 0; i < spaces.length; i++){\n    let space = {}\n    space.name = spaces[i].name\n    space.code = spaces[i].code\n    space.floorArea = []\n    let areas = await global.get(\"mysql_query\")(\"select * from area where spaceCode = ? and deleteFlag = 1 order by code ASC\", spaces[i].code)\n    for(let j = 0; j < areas.length; j++){\n        let area = {}\n        area.name = areas[j].name\n        area.code = areas[j].code\n        area.floor = []\n        let floors = await global.get(\"mysql_query\")(\"select * from floor where spaceCode = ? and areaCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code])\n        for (let k = 0; k < floors.length; k++){\n            let floor = {}\n            floor.name = floors[k].name\n            floor.code = floors[k].code\n            floor.area = await global.get(\"mysql_query\")(\"select * from floor_area where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.mettingRoom = await global.get(\"mysql_query\")(\"select * from floor_mroom where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.toilet = await global.get(\"mysql_query\")(\"select * from floor_toilet where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.room = await global.get(\"mysql_query\")(\"select * from floor_room where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            area.floor.push(floor)\n        }\n        space.floorArea.push(area)\n    }\n    result.push(space)\n}\nmsg.payload = result\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 1340,
        "wires": [
            [
                "67d57e149a1b91bc"
            ]
        ]
    },
    {
        "id": "4ab7c5baaad283d3",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "空间结构初始化数据入口",
        "topic": "/iot/setting/get/structure",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 450,
        "y": 1340,
        "wires": [
            [
                "540fb7617cdc707f"
            ]
        ]
    },
    {
        "id": "67d57e149a1b91bc",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "空间结构初始化数据出口",
        "topic": "/iot/setting/structure/result",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1070,
        "y": 1340,
        "wires": []
    },
    {
        "id": "4d08e514882a4927",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取区域所有设备",
        "func": "let spaceCode = msg.payload.spaceCode\nlet areaCode = msg.payload.floorAreaCode\nlet floorCode = msg.payload.floorCode\nlet floorAreaCode = msg.payload.areaCode\nlet iot_gateways = await global.get(\"mysql_query\")(\"select id,macaddr from iot_gateway where deleteFlag = 1 \")\nlet iot_gateways_obj = {}\nfor(let i = 0; i < iot_gateways.length; i++){\n    iot_gateways_obj[iot_gateways[i].id] = iot_gateways[i]\n}\n\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1 and spaceCode =? and areaCode =? and floorCode = ? and floorAreaCode = ?\", [spaceCode, areaCode, floorCode, floorAreaCode])\nlet result = {}\nfor(let i = 0; i < iot_devices.length; i++){\n    if(result[iot_devices[i].type] == undefined){\n        result[iot_devices[i].type] = []\n    }\n    if (iot_gateways_obj[iot_devices[i].gatewayID]){\n        iot_devices[i].gatewayMac = iot_gateways_obj[iot_devices[i].gatewayID].macaddr\n    }\n    result[iot_devices[i].type].push(iot_devices[i])\n}\nmsg.topic = \"/iot/setting/device/\" + spaceCode + \"/\" + areaCode + \"/\" + floorCode + \"/\" + floorAreaCode\nmsg.payload = result\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 1380,
        "wires": [
            [
                "84ee5e8efc4a1d5b"
            ]
        ]
    },
    {
        "id": "fd714e46365350a7",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "区域所有设备入口",
        "topic": "/iot/setting/get/device",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 430,
        "y": 1380,
        "wires": [
            [
                "4d08e514882a4927"
            ]
        ]
    },
    {
        "id": "84ee5e8efc4a1d5b",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "区域所有设备出口",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1050,
        "y": 1380,
        "wires": []
    },
    {
        "id": "cdac2485e5868c84",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "烟雾传感器数据接收",
        "topic": "/iot/status/smokesensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 450,
        "y": 1040,
        "wires": [
            [
                "fecffd40ea3117ad",
                "7cf34227e3af3b53"
            ]
        ]
    },
    {
        "id": "758540bd1472a98f",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 178",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 1040,
        "wires": []
    },
    {
        "id": "fecffd40ea3117ad",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ?, statusUptime = ? where id = ?\", [status, statusUptime, iot_devices[0].id])\n    }\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 710,
        "y": 1040,
        "wires": [
            [
                "758540bd1472a98f"
            ]
        ]
    },
    {
        "id": "bad970d3d6cc4876",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "电量数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = devices[i].status\n        if(!status || status.length <= 0){\n            continue\n        }\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        if(status.voltage){\n            data.voltage1 = parseFloat(parseFloat(status.voltage.A).toFixed(2))\n            data.voltage2 = parseFloat(parseFloat(status.voltage.B).toFixed(2))\n            data.voltage3 = parseFloat(parseFloat(status.voltage.C).toFixed(2))\n        }\n        if(status.power){\n            for(let i = 1; i <= 27; i++){\n                data[\"power\" + i] = parseFloat(parseFloat(status.power[\"loop\" + i]).toFixed(2))\n            }\n        }\n        if(status.current){\n            for(let i = 1; i <= 27; i++){\n                data[\"current\" + i] = parseFloat(parseFloat(status.current[\"loop\" + i]).toFixed(2))\n            }\n        }\n        if(status.kwh){\n            for(let i = 1; i <= 27; i++){\n                data[\"kwh\" + i] = parseFloat(parseFloat(status.kwh[\"loop\" + i]).toFixed(2))\n            }\n        }\n\n        if(status.totalPower != undefined){\n            data.total_power = parseFloat(parseFloat(status.totalPower).toFixed(2))\n        }\n        if (status.totalKwh != undefined){\n            data.total_kwh = parseFloat(parseFloat(status.totalKwh).toFixed(2))\n        }\n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 730,
        "y": 740,
        "wires": [
            [
                "6a2e54da092c7b59"
            ]
        ]
    },
    {
        "id": "6a2e54da092c7b59",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/powersensor/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1140,
        "y": 740,
        "wires": []
    },
    {
        "id": "7cf34227e3af3b53",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "烟雾数据推送至TD引擎",
        "func": "if (msg.payload && Array.isArray(msg.payload)) {\n    let devices = msg.payload\n    for (let i = 0; i < devices.length; i++) {\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if (gateways[0] == undefined) {\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if (iot_devices[0] == undefined) {\n            continue;\n        }\n        let status = devices[i].status\n        if(!status || status.length <= 0){\n            continue\n        }\n        if(status.smoke == undefined){\n            continue\n        }\n\n        let msgArr = [null, null]\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode + \"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        data.smoke = parseInt(status.smoke)\n        let newMsg = {}\n        newMsg.payload = data\n        msgArr[0] = newMsg\n\n        // let validFloors = [\"23F\", \"24F\", \"25F\", \"26F\", \"27F\", \"28F\", \"29F\", \"30F\", \"31F\", \"32F\"]\n        let invalidAreas = {\n            \"25F\":{\"TMAN\":true,\"TMANVIP\":true},\n            \"27F\":{\"TMAN\":true,\"TMANVIP\":true},\n            \"28F\":{\"TMAN\":true},\n            \"31F\":{\"TMAN\":true,\"TMANVIP\":true},\n            \"41F\":{\"TMAN\":true},\n            \"42F\":{\"TMAN\":true,\"TMANVIP\":true},\n            \"45F\":{\"TMAN\":true},\n            \"46F\":{\"TMAN\":true,\"TWOMAN\":true},\n            \"54F\":{\"TMAN\":true,\"TWOMAN\":true},\n        }\n\n        if (data.smoke === 1){\n\n            if(invalidAreas[iot_devices[0].floorCode] && invalidAreas[iot_devices[0].floorCode][iot_devices[0].floorAreaCode]){\n                continue\n            }\n\n            //记录到告警中心\n            let uuid = flow.get(\"uuid\")()\n            let spaceCode = iot_devices[0].spaceCode\n            let floorAreaCode = iot_devices[0].areaCode\n            let floorCode = iot_devices[0].floorCode\n            let areaCode = iot_devices[0].floorAreaCode\n            let sourceName = iot_devices[0].name\n            let classify = \"security\"\n            let classifyName = \"安防告警\"\n            let emergentType = \"烟雾探测\"\n            let floorCodeNum = parseInt(floorCode)\n            let floorName = floorCode\n            if (floorCodeNum) {\n                floorName = floorCodeNum + \"楼\"\n            }\n            let emergentContent = \"请注意\" + floorName + sourceName + \"产生报警，请立即前往！\"\n            let voiceText = emergentContent  //语音文本规则？\n            let voiceUrl = \"\"\n            if (status.smokingSourceImg) {\n                voiceUrl = status.smokingSourceImg\n            }\n            let happenDate = moment().format(\"YYYY-MM-DD\")\n            let happenTime = moment().format(\"YYYY-MM-DD HH:mm:ss\")\n            let createTime = parseInt(new Date().getTime() / 1000)\n            let values = [uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime]\n\n            let system_emergents = await global.get(\"mysql_query\")(\"select * from system_emergent where spaceCode = ? and floorAreaCode = ? and floorCode = ? and areaCode = ? and sourceName = ? and classify = ? and emergentType = ? and status != 2 and status != 3 limit 1\", [spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, emergentType])\n            if (system_emergents[0] == undefined) {\n                await global.get(\"mysql_query\")('insert into system_emergent (uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n                let pushMsg = {}\n                pushMsg.payload = {\n                    uuid: uuid,\n                    spaceCode: spaceCode,\n                    floorAreaCode: floorAreaCode,\n                    floorCode: floorCode,\n                    areaCode: areaCode,\n                    sourceName: sourceName,\n                    happenTime: happenTime,\n                    message: emergentContent\n                }\n                msgArr[1] = pushMsg\n            }\n        }\n        node.send(msgArr)\n    }\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 750,
        "y": 1080,
        "wires": [
            [
                "89049426b25f8876"
            ],
            [
                "ce10fe258034da28",
                "5e5df18900657385"
            ]
        ]
    },
    {
        "id": "89049426b25f8876",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/smokesensor/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1160,
        "y": 1080,
        "wires": []
    },
    {
        "id": "71642243bb1deeed",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "厕位数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = devices[i].status\n        if (!status || status.status == undefined){\n            continue\n        }\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        data.status = parseInt(status.status)\n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 730,
        "y": 880,
        "wires": [
            [
                "6f5d66ee86ea9f3c"
            ]
        ]
    },
    {
        "id": "6f5d66ee86ea9f3c",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/wcsensor/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1130,
        "y": 880,
        "wires": []
    },
    {
        "id": "f16364d90c55b0d3",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "智能平板状态数据接收",
        "topic": "/iot/status/pad/HGH-WC/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 500,
        "y": 1640,
        "wires": [
            [
                "e539b204d67d1c8f",
                "7615659828c51693"
            ]
        ]
    },
    {
        "id": "521ef6b0c559facc",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "全局参数生成",
        "func": "//当前属地ID\nlet spaceCode = flow.get(\"spaceCode\")\nlet spaces = await global.get(\"mysql_query\")('select * from space where code = ? and deleteFlag = 1 limit 1', [spaceCode])\nif (spaces[0] != undefined) {\n    flow.set(\"spaceId\", spaces[0].id)\n    msg.spaceId = spaces[0].id\n}\n\n//告警信息提醒对应人\n// let spaceId = flow.get(\"spaceId\")\n// let system_alarm_users = await global.get(\"mysql_query\")('select * from system_alarm_user where spaceId = $1', [spaceId])\n// let alarm_type_users = {}\n// for (let i = 0; i < system_alarm_users.length; i++){\n//     if (alarm_type_users[system_alarm_users[i].type] == undefined){\n//         alarm_type_users[system_alarm_users[i].type] = []\n//     }\n//     alarm_type_users[system_alarm_users[i].type].push(system_alarm_users[i])\n// }\n// flow.set(\"alarm_type_users\", alarm_type_users)\n\n\n// //网关信息\n// let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where deleteFlag = 1\")\n// let iotGatewayIdsObj = {}\n// let iotGatewayMacsObj = {}\n// for (let i = 0; i < gateways.length; i++){\n//     iotGatewayMacsObj[gateways[i].macaddr] = gateways[i]\n//     iotGatewayIdsObj[gateways[i].id] = gateways[i]\n// }\n// global.set(\"iotGatewayIdsObj\", iotGatewayIdsObj)\n// global.set(\"iotGatewayMacsObj\", iotGatewayMacsObj)\n// msg.iotGatewayIdsObj = iotGatewayIdsObj\n// msg.iotGatewayMacsObj = iotGatewayMacsObj\n\n\n// let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1\")\n// let iotDevicesObj = {}\n// for (let i = 0; i < iot_devices.length; i++) {\n//     let iot_device = iot_devices[i]\n//     if (!iotGatewayIdsObj[iot_device.gatewayID]){\n//         continue\n//     }\n//     let macaddr = iotGatewayIdsObj[iot_device.gatewayID].macaddr\n//     if (iotDevicesObj[macaddr] == undefined) {\n//         iotDevicesObj[macaddr] = {}\n//     }\n//     iotDevicesObj[macaddr][iot_device.code] = iot_devices[i]\n// }\n// global.set(\"iotDevicesObj\", iotDevicesObj)\n// msg.iotDevicesObj = iotDevicesObj\n\n// msg.alarm_type_users = alarm_type_users\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 80,
        "wires": [
            [
                "50953aedb5beea9a"
            ]
        ]
    },
    {
        "id": "acfc84718d0a97bc",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "x": 490,
        "y": 80,
        "wires": [
            [
                "521ef6b0c559facc"
            ]
        ]
    },
    {
        "id": "50953aedb5beea9a",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 182",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 80,
        "wires": []
    },
    {
        "id": "49e853253b80de73",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "数据处理",
        "func": "let data = msg.payload\nif(!data || !data.sourceName || !data.emergentContent){\n    return\n}\nlet uuid = flow.get(\"uuid\")()\nlet spaceCode = data.spaceCode ? data.spaceCode : \"\"\nlet floorAreaCode = data.floorAreaCode ? data.floorAreaCode : \"\"\nlet floorCode = data.floorCode ? data.floorCode : \"\"\nlet areaCode = data.areaCode ? data.areaCode : \"\"\nlet sourceName = data.sourceName ? data.sourceName : \"\"\nlet classify = \"security\"\nlet classifyName = \"安防告警\"\nlet emergentType = data.emergentType\nlet emergentContent = data.emergentContent\nlet voiceText = data.emergentContent  //语音文本规则？\nlet voiceUrl = \"\"\nlet happenDate = moment().format(\"YYYY-MM-DD\")\nlet happenTime = moment().format(\"YYYY-MM-DD HH:mm:ss\")\nlet createTime = parseInt(new Date().getTime() / 1000)\nlet values = [uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime]\nawait global.get(\"mysql_query\")('insert into system_emergent (uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n\nlet msgArr = [null, null]\n//生成tts语音\nlet ttsMsg = {}\nttsMsg.payload = {\n    uuid:uuid,\n    type:classify,\n    message:voiceText\n}\nmsgArr[0] = ttsMsg\n\n//推送终端\nlet pushMsg = {}\npushMsg.payload = {\n    uuid:uuid,\n    spaceCode: spaceCode,\n    floorAreaCode: floorAreaCode,\n    floorCode: floorCode,\n    areaCode: areaCode,\n    sourceName: sourceName,\n    happenTime:happenTime,\n    message:emergentContent\n}\nmsgArr[1] = pushMsg\nnode.send(msgArr)\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "CryptoJS",
                "module": "crypto-js"
            },
            {
                "var": "WebSocket",
                "module": "ws"
            },
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 700,
        "y": 1280,
        "wires": [
            [],
            [
                "34b4401c926df656"
            ]
        ]
    },
    {
        "id": "fd316b07de627909",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "安防告警接收",
        "topic": "/iot/action/emergent/security",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 430,
        "y": 1280,
        "wires": [
            [
                "49e853253b80de73"
            ]
        ]
    },
    {
        "id": "62f44606cf33df05",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "推送数据出口",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1120,
        "y": 1240,
        "wires": []
    },
    {
        "id": "7e67e7f908ddcdfa",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "拆分数据",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet repair_clean_logs = await global.get(\"mysql_query\")(\"select * from repair_clean_log where spaceCode = ?\", [spaceCode])\nfor(let i = 0; i < repair_clean_logs.length; i++){\n    let log = repair_clean_logs[i]\n    if(!log.spaceCode || !log.floorAreaCode || !log.floorCode || !log.areaCode){\n        await global.get(\"mysql_query\")(\"delete from repair_clean_log where id = ?\", [log.id])\n        continue\n    }\n\n    let repair_clean_logs2 = await global.get(\"mysql_query\")(\"select * from repair_clean_log where id = ? limit 1\", [log.id])\n    if(repair_clean_logs2[0] == undefined){\n        continue\n    }\n    log = repair_clean_logs2[0]\n\n    let data = {}\n    data.empName = log.empName\n    data.endTime = log.endTime\n    data.updateTime = log.updateTime\n    msg.topic = \"/iot/status/cleaning/\"+log.spaceCode+\"/\"+log.floorAreaCode+\"/\"+log.floorCode+\"/\"+log.areaCode\n    msg.payload = data\n    node.send(msg)\n    await global.get(\"sleep\")(200)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 1240,
        "wires": [
            [
                "62f44606cf33df05",
                "cc4cd792056bdf16"
            ]
        ]
    },
    {
        "id": "ee688f1a5f66e481",
        "type": "inject",
        "z": "f788b38babc60666",
        "d": true,
        "name": "定时推送报修保洁数据",
        "props": [],
        "repeat": "360",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 450,
        "y": 1240,
        "wires": [
            [
                "7e67e7f908ddcdfa"
            ]
        ]
    },
    {
        "id": "34b4401c926df656",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "推送到监控终端",
        "topic": "/emergent/status/security/message",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1120,
        "y": 1280,
        "wires": []
    },
    {
        "id": "cc4cd792056bdf16",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 185",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1290,
        "y": 1240,
        "wires": []
    },
    {
        "id": "3eaff00449587fc3",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时清理冗余告警数据",
        "props": [],
        "repeat": "",
        "crontab": "45 23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 530,
        "y": 1580,
        "wires": [
            [
                "330a017698c868b1"
            ]
        ]
    },
    {
        "id": "330a017698c868b1",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "告警日志只保留一个月数据",
        "func": "let createTime = parseInt(moment().add(-1, 'd') / 1000);\nawait global.get(\"mysql_query\")(\"delete from system_alarm where createTime < ?\", [createTime])\nmsg.createTime = createTime\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 820,
        "y": 1580,
        "wires": [
            [
                "f0771c0a0f0187d4"
            ]
        ]
    },
    {
        "id": "f0771c0a0f0187d4",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 186",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1130,
        "y": 1580,
        "wires": []
    },
    {
        "id": "9caede29894e89de",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "告警数据推送至TD引擎",
        "topic": "/iot/systemalarm/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1170,
        "y": 240,
        "wires": []
    },
    {
        "id": "51848907d487fd4d",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "告警数据推送至TD引擎",
        "topic": "/iot/systemalarm/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1170,
        "y": 380,
        "wires": []
    },
    {
        "id": "f5c85c73a1bda864",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/pad/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1110,
        "y": 1680,
        "wires": []
    },
    {
        "id": "e539b204d67d1c8f",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "门牌状态数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    let statusArr = [0,1,2,3]\n    for(let i = 0; i < devices.length; i++){\n        let status = devices[i].status\n        if (!status || status.padStatus == undefined){\n            continue\n        }\n        let padStatus = parseInt(status.padStatus)\n        if (!statusArr.includes(padStatus)){\n            continue\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        \n     \n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        data.status = padStatus\n        \n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 1680,
        "wires": [
            [
                "f5c85c73a1bda864"
            ]
        ]
    },
    {
        "id": "f1d6d034d78ce0be",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "发布每个设备状态信息",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 900,
        "y": 280,
        "wires": []
    },
    {
        "id": "86052a2fda1de89f",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? and deleteFlag = 1 limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ?, statusUptime = ? where id = ?\", [status, statusUptime, iot_devices[0].id])\n    \n        //如果状态中存在告警信息走另外一个分支\n        if(item.status){\n            let msgArr = [null, null]\n            iot_devices[0].status = item.status\n            iot_devices[0].statusUptime = statusUptime\n            let newMsg1 = {}\n            newMsg1.payload = iot_devices[0]\n            msgArr[0] = newMsg1\n            \n            if (iot_devices[0].type == \"light\" || iot_devices[0].type == \"dlight\" || iot_devices[0].type == \"airconditioning\" || iot_devices[0].type == \"aircleaner\" || iot_devices[0].type == \"airfan\" || iot_devices[0].type == \"airsensor\" || iot_devices[0].type == \"inundationsensor\"){\n                let newMsg2 = {}\n                newMsg2.topic = \"/iot/status/\" + iot_devices[0].type + \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode + \"/\" + iot_devices[0].name\n                newMsg2.payload = [item]\n                msgArr[1] = newMsg2\n            }\n\n            node.send(msgArr)\n        }\n        await global.get(\"sleep\")(100)\n    }\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 260,
        "wires": [
            [
                "42fb0c47235a27ae"
            ],
            [
                "f1d6d034d78ce0be"
            ]
        ]
    },
    {
        "id": "5c5b6d0b275e9d42",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let devices = msg.payload.devices\nlet params = msg.payload.params\nlet topic = msg.payload.topic\nlet gateway = msg.payload.gateway\nlet layer = msg.payload.layer\nif (gateway && layer && topic && params && devices && Array.isArray(devices)){\n    for (let i = 0; i < devices.length; i++) {\n        let item = devices[i]\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", gateway)\n        if (gateways[0] == undefined) {\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, layer, item.code])\n        if (iot_devices[0] == undefined) {\n            continue;\n        }\n        let g = gateways[0]\n        let d = iot_devices[0]\n\n        let title = \"\"\n        if(msg.payload.title){\n            title = msg.payload.title\n        }\n        let tag = \"\"\n        if (msg.payload.tag) {\n            title = msg.payload.tag\n        }\n        let actionName = \"\"\n        if (params.action == \"on\"){\n            actionName = \"开启\"\n        }else if(params.action == \"off\"){\n            actionName = \"关闭\"\n        }\n        let level = \"NORMAL\"\n        let sourceFrom = \"\"\n        if(params.sourceFrom){\n            sourceFrom = params.sourceFrom\n        }\n        let sourceTopic = topic\n        let sourceContent = JSON.stringify(params)\n        let spaceCode = d.spaceCode\n        let spaceName = d.spaceName\n        let areaCode = d.areaCode\n        let areaName = d.areaName\n        let floorCode = d.floorCode\n        let floorName = d.floorName\n        let floorAreaType = d.floorAreaType\n        let floorAreaCode = d.floorAreaCode\n        let floorAreaName = d.floorAreaName\n        let gatewayID = g.id\n        let gatewayName = g.name\n        let deviceCode = d.code\n        let deviceName = d.name\n        let orgID = \"\"\n        let orgName = \"\"\n        let departmentID = \"\"\n        let departmentName = \"\"\n        let userID = \"\"\n        let userName = \"\"\n        let createtime = parseInt(new Date().getTime() / 1000)\n        let values = [title, tag, actionName, level, sourceFrom, sourceTopic, sourceContent, spaceCode, spaceName, floorAreaCode, floorAreaName, floorCode, floorName, floorAreaType, areaCode, areaName, gatewayID, gatewayName, deviceCode, deviceName, orgID, orgName, departmentID, departmentName, userID, userName, createtime]\n        await global.get(\"mysql_query\")('insert into iot_log(title, tag, actionName, level, sourceFrom, sourceTopic, sourceContent, spaceCode, spaceName, floorAreaCode, floorAreaName, floorCode, floorName, floorAreaType, areaCode, areaName, gatewayID, gatewayName, deviceCode, deviceName, orgID, orgName, departmentID, departmentName, userID, userName, createtime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 340,
        "wires": [
            [
                "6ae33de94a875347"
            ]
        ]
    },
    {
        "id": "abf17217b45d6151",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时检测告警提醒",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 450,
        "y": 460,
        "wires": [
            [
                "62e3406bf16e4f0f"
            ]
        ]
    },
    {
        "id": "62e3406bf16e4f0f",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "告警提醒",
        "func": "let spaceId = flow.get(\"spaceId\")\nif (!spaceId) {\n    return\n}\nlet alarm_type_users = flow.get(\"alarm_type_users\")\nlet system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and status = '0' and isNotice = 0 limit 1000\", [spaceId])\nfor (let i = 0; i < system_alarm_sources.length; i++){\n    let d = system_alarm_sources[i]\n    let type = d.type\n    let notice_users = []\n    if (alarm_type_users && alarm_type_users[type]) {\n        notice_users = alarm_type_users[type]\n    }\n    for (let i = 0; i < notice_users.length; i++) {\n        let userId = notice_users[i].userId\n        let userName = notice_users[i].userName\n        if (!userId) {\n            continue\n        }\n        let alarmSourceId = d.id\n        let typeName = d.typeName\n        let deviceID = d.deviceID\n        let deviceName = d.deviceName\n        let deviceAddress = d.deviceAddress\n        let deviceFullName = d.deviceFullName\n        let alarmCode = d.alarmCode\n        let alarmMsg = d.alarmMsg\n        let baseUnit = d.baseUnit\n        let baseValue = d.baseValue\n        let realValue = d.realValue\n        let createTime = parseInt(new Date().getTime() / 1000)\n\n        let values = [spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n        await global.get(\"mysql_query\")(\"insert into system_alarm_notice (spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n        // let system_alarm_notices = await global.get(\"mysql_query\")(\"select * from system_alarm_notice where spaceId = ? and alarmSourceId = ? and userId = ? limit 1\", [spaceId, alarmSourceId, userId])\n        // if (system_alarm_notices[0] == undefined) {\n        //     let values = [spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n        //     await global.get(\"mysql_query\")(\"insert into system_alarm_notice (spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n        // }\n    }\n    await global.get(\"mysql_query\")(\"update system_alarm_source set isNotice = 1 where id = ?\", [d.id])\n    await global.get(\"sleep\")(500)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 680,
        "y": 460,
        "wires": [
            [
                "1d2e13bf2ff943dd"
            ]
        ]
    },
    {
        "id": "1d2e13bf2ff943dd",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 202",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 460,
        "wires": []
    },
    {
        "id": "2c261e79403e96a5",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "每天22点自动处理未处理告警源数据",
        "props": [],
        "repeat": "",
        "crontab": "00 22 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 490,
        "y": 1740,
        "wires": [
            [
                "38efa8c3ad3a741a"
            ]
        ]
    },
    {
        "id": "38efa8c3ad3a741a",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "处理数据",
        "func": "let spaceId = flow.get(\"spaceId\")\nlet system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and status = 0\", [spaceId])\nif (!system_alarm_sources){\n    system_alarm_sources = []\n}\nfor (let i = 0; i < system_alarm_sources.length; i++){\n    let s =  system_alarm_sources[i]\n    let alarmId = s.id\n    let handleStatus = \"3\"\n    let handleMsg = \"自动处理\"\n    let handleUserId = \"1\"\n    let handleUserEmpNo = \"\"\n    let handleUserName = \"系统\"\n    let createTime = parseInt(new Date().getTime()/1000)\n    let values = [alarmId, handleStatus, handleMsg, handleUserId, handleUserEmpNo, handleUserName, createTime]\n    await global.get(\"mysql_query\")(\"insert into system_alarm_handle (alarmId, handleStatus, handleMsg, handleUserId, handleUserEmpNo, handleUserName, createTime) values (?,?,?,?,?,?,?)\", values)\n\n    await global.get(\"mysql_query\")(\"update system_alarm_source set status = ? where id = ? limit 1\", [handleStatus, alarmId])\n    \n    await global.get(\"sleep\")(100)\n\n}\nmsg.system_alarm_sources = system_alarm_sources\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 1740,
        "wires": [
            [
                "062763a16afef5f3"
            ]
        ]
    },
    {
        "id": "062763a16afef5f3",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 215",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 1740,
        "wires": []
    },
    {
        "id": "7615659828c51693",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n\n        if(item.padStatus != undefined){\n            item.status.padStatus = item.padStatus\n        }\n\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ? ,statusUptime = ? where id = ? limit 1\", [status, statusUptime, iot_devices[0].id])\n    }\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 770,
        "y": 1640,
        "wires": [
            [
                "202f540fa1cc43af"
            ]
        ]
    },
    {
        "id": "202f540fa1cc43af",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 216",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1170,
        "y": 1640,
        "wires": []
    },
    {
        "id": "a39150e28b5d5fa1",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时检测设备离线告警",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 450,
        "y": 500,
        "wires": [
            [
                "a04873c77b2f8b83"
            ]
        ]
    },
    {
        "id": "a04873c77b2f8b83",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "离线设备告警检测",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet spaceId = flow.get(\"spaceId\")\nif (!spaceId || !spaceCode) {\n    return\n}\n//排除分区\nlet invalidFloorAreas = []\n//排除楼层\nlet invalidFloors = []\n\nlet checkTime = parseInt(new Date().getTime() / 1000) - 600\nlet checkTimePower = parseInt(new Date().getTime() / 1000) - 1800\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where spaceCode = ? and deleteFlag = 1 and type != 'blind' and ( statusUptime < ? or statusUptime = '')\", [spaceCode, checkTime])\n\n// node.error(iot_devices)\n\nfor (let i = 0; i < iot_devices.length; i++){\n    let device = iot_devices[i]\n    if (invalidFloorAreas.includes(device.areaCode) || invalidFloors.includes(device.floorCode)){\n        continue\n    }\n\n    //电量采集单独判断, 30分钟无数据判定离线\n    if (device.type == \"powersensor\" && device.statusUptime && device.statusUptime >= checkTimePower){\n        continue\n    }\n\n    let dStatus = flow.get(\"jsJson\")(device.status)\n    if (device.type == \"aicamerasensor\" && dStatus && dStatus.densitycount == undefined){\n        continue\n    }\n\n    let type = \"\" //设备类型报警\n    let typeName = \"\"\n    let deviceID = device.id\n    let deviceName = device.name\n    let deviceAddress = \"\"\n    let deviceFullName = \"/\" + device.spaceCode + \"/\" + device.areaCode + \"/\" + device.floorCode + \"/\" + device.floorAreaCode + \"/\" + device.name\n    let alarmCode = \"\"\n    let alarmMsg = \"\"\n    let baseUnit = \"\"\n    let baseValue = \"\"\n    let realValue = \"\"\n    let createTime = parseInt(new Date().getTime() / 1000)\n    let updateTime = createTime\n\n    type = \"1\" //设备类型报警\n    typeName = \"设备告警\"\n    deviceAddress = \"online\"\n    alarmCode = \"\"\n    alarmMsg = \"设备离线\"\n\n    //记录告警日志\n    let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n    await global.get(\"mysql_query\")(\"insert into system_alarm (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n    //推送日志信息到TD\n    let data = {}\n    data.ts = new Date().getTime()\n    data.position = deviceFullName\n    data.space = device.spaceCode\n    data.floor_area = device.areaCode\n    data.floor = device.floorCode\n    data.area = device.floorAreaCode\n    data.device_code = device.code\n    data.device_id = device.id\n    data.type = type\n    data.type_name = typeName\n    data.device_address = deviceAddress\n    data.alarm_code = alarmCode\n    data.alarm_msg = alarmMsg\n    data.base_unit = baseUnit\n    data.base_value = baseValue\n    data.real_value = realValue\n    let newMsg = {}\n    newMsg.payload = data\n    node.send(newMsg)\n\n    //记录告警数据源\n    let system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and deviceID = ? and status = '0' and deviceAddress = ? limit 1\", [spaceId, device.id, deviceAddress])\n    if (system_alarm_sources[0] == undefined) {\n        let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime]\n        await global.get(\"mysql_query\")(\"insert into system_alarm_source (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n    } else {\n        await global.get(\"mysql_query\")(\"update system_alarm_source set updateTime = ? where id = ?\", [updateTime, system_alarm_sources[0].id])\n    }   \n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 710,
        "y": 500,
        "wires": [
            [
                "a1e914ecd4ff8fbe"
            ]
        ]
    },
    {
        "id": "a1e914ecd4ff8fbe",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "告警数据推送至TD引擎",
        "topic": "/iot/systemalarm/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1030,
        "y": 500,
        "wires": []
    },
    {
        "id": "77107eb5ef05f869",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "边缘网关心跳数据接收",
        "topic": "/iot/status/gateway/heartbeat",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 500,
        "y": 1980,
        "wires": [
            [
                "6d5985c1399ef480"
            ]
        ]
    },
    {
        "id": "6d5985c1399ef480",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let data = msg.payload\nif (data && data.macaddr){\n    let macaddr = data.macaddr\n    let statusUptime = parseInt(new Date().getTime() / 1000)\n    await global.get(\"mysql_query\")(\"update iot_gateway set heartbeatTime = ? where macaddr = ? limit 1\", [statusUptime, macaddr])\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 770,
        "y": 1980,
        "wires": [
            [
                "4d242282da77a898"
            ]
        ]
    },
    {
        "id": "4d242282da77a898",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 218",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 1980,
        "wires": []
    },
    {
        "id": "b6b8dd43032bf153",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时处理已通知告警到日志记录",
        "props": [],
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 500,
        "y": 1780,
        "wires": [
            [
                "6c53bb5a8803e364"
            ]
        ]
    },
    {
        "id": "6c53bb5a8803e364",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let spaceId = flow.get(\"spaceId\")\nlet system_alarm_notices = await global.get(\"mysql_query\")(\"select * from system_alarm_notice where spaceId = ? and (isNotice = 2 or isNotice = 3) limit 10000\", [spaceId])\nfor (let i = 0; i < system_alarm_notices.length; i++){\n    let d = system_alarm_notices[i]\n    let userId = d.userId\n    let userName = d.userName\n    let alarmSourceId = d.id\n    let type = d.type\n    let typeName = d.typeName\n    let deviceID = d.deviceID\n    let deviceName = d.deviceName\n    let deviceAddress = d.deviceAddress\n    let deviceFullName = d.deviceFullName\n    let alarmCode = d.alarmCode\n    let alarmMsg = d.alarmMsg\n    let baseUnit = d.baseUnit\n    let baseValue = d.baseValue\n    let realValue = d.realValue\n    let createTime = d.createTime\n    let isNotice = d.isNotice\n    let noticeMsg = d.noticeMsg\n\n    let values = [spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, isNotice, noticeMsg]\n    await global.get(\"mysql_query\")(\"insert into system_alarm_notice_log (spaceId, alarmSourceId, userId, userName, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, isNotice, noticeMsg) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n    await global.get(\"mysql_query\")(\"delete from system_alarm_notice where id = ? limit 1\", [d.id])\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 1780,
        "wires": [
            [
                "2d43ccb372b61bb4"
            ]
        ]
    },
    {
        "id": "2d43ccb372b61bb4",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 220",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 1780,
        "wires": []
    },
    {
        "id": "b3f34b47c8145a50",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时处理通行日志记录",
        "props": [],
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 470,
        "y": 1820,
        "wires": [
            [
                "038a0a5aaa11b626"
            ]
        ]
    },
    {
        "id": "038a0a5aaa11b626",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let spaceId = flow.get(\"spaceId\")\nlet checkTime = moment(moment().format(\"YYYY-MM-DD\")).unix()\nlet door_pass_logs = await global.get(\"mysql_query\")(\"select * from door_pass_log where spaceId = ? and passTime < ? order by passTime ASC limit 50000\", [spaceId, checkTime])\nfor (let i = 0; i < door_pass_logs.length; i++){\n    let d = door_pass_logs[i]\n    let values = [d.spaceId, d.platform, d.personName, d.personId, d.personType, d.personPhone, d.personEmail, d.personEmpNo, d.passDirection, d.serviceId, d.serviceName, d.doorId, d.doorName, d.passType, d.faceUrl, d.cardNum, d.passTime, d.passTimeStr]\n    await global.get(\"mysql_query\")('insert into door_pass_final_log (spaceId, platform, personName, personId, personType, personPhone, personEmail, personEmpNo, passDirection, serviceId, serviceName, doorId, doorName, passType, faceUrl, cardNum, passTime, passTimeStr) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n\n    await global.get(\"mysql_query\")(\"delete from door_pass_log where id = ? limit 1\", [d.id])\n}\nmsg.checkTime = checkTime\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 1840,
        "wires": [
            [
                "66637dff65b58043"
            ]
        ]
    },
    {
        "id": "66637dff65b58043",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 223",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 1840,
        "wires": []
    },
    {
        "id": "4712d1c86af5f099",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时处理通行日志记录",
        "props": [],
        "repeat": "",
        "crontab": "30 01 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 470,
        "y": 1860,
        "wires": [
            [
                "038a0a5aaa11b626"
            ]
        ]
    },
    {
        "id": "ce10fe258034da28",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "推送到监控终端",
        "topic": "/emergent/status/security/message",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1120,
        "y": 1120,
        "wires": []
    },
    {
        "id": "7399891f7bc49f03",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "获取当日策略日志数据到TD临时表",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 500,
        "y": 2080,
        "wires": [
            [
                "12bdcd3884e74b90"
            ]
        ]
    },
    {
        "id": "12bdcd3884e74b90",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "处理数据",
        "func": "let checkTime = moment(moment().format(\"YYYY-MM-DD\")).unix()\nlet spaceCode = flow.get(\"spaceCode\")\nlet iot_policy_logs = await global.get(\"mysql_query\")(\"select * from iot_policy_log_new where spaceCode = ? and  createTime >= ?\", [spaceCode, checkTime])\nfor (let i = 0; i < iot_policy_logs.length; i++) {\n    let d = iot_policy_logs[i]\n    let sourceType = \"policy\"\n    let sourceName = d.policyName\n    let userId = \"\"\n    let userName = \"\"\n    let userEmpNo = \"\"\n    let spaceCode = d.spaceCode\n    let floorAreaCode = d.floorAreaCode\n    let floorCode = d.floorCode\n    let areaCode = d.areaCode\n    let deviceType = d.deviceType\n    let actionTopic = d.actionTopic\n    let actionData = d.actionData\n    let controlTime = d.createTime\n    let log_id = \"policy_\"+d.id\n\n    let values = [sourceType, sourceName, userId, userName, userEmpNo, spaceCode, floorAreaCode, floorCode, areaCode, deviceType, actionTopic, actionData, controlTime, log_id]\n    let iot_control_log_temps = await global.get(\"mysql_query\")(\"select * from iot_control_log_temp where log_id = ? limit 1\", [log_id])\n    if (iot_control_log_temps[0] == undefined){\n        await global.get(\"mysql_query\")(\"insert into iot_control_log_temp (sourceType, sourceName, userId, userName, userEmpNo, spaceCode, floorAreaCode, floorCode, areaCode, deviceType, actionTopic, actionData, controlTime, log_id) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 780,
        "y": 2060,
        "wires": [
            [
                "ff638e58f95277fa"
            ]
        ]
    },
    {
        "id": "ff638e58f95277fa",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 256",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1030,
        "y": 2060,
        "wires": []
    },
    {
        "id": "52a868741f5b7aa2",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "处理数据",
        "func": "let checkTime = moment(moment().format(\"YYYY-MM-DD\")).unix()\nlet spaceCode = flow.get(\"spaceCode\")\nlet iot_control_logs = await global.get(\"mysql_query\")(\"select * from iot_control_log where spaceCode = ? and  createTime >= ?\", [spaceCode, checkTime])\nfor (let i = 0; i < iot_control_logs.length; i++) {\n    let d = iot_control_logs[i]\n    let sourceType = d.sourceType\n    let sourceName = d.sourceName\n    let userId = d.userId\n    let userName = d.userName\n    let userEmpNo = d.userEmpNo ? d.userEmpNo : \"\"\n    let spaceCode = d.spaceCode\n    let floorAreaCode = d.floorAreaCode\n    let floorCode = d.floorCode\n    let areaCode = d.areaCode\n    let deviceType = d.deviceType\n    let actionTopic = d.actionTopic\n    let actionData = d.actionData\n    let controlTime = d.createTime\n    let log_id = \"control_\"+d.id\n\n    let values = [sourceType, sourceName, userId, userName, userEmpNo, spaceCode, floorAreaCode, floorCode, areaCode, deviceType, actionTopic, actionData, controlTime, log_id]\n    let iot_control_log_temps = await global.get(\"mysql_query\")(\"select * from iot_control_log_temp where log_id = ? limit 1\", [log_id])\n    if (iot_control_log_temps[0] == undefined){\n        await global.get(\"mysql_query\")(\"insert into iot_control_log_temp (sourceType, sourceName, userId, userName, userEmpNo, spaceCode, floorAreaCode, floorCode, areaCode, deviceType, actionTopic, actionData, controlTime, log_id) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n    }\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 780,
        "y": 2140,
        "wires": [
            [
                "703a04951a5ec4bd"
            ]
        ]
    },
    {
        "id": "703a04951a5ec4bd",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 257",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1030,
        "y": 2140,
        "wires": []
    },
    {
        "id": "aa369e5310911fd2",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时推送当日日志数据到TD",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 520,
        "y": 2200,
        "wires": [
            [
                "cb5acd420bde1b2d"
            ]
        ]
    },
    {
        "id": "cb5acd420bde1b2d",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "推送数据到TD",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet iot_control_log_temps = await global.get(\"mysql_query\")(\"select * from iot_control_log_temp where spaceCode = ? and flag = 0 limit 5000\", [spaceCode])\nfor (let i = 0; i < iot_control_log_temps.length; i++) {\n    let d = iot_control_log_temps[i]\n    let sourceType = d.sourceType\n    let sourceName = d.sourceName\n    let userId = d.userId\n    let userName = d.userName\n    let userEmpNo = d.userEmpNo ? d.userEmpNo : \"\"\n    let deviceType = d.deviceType\n    let actionTopic = d.actionTopic\n    let actionData = d.actionData\n    let controlTime = d.controlTime\n\n    let data = {}\n    data.ts = parseInt(controlTime) * 1000 + parseInt(Math.random() * (999 - 100) + 100)\n    data.space = d.spaceCode\n    data.floor_area = d.floorAreaCode\n    data.floor = d.floorCode\n    data.area = d.areaCode\n    data.source_type = sourceType\n    data.source_name = sourceName\n    data.user_id = userId\n    data.user_emp_no = userEmpNo\n    data.user_name = userName\n    data.device_type = deviceType\n    data.action_topic = actionTopic\n    data.action_data = actionData\n\n    let newMsg = {}\n    newMsg.payload = data\n    node.send(newMsg)\n\n    await global.get(\"mysql_query\")(\"update iot_control_log_temp set flag = 1 where id = ? limit 1\", [d.id])\n    await global.get(\"sleep\")(100)\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 800,
        "y": 2200,
        "wires": [
            [
                "adf70c6d6bb32469"
            ]
        ]
    },
    {
        "id": "adf70c6d6bb32469",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/iotcontrollog/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1080,
        "y": 2200,
        "wires": []
    },
    {
        "id": "2ddf70b50776776e",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "23:59获取当日策略日志数据到TD临时表",
        "props": [],
        "repeat": "",
        "crontab": "59 23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 480,
        "y": 2040,
        "wires": [
            [
                "12bdcd3884e74b90"
            ]
        ]
    },
    {
        "id": "3876276196095a03",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "23:59获取当日控制日志数据到TD临时表",
        "props": [],
        "repeat": "",
        "crontab": "59 23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 480,
        "y": 2120,
        "wires": [
            [
                "52a868741f5b7aa2"
            ]
        ]
    },
    {
        "id": "dee4727a1014de96",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "获取当日控制日志数据到TD临时表",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 500,
        "y": 2160,
        "wires": [
            [
                "52a868741f5b7aa2"
            ]
        ]
    },
    {
        "id": "f9894fecd47d8f2a",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "00:10清理已推送数据",
        "props": [],
        "repeat": "",
        "crontab": "10 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 540,
        "y": 2280,
        "wires": [
            [
                "1afab35d503d9cef"
            ]
        ]
    },
    {
        "id": "1afab35d503d9cef",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet checkTime = moment(moment().format(\"YYYY-MM-DD\")).unix()\nawait global.get(\"mysql_query\")(\"delete from iot_control_log_temp where spaceCode = ? and flag = 1 and controlTime < ?\", [spaceCode, checkTime])\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 780,
        "y": 2280,
        "wires": [
            [
                "130255c297afde94"
            ]
        ]
    },
    {
        "id": "130255c297afde94",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 259",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1030,
        "y": 2280,
        "wires": []
    },
    {
        "id": "6898036966b17a31",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "23:59推送当日日志数据到TD",
        "props": [],
        "repeat": "",
        "crontab": "59 23 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 510,
        "y": 2240,
        "wires": [
            [
                "cb5acd420bde1b2d"
            ]
        ]
    },
    {
        "id": "5e5df18900657385",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 293",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 1160,
        "wires": []
    },
    {
        "id": "61b8ecbd34a7641b",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/powersensor_loop/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1160,
        "y": 700,
        "wires": []
    },
    {
        "id": "bef5be64755cbed4",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "定时获取电箱回路属性映射关系",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 400,
        "y": 660,
        "wires": [
            [
                "29dbd05bdbdef603"
            ]
        ]
    },
    {
        "id": "29dbd05bdbdef603",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "缓存关系表",
        "func": "let spaceCode = flow.get(\"spaceCode\")\nlet iot_power_loop_types = await global.get(\"mysql_query\")(\"select * from iot_power_loop_type where spaceCode = ?\", [spaceCode])\nlet iot_power_loop_type_obj = {}\nfor (let i = 0; i < iot_power_loop_types.length; i++){\n    let d = iot_power_loop_types[i]\n    if(iot_power_loop_type_obj[d.deviceId] == undefined){\n        iot_power_loop_type_obj[d.deviceId] = {}\n    }\n    for (let i = 1; i <= 27; i++) {\n        if(d[\"loop\"+i] == undefined){\n            continue\n        }\n        iot_power_loop_type_obj[d.deviceId][\"loop\"+i] = d[\"loop\"+i]\n    }\n}\nflow.set(\"iot_power_loop_type_obj\", iot_power_loop_type_obj)\n\nlet iot_power_loop_codes = await global.get(\"mysql_query\")(\"select * from iot_power_loop_code where spaceCode = ?\", [spaceCode])\nlet iot_power_loop_code_obj = {}\nfor (let i = 0; i < iot_power_loop_codes.length; i++) {\n    let d = iot_power_loop_codes[i]\n    if (iot_power_loop_code_obj[d.deviceId] == undefined) {\n        iot_power_loop_code_obj[d.deviceId] = {}\n    }\n    for (let i = 1; i <= 27; i++) {\n        if (d[\"loop\" + i] == undefined) {\n            continue\n        }\n        iot_power_loop_code_obj[d.deviceId][\"loop\" + i] = d[\"loop\" + i]\n    }\n}\nflow.set(\"iot_power_loop_code_obj\", iot_power_loop_code_obj)\n\nlet iot_power_loop_names = await global.get(\"mysql_query\")(\"select * from iot_power_loop_name where spaceCode = ?\", [spaceCode])\nlet iot_power_loop_name_obj = {}\nfor (let i = 0; i < iot_power_loop_names.length; i++) {\n    let d = iot_power_loop_names[i]\n    if (iot_power_loop_name_obj[d.deviceId] == undefined) {\n        iot_power_loop_name_obj[d.deviceId] = {}\n    }\n    for (let i = 1; i <= 27; i++) {\n        if (d[\"loop\" + i] == undefined) {\n            continue\n        }\n        iot_power_loop_name_obj[d.deviceId][\"loop\" + i] = d[\"loop\" + i]\n    }\n}\nflow.set(\"iot_power_loop_name_obj\", iot_power_loop_name_obj)\n\nmsg.iot_power_loop_type_obj = iot_power_loop_type_obj\nmsg.iot_power_loop_code_obj = iot_power_loop_code_obj\nmsg.iot_power_loop_name_obj = iot_power_loop_name_obj\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 690,
        "y": 660,
        "wires": [
            [
                "301331fc1331a995"
            ]
        ]
    },
    {
        "id": "301331fc1331a995",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 314",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 850,
        "y": 660,
        "wires": []
    },
    {
        "id": "e7382cc6368e2a83",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "处理数据",
        "func": "let spaceCode = msg.payload.spaceCode\nlet areaCode = msg.payload.floorAreaCode\nlet floorCode = msg.payload.floorCode\nlet floorAreaCode = msg.payload.areaCode\nlet tc = msg.payload.tc  //温控策略 open  close\nif (tc != \"close\"){\n    tc = \"open\"\n}\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1 and spaceCode =? and areaCode =? and floorCode = ? and floorAreaCode = ? and type = 'pad' limit 1\", [spaceCode, areaCode, floorCode, floorAreaCode])\nif (!iot_devices[0] || !iot_devices[0].id){\n    return\n}\nlet d = iot_devices[0]\nlet deviceId = d.id\nlet createTime = parseInt(new Date().getTime()/1000)\nlet iot_policy_switchs = await global.get(\"mysql_query\")(\"select * from `iot_policy_switch` where deviceId = ? limit 1\", [deviceId])\nif (iot_policy_switchs[0] == undefined){\n    let values = [deviceId, tc, createTime]\n    //await global.get(\"mysql_query\")(\"insert into iot_policy_switch (deviceId, tc, createTime) values (?,?,?)\", values)\n}else{\n    await global.get(\"mysql_query\")(\"update iot_policy_switch set tc = ? where id = ?\", [tc, iot_policy_switchs[0].id])\n}\n\n\nlet db_iot_policy_switchs = await global.get(\"mysql_query\")(\"select * from `iot_policy_switch` where deviceId = ? limit 1\", [deviceId])\nif (!db_iot_policy_switchs[0] || !db_iot_policy_switchs[0].id){\n    return\n}\nlet newMsg = {}\nnewMsg.topic = \"/iot/pad/policy/switch/\" + spaceCode + \"/\" + areaCode + \"/\" + floorCode + \"/\" + floorAreaCode\nnewMsg.payload = {\n    tc:db_iot_policy_switchs[0].tc\n}\nreturn newMsg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 2360,
        "wires": [
            [
                "f71510e6a6bfbbd9",
                "38ce12f60cd74f50"
            ]
        ]
    },
    {
        "id": "5a7f8efe77d0cde9",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "平板端设置智控开关入口",
        "topic": "/iot/setting/pad/policy/switch",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 510,
        "y": 2360,
        "wires": [
            [
                "e7382cc6368e2a83",
                "7bb6379a39fe0ae3"
            ]
        ]
    },
    {
        "id": "f71510e6a6bfbbd9",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "状态返回",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1080,
        "y": 2360,
        "wires": []
    },
    {
        "id": "0d566bc22c8ffc92",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取平板开光状态",
        "func": "let spaceCode = msg.payload.spaceCode\nlet areaCode = msg.payload.floorAreaCode\nlet floorCode = msg.payload.floorCode\nlet floorAreaCode = msg.payload.areaCode\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1 and spaceCode =? and areaCode =? and floorCode = ? and floorAreaCode = ? and type = 'pad' limit 1\", [spaceCode, areaCode, floorCode, floorAreaCode])\nif (!iot_devices[0] || !iot_devices[0].id){\n    return\n}\nlet d = iot_devices[0]\nlet deviceId = d.id\nlet db_iot_policy_switchs = await global.get(\"mysql_query\")(\"select * from `iot_policy_switch` where deviceId = ? limit 1\", [deviceId])\nif (!db_iot_policy_switchs[0] || !db_iot_policy_switchs[0].id){\n    return\n}\nlet newMsg = {}\nnewMsg.topic = \"/iot/pad/policy/switch/\" + spaceCode + \"/\" + areaCode + \"/\" + floorCode + \"/\" + floorAreaCode\nnewMsg.payload = {\n    tc:db_iot_policy_switchs[0].tc\n}\nreturn newMsg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 2440,
        "wires": [
            [
                "4cb346ce290730b5",
                "f58e7c6db1a1f27a"
            ]
        ]
    },
    {
        "id": "4cb346ce290730b5",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "状态返回",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1080,
        "y": 2440,
        "wires": []
    },
    {
        "id": "649d12c5dd9feefe",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "平板端查询智控开关入口",
        "topic": "/iot/action/pad/policy/switch/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 510,
        "y": 2440,
        "wires": [
            [
                "0d566bc22c8ffc92",
                "82c3952f7ecba5d7"
            ]
        ]
    },
    {
        "id": "0b32bcbb6bc236d8",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "每天06:00恢复温控开关",
        "props": [],
        "repeat": "",
        "crontab": "00 06 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 530,
        "y": 2480,
        "wires": [
            [
                "7e445666e3c3e11e"
            ]
        ]
    },
    {
        "id": "7e445666e3c3e11e",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "恢复数据",
        "func": "await global.get(\"mysql_query\")(\"update `iot_policy_switch` set tc = 'open'\")\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 2480,
        "wires": [
            [
                "f7c1529acce9b6df"
            ]
        ]
    },
    {
        "id": "f7c1529acce9b6df",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 324",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 2480,
        "wires": []
    },
    {
        "id": "0365c27cec9b30e6",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "每天12:30恢复温控开关",
        "props": [],
        "repeat": "",
        "crontab": "30 12 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 530,
        "y": 2520,
        "wires": [
            [
                "7e445666e3c3e11e"
            ]
        ]
    },
    {
        "id": "c594b19b6394c388",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取属地所有区域",
        "func": "let result = []\nlet spaces = await global.get(\"mysql_query\")(\"select * from space where deleteFlag = 1\")\nlet spaceMqttInfo = global.get(\"spaceMqttInfo\")\nif (!spaceMqttInfo){\n    spaceMqttInfo = {}\n}\nfor (let i = 0; i < spaces.length; i++){\n    let space = {}\n    space.name = spaces[i].name\n    space.code = spaces[i].code\n    if (spaceMqttInfo[space.code]){\n        space.mqttstring = new Buffer(spaceMqttInfo[space.code]).toString('base64')\n    }\n    space.floorArea = []\n    let areas = await global.get(\"mysql_query\")(\"select * from area where spaceCode = ? and deleteFlag = 1 order by code ASC\", spaces[i].code)\n    for(let j = 0; j < areas.length; j++){\n        let area = {}\n        area.name = areas[j].name\n        area.code = areas[j].code\n        area.floor = []\n        let floors = await global.get(\"mysql_query\")(\"select * from floor where spaceCode = ? and areaCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code])\n        for (let k = 0; k < floors.length; k++){\n            let floor = {}\n            floor.name = floors[k].name\n            floor.code = floors[k].code\n            floor.area = await global.get(\"mysql_query\")(\"select * from floor_area where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.mettingRoom = await global.get(\"mysql_query\")(\"select * from floor_mroom where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.toilet = await global.get(\"mysql_query\")(\"select * from floor_toilet where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            floor.room = await global.get(\"mysql_query\")(\"select * from floor_room where spaceCode = ? and areaCode = ? and floorCode = ? and deleteFlag = 1 order by code ASC\", [spaces[i].code, areas[j].code, floors[k].code])\n            area.floor.push(floor)\n        }\n        space.floorArea.push(area)\n    }\n    result.push(space)\n}\nmsg.payload = result\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 1420,
        "wires": [
            [
                "d73e062bdf3eb3b1"
            ]
        ]
    },
    {
        "id": "17829bc0036ecce8",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "获取区域所有设备",
        "func": "let spaceCode = msg.payload.spaceCode\nlet areaCode = msg.payload.floorAreaCode\nlet floorCode = msg.payload.floorCode\nlet floorAreaCode = msg.payload.areaCode\nlet iot_gateways = await global.get(\"mysql_query\")(\"select id,macaddr from iot_gateway where deleteFlag = 1 \")\nlet iot_gateways_obj = {}\nfor(let i = 0; i < iot_gateways.length; i++){\n    iot_gateways_obj[iot_gateways[i].id] = iot_gateways[i]\n}\n\nlet iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where deleteFlag = 1 and spaceCode =? and areaCode =? and floorCode = ? and floorAreaCode = ?\", [spaceCode, areaCode, floorCode, floorAreaCode])\nlet result = {}\nfor(let i = 0; i < iot_devices.length; i++){\n    if(result[iot_devices[i].type] == undefined){\n        result[iot_devices[i].type] = []\n    }\n    if (iot_gateways_obj[iot_devices[i].gatewayID]){\n        iot_devices[i].gatewayMac = iot_gateways_obj[iot_devices[i].gatewayID].macaddr\n    }\n    result[iot_devices[i].type].push(iot_devices[i])\n}\nmsg.topic = \"/iot/setting/device/\" + spaceCode + \"/\" + areaCode + \"/\" + floorCode + \"/\" + floorAreaCode\nmsg.payload = result\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 1460,
        "wires": [
            [
                "8b18bc28fc6b0bc3"
            ]
        ]
    },
    {
        "id": "c0fc0cb44564fcac",
        "type": "http in",
        "z": "f788b38babc60666",
        "name": "",
        "url": "/iot/setting/get/structure",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 440,
        "y": 1420,
        "wires": [
            [
                "c594b19b6394c388"
            ]
        ]
    },
    {
        "id": "d73e062bdf3eb3b1",
        "type": "http response",
        "z": "f788b38babc60666",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1020,
        "y": 1420,
        "wires": []
    },
    {
        "id": "bbdfbca6edae5eea",
        "type": "http in",
        "z": "f788b38babc60666",
        "name": "",
        "url": "/iot/setting/get/device",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 430,
        "y": 1460,
        "wires": [
            [
                "17829bc0036ecce8"
            ]
        ]
    },
    {
        "id": "8b18bc28fc6b0bc3",
        "type": "http response",
        "z": "f788b38babc60666",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1020,
        "y": 1460,
        "wires": []
    },
    {
        "id": "7bcbd50bdb8c1ea7",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let spaceId = \"9\"\nlet checkTime = moment(moment().format(\"YYYY-MM-DD\")).unix()\nlet door_pass_logs = await global.get(\"mysql_query\")(\"select * from door_pass_log where spaceId = ? and passTime < ? order by passTime ASC limit 50000\", [spaceId, checkTime])\nfor (let i = 0; i < door_pass_logs.length; i++){\n    let d = door_pass_logs[i]\n    let values = [d.spaceId, d.platform, d.personName, d.personId, d.personType, d.personPhone, d.personEmail, d.personEmpNo, d.passDirection, d.serviceId, d.serviceName, d.doorId, d.doorName, d.passType, d.faceUrl, d.cardNum, d.passTime, d.passTimeStr]\n    await global.get(\"mysql_query\")('insert into door_pass_final_log (spaceId, platform, personName, personId, personType, personPhone, personEmail, personEmpNo, passDirection, serviceId, serviceName, doorId, doorName, passType, faceUrl, cardNum, passTime, passTimeStr) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n\n    await global.get(\"mysql_query\")(\"delete from door_pass_log where id = ? limit 1\", [d.id])\n}\nmsg.checkTime = checkTime\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 1920,
        "wires": [
            [
                "118198c392d5958b"
            ]
        ]
    },
    {
        "id": "118198c392d5958b",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 339",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 1920,
        "wires": []
    },
    {
        "id": "17aaa37065e2c677",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "杭州湾通行定时处理通行日志记录",
        "props": [],
        "repeat": "",
        "crontab": "30 01 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 500,
        "y": 1920,
        "wires": [
            [
                "7bcbd50bdb8c1ea7"
            ]
        ]
    },
    {
        "id": "0a660eaca4f890bd",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "电量告警处理",
        "func": "let spaceId = flow.get(\"spaceId\")\nif (!spaceId) {\n    return\n}\nif(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let device = devices[i]\n        if (device && device.status && device.status.online == 1 && device.status.charge != undefined) {\n            let charge = parseInt(device.status.charge)\n            let chargeLowerLimit = 20\n            if (charge >= chargeLowerLimit){\n                continue\n            }\n            let type = \"\" //设备类型报警\n            let typeName = \"\"\n            let deviceID = device.id\n            let deviceName = device.name\n            let deviceAddress = \"\"\n            let deviceFullName = \"/\" + device.spaceCode + \"/\" + device.areaCode + \"/\" + device.floorCode + \"/\" + device.floorAreaCode + \"/\" + device.name\n            let alarmCode = \"\"\n            let alarmMsg = \"\"\n            let baseUnit = \"\"\n            let baseValue = \"\"\n            let realValue = \"\"\n            let createTime = parseInt(new Date().getTime() / 1000)\n            let updateTime = createTime\n            type = \"1\" //设备类型报警\n            typeName = \"设备告警\"\n            deviceAddress = \"charge\"\n            alarmCode = \"\"\n            alarmMsg = \"设备电量低于\" + chargeLowerLimit + \"%异常\"\n            \n            if(!spaceId || !deviceID || !deviceAddress){\n                return\n            }\n\n            //记录告警日志\n            let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime]\n            await global.get(\"mysql_query\")(\"insert into system_alarm (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n\n            //推送日志信息到TD\n            let data = {}\n            data.ts = new Date().getTime()\n            data.position = deviceFullName\n            data.space = device.spaceCode\n            data.floor_area = device.areaCode\n            data.floor = device.floorCode\n            data.area = device.floorAreaCode\n            data.device_code = device.code\n            data.device_id = device.id\n            data.type = type\n            data.type_name = typeName\n            data.device_address = deviceAddress\n            data.alarm_code = alarmCode\n            data.alarm_msg = alarmMsg\n            data.base_unit = baseUnit\n            data.base_value = baseValue\n            data.real_value = realValue\n            let newMsg = {}\n            newMsg.payload = data\n            node.send(newMsg)\n\n            //记录告警数据源\n            let system_alarm_sources = await global.get(\"mysql_query\")(\"select * from system_alarm_source where spaceId = ? and deviceID = ? and `status` = 0 and deviceAddress = ? limit 1\", [spaceId, device.id, deviceAddress])\n            if (system_alarm_sources[0] == undefined) {\n                let values = [spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime]\n                await global.get(\"mysql_query\")(\"insert into system_alarm_source (spaceId, type, typeName, deviceID, deviceName, deviceAddress, deviceFullName, alarmCode, alarmMsg, baseUnit, baseValue, realValue, createTime, updateTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", values)\n            } else {\n                await global.get(\"mysql_query\")(\"update system_alarm_source set updateTime = ? where id = ? limit 1\", [updateTime, system_alarm_sources[0].id])\n            }\n        }\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "CryptoJS",
                "module": "crypto-js"
            },
            {
                "var": "WebSocket",
                "module": "ws"
            },
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 2600,
        "wires": [
            [
                "2d7c07d2545ed97d",
                "912353253aa5ac94"
            ]
        ]
    },
    {
        "id": "ba2e98cdfc628149",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "水浸数据接收",
        "topic": "/iot/status/inundationsensor/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 490,
        "y": 2620,
        "wires": [
            [
                "0a660eaca4f890bd",
                "53d011bffe4206aa"
            ]
        ]
    },
    {
        "id": "c12b2bcef164f333",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "推送到监控终端",
        "topic": "/emergent/status/security/message",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1000,
        "y": 2640,
        "wires": []
    },
    {
        "id": "2d7c07d2545ed97d",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 362",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 2560,
        "wires": []
    },
    {
        "id": "53d011bffe4206aa",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "漏水安防告警",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let device = devices[i]\n        if (device && device.status && device.status.online == 1 && device.status.alarm == \"alarm\" && device.status.alarmValue > 0) {\n            let data = iot_devices[0]\n            let uuid = flow.get(\"uuid\")()\n            let spaceCode = data.spaceCode ? data.spaceCode : \"\"\n            let floorAreaCode = data.areaCode ? data.areaCode : \"\"\n            let floorCode = data.floorCode ? data.floorCode : \"\"\n            let areaCode = data.floorAreaCode ? data.floorAreaCode : \"\"\n            let sourceName = data.name ? data.name : \"\"\n            let classify = \"security\"\n            let classifyName = \"安防告警\"\n            let emergentType = \"漏水告警\"\n            let floorCodeNum = parseInt(floorCode)\n            let floorName = floorCode\n            if (floorCodeNum) {\n                floorName = floorCodeNum + \"楼\"\n            }\n            let emergentContent = \"请注意\" + floorName + sourceName + \"产生漏水告警，请立即前往！\"\n            let voiceText = emergentContent \n            let voiceUrl = \"\"\n            let happenDate = moment().format(\"YYYY-MM-DD\")\n            let happenTime = moment().format(\"YYYY-MM-DD HH:mm:ss\")\n            let createTime = parseInt(new Date().getTime() / 1000)\n            let values = [uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime]\n            \n            let system_emergents = await global.get(\"mysql_query\")(\"select * from system_emergent where spaceCode = ? and floorAreaCode = ? and floorCode = ? and areaCode = ? and sourceName = ? and classify = ? and emergentType = ? and status != 2 and status != 3 limit 1\", [spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, emergentType])\n            if(system_emergents[0] == undefined){\n                await global.get(\"mysql_query\")('insert into system_emergent (uuid, spaceCode, floorAreaCode, floorCode, areaCode, sourceName, classify, classifyName, emergentType, emergentContent, voiceText, voiceUrl, happenDate, happenTime, createTime) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', values)\n                //推送终端\n                let pushMsg = {}\n                pushMsg.payload = {\n                    uuid:uuid,\n                    spaceCode: spaceCode,\n                    floorAreaCode: floorAreaCode,\n                    floorCode: floorCode,\n                    areaCode: areaCode,\n                    sourceName: sourceName,\n                    happenTime:happenTime,\n                    message:emergentContent\n                }\n                node.send(pushMsg)\n            }\n            \n        }\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "CryptoJS",
                "module": "crypto-js"
            },
            {
                "var": "WebSocket",
                "module": "ws"
            },
            {
                "var": "fs",
                "module": "fs"
            },
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 2640,
        "wires": [
            [
                "2d7c07d2545ed97d",
                "c12b2bcef164f333"
            ]
        ]
    },
    {
        "id": "912353253aa5ac94",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "告警数据推送至TD引擎",
        "topic": "/iot/systemalarm/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1030,
        "y": 2600,
        "wires": []
    },
    {
        "id": "86b93bd3d7f11299",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 363",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 430,
        "y": 420,
        "wires": []
    },
    {
        "id": "19c80d5f2019d7d2",
        "type": "http request",
        "z": "f788b38babc60666",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://10.205.66.36:6041/rest/sql",
        "tls": "",
        "persist": true,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "basic",
        "senderr": false,
        "headers": [],
        "x": 640,
        "y": 2980,
        "wires": [
            [
                "589b1b15fc509453"
            ]
        ]
    },
    {
        "id": "40cb46ba64264c51",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "请求参数",
        "func": "let todayDate = moment().format(\"YYYY-MM-DD\")\nmsg.payload = \"SELECT space,floor_area, floor, area, device_id, position, SUM(status) as status FROM  `bxserver`.wcsensor where space = 'HGH-WC'  and ts >= TO_UNIXTIMESTAMP('\" + todayDate +\" 09:30:00') and ts <= TO_UNIXTIMESTAMP('\"+todayDate+\" 11:30:00') group by space,floor_area,floor,area,device_id, position order by floor asc;\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 2980,
        "wires": [
            [
                "19c80d5f2019d7d2"
            ]
        ]
    },
    {
        "id": "d27afe195ec928d8",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 365",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 2940,
        "wires": []
    },
    {
        "id": "589b1b15fc509453",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "处理返回数据",
        "func": "let res = msg.payload\nif(res.code == 0 && res.column_meta && res.data){\n    let items = res.data\n    let column = res.column_meta\n    let result = []\n    for(let i = 0 ;i < items.length; i++) {\n        let item = {}\n        for(let j = 0 ;j < items[i].length; j++) {\n            if(column[j] && column[j][0]){\n                item[column[j][0]] = items[i][j]\n            }\n        }\n        result.push(item)\n    }\n    let nobodySensors = []\n    for(let i = 0; i < result.length; i++){\n        if(result[i].status > 0){\n            continue\n        }\n        nobodySensors.push(result[i])\n    }\n    let newMsg = {}\n    newMsg.payload = nobodySensors\n    return newMsg\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 840,
        "y": 2980,
        "wires": [
            [
                "d27afe195ec928d8",
                "afa83bbf04c3af28"
            ]
        ]
    },
    {
        "id": "afa83bbf04c3af28",
        "type": "mqtt out",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/wcsensor/nobody/result",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1140,
        "y": 2980,
        "wires": []
    },
    {
        "id": "643c593911fc742b",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "",
        "topic": "/iot/wcsensor/nobody/get",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 230,
        "y": 2980,
        "wires": [
            [
                "40cb46ba64264c51"
            ]
        ]
    },
    {
        "id": "551a04818510d09b",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 320,
        "y": 2900,
        "wires": [
            [
                "40cb46ba64264c51"
            ]
        ]
    },
    {
        "id": "38ce12f60cd74f50",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 368",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 2320,
        "wires": []
    },
    {
        "id": "f58e7c6db1a1f27a",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 369",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 2400,
        "wires": []
    },
    {
        "id": "90f9c4152c58de3d",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "00:00清理离职人员派梯权限",
        "props": [],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 520,
        "y": 3100,
        "wires": [
            [
                "16d975fd1af213a4"
            ]
        ]
    },
    {
        "id": "16d975fd1af213a4",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let users = await global.get(\"mysql_query\")(\"select * from user as u INNER JOIN user_elevator_auth_floor as f where u.userId = f.userId and (u.userStatus = 1 or u.deleteFlag = 0)\")\nfor (let i = 0; i < users.length; i++){\n    let userId = users[i].userId\n    await global.get(\"mysql_query\")(\"delete from user_elevator_auth_floor where userId = ?\", [userId])\n}\nmsg.users = users\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 3100,
        "wires": [
            [
                "c73c5eccd7941f05"
            ]
        ]
    },
    {
        "id": "c73c5eccd7941f05",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 370",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 3100,
        "wires": []
    },
    {
        "id": "723c174211da185c",
        "type": "inject",
        "z": "f788b38babc60666",
        "name": "00:00清理离职人员楼层权限",
        "props": [],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 520,
        "y": 3140,
        "wires": [
            [
                "6009a1e8c7ec622d"
            ]
        ]
    },
    {
        "id": "6009a1e8c7ec622d",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "清理数据",
        "func": "let users = await global.get(\"mysql_query\")(\"select * from user as u INNER JOIN user_door_auth_group as f where u.userId = f.userId and (u.userStatus = 1 or u.deleteFlag = 0)\")\nfor (let i = 0; i < users.length; i++){\n    let userId = users[i].userId\n    await global.get(\"mysql_query\")(\"delete from user_door_auth_group where userId = ?\", [userId])\n}\nmsg.users = users\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 760,
        "y": 3140,
        "wires": [
            [
                "07d0937d68717cab"
            ]
        ]
    },
    {
        "id": "07d0937d68717cab",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 371",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1010,
        "y": 3140,
        "wires": []
    },
    {
        "id": "67857d81289aba39",
        "type": "mqtt in",
        "z": "f788b38babc60666",
        "name": "边缘网关状态数据接收",
        "topic": "/iot/status/edgegateway/HGH-WC/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 440,
        "y": 1500,
        "wires": [
            [
                "e0d7c8ce82e46e89"
            ]
        ]
    },
    {
        "id": "e0d7c8ce82e46e89",
        "type": "function",
        "z": "f788b38babc60666",
        "name": "存储数据库",
        "func": "let items = msg.payload\nif (items && Array.isArray(items) && items.length > 0){\n    for (let i = 0; i < items.length; i++){\n        let item = items[i]\n        if (!item.gateway || !item.layer){\n            continue;\n        }\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", item.gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, item.layer, item.code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n\n        if(item.padStatus != undefined){\n            item.status.padStatus = item.padStatus\n        }\n\n        let status = JSON.stringify(item.status)\n        let statusUptime = parseInt(new Date().getTime()/1000)\n        await global.get(\"mysql_query\")(\"update iot_device set status = ? ,statusUptime = ? where id = ? limit 1\", [status, statusUptime, iot_devices[0].id])\n    }\n}\nreturn msg",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 710,
        "y": 1500,
        "wires": [
            [
                "290f0912b849aa51"
            ]
        ]
    },
    {
        "id": "290f0912b849aa51",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 372",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 1500,
        "wires": []
    },
    {
        "id": "197d3e8280ce9351",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 439",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 220,
        "wires": []
    },
    {
        "id": "fe16a81a48a2ab02",
        "type": "http request",
        "z": "f788b38babc60666",
        "d": true,
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://10.205.66.4/openapi/sence/getSenceJsonNoAuth.do",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 860,
        "y": 40,
        "wires": [
            [
                "676979934d0b81c6"
            ]
        ]
    },
    {
        "id": "2e09f13278c3366d",
        "type": "inject",
        "z": "f788b38babc60666",
        "d": true,
        "name": "30分钟更新策略配置",
        "props": [],
        "repeat": "1800",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "x": 440,
        "y": 40,
        "wires": [
            [
                "4b8a676c445594a6"
            ]
        ]
    },
    {
        "id": "676979934d0b81c6",
        "type": "function",
        "z": "f788b38babc60666",
        "d": true,
        "name": "缓存配置",
        "func": "if(msg.payload && msg.payload.code == \"200\" && msg.payload.data && msg.payload.data.actionData){\n    let data = {}\n    data.actionData = msg.payload.data.actionData\n    let policys = data\n    if (!policys['actionData'] || !Array.isArray(policys['actionData'])) {\n        return\n    }\n    let actionData = policys['actionData']\n    let alarmConfig = {}\n    for (let i = 0; i < actionData.length; i++) {\n        let item1 = actionData[i]\n        if (!item1.action) {\n            continue\n        }\n        let itemAction = item1.action\n        for (let j = 0; j < itemAction.length; j++) {\n            let item = itemAction[j]\n            if (item.senceType != \"alerm\" || !item.action || !item.action.conditions || !Array.isArray(item.action.conditions)) {\n                continue\n            }\n            // node.error(item)\n            if (!item.realadress || !Array.isArray(item.realadress)) {\n                continue\n            }\n            let dayType = item.dayType\n            let startTime = \"00:00\"\n            let endTime = \"23:59\"\n            if (item.startTime) {\n                startTime = item.startTime\n            }\n            if (item.endTime) {\n                endTime = item.endTime\n            }\n            let temperature_low = false//18\n            let temperature_high = false//27\n            let pm25_high = false//75\n            let co2_high = false//1000\n            let tvoc_high = false//0.6\n            let conditions = item.action.conditions\n            for (let k = 0; k < conditions.length; k++) {\n                let c = conditions[k]\n                if (c.condition == \"<\" && c.temperature != undefined) {\n                    temperature_low = c.temperature\n                } else if (c.condition == \">\" && c.temperature != undefined) {\n                    temperature_high = c.temperature\n                } else if (c.condition == \">\" && c.type == \"pm2.5\") {\n                    pm25_high = c.value\n                } else if (c.condition == \">\" && c.type == \"co2\") {\n                    co2_high = c.value\n                } else if (c.condition == \">\" && c.type == \"TVOC\") {\n                    tvoc_high = c.value\n                }\n            }\n\n            let areas = item.realadress\n            for (let m = 0; m < areas.length; m++) {\n                let a = areas[m]\n                if (!a.spaceCode || !a.floorAreaCode || !a.floorCode || !a.areaCode) {\n                    continue\n                }\n                if (alarmConfig[a.spaceCode] == undefined) {\n                    alarmConfig[a.spaceCode] = {}\n                }\n                if (alarmConfig[a.spaceCode][a.floorAreaCode] == undefined) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode] = {}\n                }\n                if (alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode] == undefined) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode] = {}\n                }\n                if (alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode] == undefined) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode] = {}\n                }\n                if (alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType] == undefined) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType] = {}\n                }\n                alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['startTime'] = startTime\n                alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['endTime'] = endTime\n                if (temperature_low) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['temperature_low'] = temperature_low\n                }\n                if (temperature_high) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['temperature_high'] = temperature_high\n                }\n                if (pm25_high) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['pm25_high'] = pm25_high\n                }\n                if (co2_high) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['co2_high'] = co2_high\n                }\n                if (tvoc_high) {\n                    alarmConfig[a.spaceCode][a.floorAreaCode][a.floorCode][a.areaCode][dayType]['tvoc_high'] = tvoc_high\n                }\n            }\n\n        }\n    }\n    flow.set(\"alarmConfig\", alarmConfig)\n    msg.config = alarmConfig\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1050,
        "y": 40,
        "wires": [
            [
                "a5d2b38f7256634a"
            ]
        ]
    },
    {
        "id": "a5d2b38f7256634a",
        "type": "debug",
        "z": "f788b38babc60666",
        "d": true,
        "name": "debug 431",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 40,
        "wires": []
    },
    {
        "id": "4b8a676c445594a6",
        "type": "function",
        "z": "f788b38babc60666",
        "d": true,
        "name": "请求参数",
        "func": "msg.payload = {\n    \"spaceCode\":flow.get(\"spaceCode\")\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 40,
        "wires": [
            [
                "fe16a81a48a2ab02"
            ]
        ]
    },
    {
        "id": "82c3952f7ecba5d7",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 444",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 2400,
        "wires": []
    },
    {
        "id": "7bb6379a39fe0ae3",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 445",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 2320,
        "wires": []
    },
    {
        "id": "8972d5aa090acba1",
        "type": "http request",
        "z": "f788b38babc60666",
        "d": true,
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://10.205.66.4/openapi/sence/getSenceDayJsonNoAuth.do",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1940,
        "y": 40,
        "wires": [
            [
                "3700deca9a057932"
            ]
        ]
    },
    {
        "id": "21886e9d155aee0a",
        "type": "inject",
        "z": "f788b38babc60666",
        "d": true,
        "name": "30分钟更新策略配置",
        "props": [],
        "repeat": "1800",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "x": 1520,
        "y": 40,
        "wires": [
            [
                "fea630af46bddb43"
            ]
        ]
    },
    {
        "id": "3700deca9a057932",
        "type": "function",
        "z": "f788b38babc60666",
        "d": true,
        "name": "缓存配置",
        "func": "if (msg.payload && msg.payload.code == \"200\" && msg.payload.data && Array.isArray(msg.payload.data)) {\n    let senceDayObj = {}\n    let arr = msg.payload.data\n    for (let i = 0; i < arr.length; i++) {\n        let a = arr[i]\n        senceDayObj[a.year] = {}\n        senceDayObj[a.year][\"workday\"] = a.workday\n        senceDayObj[a.year][\"holiday\"] = a.holiday\n    }\n    flow.set(\"senceDay\", senceDayObj)\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2130,
        "y": 40,
        "wires": [
            [
                "0c097cf8cebd22ad"
            ]
        ]
    },
    {
        "id": "0c097cf8cebd22ad",
        "type": "debug",
        "z": "f788b38babc60666",
        "d": true,
        "name": "debug 446",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2330,
        "y": 40,
        "wires": []
    },
    {
        "id": "fea630af46bddb43",
        "type": "function",
        "z": "f788b38babc60666",
        "d": true,
        "name": "请求参数",
        "func": "msg.payload = {\n    \"spaceCode\":flow.get(\"spaceCode\")\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 40,
        "wires": [
            [
                "8972d5aa090acba1"
            ]
        ]
    },
    {
        "id": "d8c6c1945d9c988c",
        "type": "debug",
        "z": "f788b38babc60666",
        "name": "debug 3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1160,
        "y": 340,
        "wires": []
    },
    {
        "id": "13db534658d050a0",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "空气数据存入时序数据库",
        "topic": "/iot/airsensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 230,
        "y": 140,
        "wires": [
            [
                "34592d52e426178d"
            ]
        ]
    },
    {
        "id": "34592d52e426178d",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_airsensor(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 140,
        "wires": [
            [
                "da7e0aa59eef14ad"
            ]
        ]
    },
    {
        "id": "da7e0aa59eef14ad",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 4",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 140,
        "wires": []
    },
    {
        "id": "1691e995c8b42cca",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "告警数据存入时序数据库",
        "topic": "/iot/systemalarm/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 230,
        "y": 240,
        "wires": [
            [
                "9f0182855e44f9d8"
            ]
        ]
    },
    {
        "id": "9f0182855e44f9d8",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_systemalarm(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 240,
        "wires": [
            [
                "56d6cd73783df6fe"
            ]
        ]
    },
    {
        "id": "56d6cd73783df6fe",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 5",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 240,
        "wires": []
    },
    {
        "id": "e58f95f4b3e13a12",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "卫生间传感器数据存入时序数据库",
        "topic": "/iot/wcsensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 210,
        "y": 340,
        "wires": [
            [
                "516c36955adbc8cf"
            ]
        ]
    },
    {
        "id": "516c36955adbc8cf",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_wcsensor(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 340,
        "wires": [
            [
                "472687aa1041babe"
            ]
        ]
    },
    {
        "id": "472687aa1041babe",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 340,
        "wires": []
    },
    {
        "id": "0ce96939c4ceee11",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "电量传感器数据存入时序数据库",
        "topic": "/iot/powersensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 210,
        "y": 440,
        "wires": [
            [
                "3cc0561e9fe27814"
            ]
        ]
    },
    {
        "id": "3cc0561e9fe27814",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_powersensor(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 440,
        "wires": [
            [
                "f77588b5f4f00a46"
            ]
        ]
    },
    {
        "id": "f77588b5f4f00a46",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 7",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 440,
        "wires": []
    },
    {
        "id": "c6112d8f32b44f5a",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "人体传感器数据存入时序数据库",
        "topic": "/iot/humensensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 210,
        "y": 540,
        "wires": [
            [
                "1dcf6cb4f2b5dc12"
            ]
        ]
    },
    {
        "id": "1dcf6cb4f2b5dc12",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_humensensor(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 540,
        "wires": [
            [
                "7a68c3c45f5442f5"
            ]
        ]
    },
    {
        "id": "7a68c3c45f5442f5",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 8",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 540,
        "wires": []
    },
    {
        "id": "90e9dde495796cd2",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "烟雾传感器数据存入时序数据库",
        "topic": "/iot/smokesensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 210,
        "y": 640,
        "wires": [
            [
                "212a21980619515f"
            ]
        ]
    },
    {
        "id": "212a21980619515f",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_smokesensor(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 640,
        "wires": [
            [
                "31811690e1d6a534"
            ]
        ]
    },
    {
        "id": "31811690e1d6a534",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 9",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 640,
        "wires": []
    },
    {
        "id": "44e235c1db493238",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "门牌数据存入时序数据库",
        "topic": "/iot/pad/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 230,
        "y": 740,
        "wires": [
            [
                "7713a8000f519db6"
            ]
        ]
    },
    {
        "id": "7713a8000f519db6",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_pad(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 740,
        "wires": [
            [
                "3ecc25de9989775f"
            ]
        ]
    },
    {
        "id": "3ecc25de9989775f",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 10",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 740,
        "wires": []
    },
    {
        "id": "6b2eea7cbd62b34c",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "控制日志数据存入时序数据库",
        "topic": "/iot/iotcontrollog/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 240,
        "y": 840,
        "wires": [
            [
                "e56761b27171a861"
            ]
        ]
    },
    {
        "id": "e56761b27171a861",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_iot_control_log(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 840,
        "wires": [
            [
                "8ac1a1f8ffe11aa6"
            ]
        ]
    },
    {
        "id": "8ac1a1f8ffe11aa6",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 11",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 840,
        "wires": []
    },
    {
        "id": "15a74f19b484ac8c",
        "type": "mqtt in",
        "z": "900ba3388f213e1f",
        "name": "电量数据（分回路类型）存入时序数据库",
        "topic": "/iot/powersensor_loop/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 200,
        "y": 940,
        "wires": [
            [
                "b5e3decf09c7c639"
            ]
        ]
    },
    {
        "id": "b5e3decf09c7c639",
        "type": "function",
        "z": "900ba3388f213e1f",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\nawait global.get(\"mysql_query\")('insert into  tsh_powesensor_loop(' + keys + ') values ('+zw+')', values)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 460,
        "y": 940,
        "wires": [
            [
                "29bde0510abe9a96"
            ]
        ]
    },
    {
        "id": "29bde0510abe9a96",
        "type": "debug",
        "z": "900ba3388f213e1f",
        "name": "debug 12",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 940,
        "wires": []
    },
    {
        "id": "4f7e39545e19c8ac",
        "type": "mqtt in",
        "z": "8042f0ad90564885",
        "name": "",
        "topic": "/iot/status/milesight/aicamera",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 380,
        "y": 320,
        "wires": [
            [
                "531b2cb3c9deea7f",
                "fb3ac87a26a50254"
            ]
        ]
    },
    {
        "id": "531b2cb3c9deea7f",
        "type": "function",
        "z": "8042f0ad90564885",
        "name": "数据处理",
        "func": "let data = msg.payload\nif (data && data.device_info && data.current_total != undefined){\n    let cameraCode = data.device_info.device_sn\n    let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where type = 'aicamerasensor' and code = ? limit 1\", [cameraCode])\n    if(iot_devices[0] == undefined){\n        return null\n    }\n    let iot_gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where id = ? limit 1\", [iot_devices[0].gatewayID])\n    if (iot_gateways[0] == undefined) {\n        return null\n    }\n    //上一次状态\n    let status = flow.get(\"jsJson\")(iot_devices[0].status)\n    if(!status){\n        status = {}\n    }\n    status.online = 1\n    status.status = \"on\"\n    status.densitycount = data.current_total\n    status.densitycountUpdateTime = parseInt(new Date().getTime()/1000)\n    status.densitycountSourceImg = \"\"\n    let statusUptime = parseInt(new Date().getTime()/1000)\n    let statusStr = JSON.stringify(status)\n    await global.get(\"mysql_query\")(\"update iot_device set status = ? ,statusUptime = ? where id = ? limit 1\", [statusStr, statusUptime, iot_devices[0].id])\n\n    let newMsg = {}\n    let prepayload = iot_devices[0]\n    newMsg.topic = \"/iot/status/\" + prepayload.type + \"/\" + prepayload.spaceCode + \"/\" + prepayload.areaCode + \"/\" + prepayload.floorCode + \"/\" + prepayload.floorAreaCode + \"/\" + prepayload.name\n    let finalData = {}\n    finalData.gateway = iot_gateways[0].macaddr\n    finalData.layer = prepayload.layer\n    finalData.code = prepayload.code\n    finalData.status = status\n    newMsg.payload = [finalData]\n    node.send(newMsg)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 320,
        "wires": [
            [
                "95bb2cad30b84706",
                "7b5f9e3d424c9dfc"
            ]
        ]
    },
    {
        "id": "44badab9adb58dfc",
        "type": "debug",
        "z": "8042f0ad90564885",
        "name": "debug 447",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1150,
        "y": 360,
        "wires": []
    },
    {
        "id": "9c2ce13ccc8baf7a",
        "type": "mqtt out",
        "z": "8042f0ad90564885",
        "name": "",
        "topic": "/iot/aicamerasensor_densitycount/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1230,
        "y": 320,
        "wires": []
    },
    {
        "id": "95bb2cad30b84706",
        "type": "function",
        "z": "8042f0ad90564885",
        "name": "人密数据推送至TD引擎",
        "func": "if(msg.payload && Array.isArray(msg.payload)){\n    let devices = msg.payload\n    for(let i = 0; i < devices.length; i++){\n        let gateways = await global.get(\"mysql_query\")(\"select * from iot_gateway where macaddr = ? limit 1\", devices[i].gateway)\n        if(gateways[0] == undefined){\n            continue;\n        }\n        let iot_devices = await global.get(\"mysql_query\")(\"select * from iot_device where gatewayID = ? and layer = ? and code = ? limit 1\", [gateways[0].id, devices[i].layer, devices[i].code])\n        if(iot_devices[0] == undefined){\n            continue;\n        }\n        let status = devices[i].status\n        if(!status){\n            continue\n        }\n        if(status.densitycount == undefined){\n            continue\n        }\n        let data = {}\n        data.ts = new Date().getTime()\n        data.position = \"/\" + iot_devices[0].spaceCode + \"/\" + iot_devices[0].areaCode + \"/\" + iot_devices[0].floorCode + \"/\" + iot_devices[0].floorAreaCode +\"/\" + iot_devices[0].name\n        data.space = iot_devices[0].spaceCode\n        data.floor_area = iot_devices[0].areaCode\n        data.floor = iot_devices[0].floorCode\n        data.area = iot_devices[0].floorAreaCode\n        data.device_code = iot_devices[0].code\n        data.device_id = iot_devices[0].id\n        data.people_count = parseInt(status.densitycount)\n        data.img_url = status.densitycountSourceImg\n        let newMsg = {}\n        newMsg.payload = data\n        node.send(newMsg)\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 890,
        "y": 320,
        "wires": [
            [
                "9c2ce13ccc8baf7a",
                "44badab9adb58dfc"
            ]
        ]
    },
    {
        "id": "19a9bf8348296565",
        "type": "function",
        "z": "8042f0ad90564885",
        "name": "初始化信息",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// 部署节点后，此处添加的代码将运行一次。 \nlet jsJson = function(str){\n    try {\n        return JSON.parse(str)   \n    } catch (error) {\n        return {}\n    }\n}\nflow.set(\"jsJson\", jsJson)\n\n\nlet randomString = function (length) {\n    let chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'\n    var result = '';\n    for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];\n    return result;\n}\nflow.set(\"randomString\", randomString)\n\nlet uuid = function () {\n    return md5(randomString(32));\n}\nflow.set(\"uuid\", uuid)",
        "finalize": "",
        "libs": [
            {
                "var": "md5",
                "module": "md5"
            }
        ],
        "x": 370,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "7b5f9e3d424c9dfc",
        "type": "mqtt out",
        "z": "8042f0ad90564885",
        "name": "发布每个设备状态信息",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 880,
        "y": 280,
        "wires": []
    },
    {
        "id": "fb3ac87a26a50254",
        "type": "debug",
        "z": "8042f0ad90564885",
        "name": "debug 448",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 240,
        "wires": []
    },
    {
        "id": "f7b428ec220bda3c",
        "type": "inject",
        "z": "394aac3a21e63bca",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 240,
        "wires": [
            [
                "7551db8ce089038a"
            ]
        ]
    },
    {
        "id": "6e57d37157ca3a85",
        "type": "join",
        "z": "394aac3a21e63bca",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "10",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1010,
        "y": 400,
        "wires": [
            [
                "fca2a32aab17f814",
                "f9b42b4dfcb331ea",
                "d8ad39c83157875c"
            ]
        ]
    },
    {
        "id": "404c93034d3e2944",
        "type": "change",
        "z": "394aac3a21e63bca",
        "name": "humidity",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "humidity",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 680,
        "y": 440,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "dd230d41771f8767",
        "type": "change",
        "z": "394aac3a21e63bca",
        "name": "today",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "today",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 500,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "1eb762807c4f90bb",
        "type": "change",
        "z": "394aac3a21e63bca",
        "name": "aqi",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "AIQ",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 560,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "4a25c79b30f79441",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "updateTime",
        "func": "msg.payload = msg.payload.current.pubTime;\nmsg.topic = \"updateTime\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 280,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "223f4602a7661dfb",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "suggest",
        "func": "msg.payload = msg.payload.aqi.suggest;\nmsg.topic = \"suggest\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 340,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "c451c0717d02f143",
        "type": "change",
        "z": "394aac3a21e63bca",
        "name": "temperature",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "temperature",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 380,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "fca2a32aab17f814",
        "type": "mqtt out",
        "z": "394aac3a21e63bca",
        "name": "",
        "topic": "/wallpad/outside",
        "qos": "2",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1040,
        "y": 680,
        "wires": []
    },
    {
        "id": "6d9a9f99d2a387e3",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "pm25",
        "func": "msg.payload = msg.payload.aqi.pm25;\nmsg.topic = \"pm25\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 200,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "6dbb8832af4e1f77",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "wind",
        "func": "msg.payload = msg.payload.current.wind.speed.value;\nmsg.topic = \"wind\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 140,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "3a67f0e913ce9f03",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "temperatureNum",
        "func": "msg.payload = msg.payload.current.temperature.value;\nmsg.topic = \"temperatureNum\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 620,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "c54a9ef45a897844",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "humidityNum",
        "func": "msg.payload = msg.payload.current.humidity.value;\nmsg.topic = \"humidityNum\"\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 660,
        "wires": [
            [
                "6e57d37157ca3a85"
            ]
        ]
    },
    {
        "id": "7551db8ce089038a",
        "type": "weather",
        "z": "394aac3a21e63bca",
        "name": "四川成都电子科技大学科技园",
        "longitude": "104.02",
        "latitude": "30.48",
        "x": 320,
        "y": 380,
        "wires": [
            [
                "4a25c79b30f79441",
                "223f4602a7661dfb",
                "6d9a9f99d2a387e3",
                "6dbb8832af4e1f77",
                "c54a9ef45a897844",
                "3a67f0e913ce9f03"
            ],
            [
                "c451c0717d02f143"
            ],
            [
                "404c93034d3e2944"
            ],
            [
                "dd230d41771f8767"
            ],
            [
                "1eb762807c4f90bb"
            ],
            [],
            []
        ]
    },
    {
        "id": "f9b42b4dfcb331ea",
        "type": "debug",
        "z": "394aac3a21e63bca",
        "name": "debug 254",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 180,
        "wires": []
    },
    {
        "id": "87ead88ccbe59bc4",
        "type": "mqtt out",
        "z": "394aac3a21e63bca",
        "name": "",
        "topic": "/iot/weather/data/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1250,
        "y": 460,
        "wires": []
    },
    {
        "id": "d8ad39c83157875c",
        "type": "function",
        "z": "394aac3a21e63bca",
        "name": "TD数据处理",
        "func": "let w = msg.payload\nif(w.temperatureNum != undefined){\n    let data = {}\n    data.ts = new Date().getTime()\n    data.space = \"JQDS\"\n    data.pm25 = parseInt(w.pm25)\n    data.wind = parseFloat(w.wind)\n    data.humidity = parseInt(w.humidityNum)\n    data.temperature = parseFloat(w.temperatureNum)\n    data.weather = w.today\n    data.aiq = w.AIQ\n    let newMsg = {}\n    newMsg.payload = data\n    node.send(newMsg)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 400,
        "wires": [
            [
                "87ead88ccbe59bc4",
                "f9b42b4dfcb331ea"
            ]
        ]
    },
    {
        "id": "87e7cf46346a00ed",
        "type": "lifesmart out",
        "z": "53d9bed59d4906b4",
        "name": "公共指令发送",
        "addr": "",
        "iface": "",
        "port": "",
        "ipv": "udp4",
        "outport": "8888",
        "base64": false,
        "multicast": "false",
        "x": 700,
        "y": 200,
        "wires": []
    },
    {
        "id": "f786381e280b201a",
        "type": "lifesmart in",
        "z": "53d9bed59d4906b4",
        "name": "公共数据接收",
        "iface": "",
        "port": "8888",
        "ipv": "udp4",
        "multicast": "false",
        "group": "",
        "datatype": "utf8",
        "x": 870,
        "y": 200,
        "wires": [
            [
                "65721d5af5c41e6a"
            ]
        ]
    },
    {
        "id": "65721d5af5c41e6a",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "处理接收信息",
        "func": "let data = JSON.parse(msg.payload)\nlet msgArr = [null, null]\n//单设备数据状态变化自动上报\nif(data.agtid && data.chg && Array.isArray(data.chg)){\n\n    //构建上报数据结构\n    let finalStatus = {}\n    let storageDevices = flow.get(\"storageDevices\")\n    let storageDevicesObj = {}\n    if (storageDevices && storageDevices[data.agtid] && storageDevices[data.agtid].layer && storageDevices[data.agtid].gateway && storageDevices[data.agtid].devices) {\n        let devices = storageDevices[data.agtid].devices\n        let gateway = storageDevices[data.agtid].gateway\n        let layer = storageDevices[data.agtid].layer\n        for (let i = 0; i < devices.length; i++) {\n            let d = devices[i]\n            d.gateway = gateway\n            d.layer = layer\n            storageDevicesObj[d.code] = d\n        }\n    }\n\n    let lifesmartDeviceStatus = flow.get(\"lifesmartDeviceStatus\")\n    if (!lifesmartDeviceStatus){\n        lifesmartDeviceStatus = {}\n    }\n    let localStatus = lifesmartDeviceStatus[data.agtid]\n    if (!localStatus || localStatus == undefined){\n        return\n    }\n    let items = data.chg\n    for(let i = 0; i < items.length; i++){\n        \n        //环境传感器\n        if (items[i].devtype == \"SL_SC_BE\"){\n            if(items[i].T){\n                localStatus[items[i].me+ \"_T\"].temperature = items[i].T.v\n            }\n            if(items[i].H){\n                localStatus[items[i].me+ \"_T\"].humidity = items[i].H.v\n            }\n            if(items[i].Z){\n                localStatus[items[i].me+ \"_T\"].light = items[i].Z.v\n            }\n            if(items[i].V){\n                localStatus[items[i].me+ \"_T\"].charge = items[i].V.v\n            }\n\n            let code = data.agtid + \"_\" + items[i].me + \"_T\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = localStatus[items[i].me+\"_T\"]\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n\n        }else if(items[i].devtype == \"SL_UACCB\"){\n            if(items[i].T){\n                localStatus[items[i].me+\"_O\"].temperature = items[i].T.v\n            }\n            if(items[i].tT){\n                localStatus[items[i].me+\"_O\"].pretemperature = items[i].tT.v\n            }\n            if(items[i].MODE){\n                localStatus[items[i].me+\"_O\"].mode = items[i].MODE.v\n            }\n            if(items[i].F){\n                if (items[i].F.v < 30){\n                    localStatus[items[i].me+\"_O\"].fan = 15\n                } else if (items[i].F.v >= 30 && items[i].F.v < 65){\n                    localStatus[items[i].me+\"_O\"].fan = 45\n                }else{\n                    localStatus[items[i].me+\"_O\"].fan = 75\n                }\n            }\n            if (items[i].O) {\n                localStatus[items[i].me+\"_O\"].status = items[i].O.v === 1 ? 'on' : 'off'\n            }\n            if (items[i].ALM) {\n                localStatus[items[i].me+\"_O\"].alarmValue = items[i].ALM.v\n                if (items[i].ALM.v === 0) {\n                    localStatus[items[i].me+\"_O\"].alarm = \"normal\"\n                } else {\n                    localStatus[items[i].me+\"_O\"].alarm = \"alarm\"\n                }\n            }\n\n            let code = data.agtid + \"_\" + items[i].me + \"_O\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = localStatus[items[i].me+\"_O\"]\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n        } else if (items[i].devtype == \"SL_SW_MJ3\" || items[i].devtype == \"SL_SW_IF3\" || items[i].devtype == \"SL_SW_IF2\" || items[i].devtype == \"SL_SW_IF1\" || items[i].devtype == \"SL_SW_RC\" || items[i].devtype == \"SL_SW_ND2\"){\n            if(items[i].L1){\n                localStatus[items[i].me + \"_L1\"].status = items[i].L1.v === 1 ? 'on' : 'off'\n                let code = data.agtid + \"_\" + items[i].me + \"_L1\"\n                if (storageDevicesObj[code]) {\n                    finalStatus[code] = {}\n                    finalStatus[code].status = localStatus[items[i].me + \"_L1\"]\n                    finalStatus[code].code = code\n                    finalStatus[code].gateway = storageDevicesObj[code].gateway\n                    finalStatus[code].layer = storageDevicesObj[code].layer\n                }\n            }\n            if (items[i].L2) {\n                localStatus[items[i].me + \"_L2\"].status = items[i].L2.v === 1 ? 'on' : 'off'\n                let code = data.agtid + \"_\" + items[i].me + \"_L2\"\n                if (storageDevicesObj[code]) {\n                    finalStatus[code] = {}\n                    finalStatus[code].status = localStatus[items[i].me + \"_L2\"]\n                    finalStatus[code].code = code\n                    finalStatus[code].gateway = storageDevicesObj[code].gateway\n                    finalStatus[code].layer = storageDevicesObj[code].layer\n                }\n            }\n            if (items[i].L3) {\n                localStatus[items[i].me + \"_L3\"].status = items[i].L3.v === 1 ? 'on' : 'off'\n                let code = data.agtid + \"_\" + items[i].me + \"_L3\"\n                if (storageDevicesObj[code]) {\n                    finalStatus[code] = {}\n                    finalStatus[code].status = localStatus[items[i].me + \"_L3\"]\n                    finalStatus[code].code = code\n                    finalStatus[code].gateway = storageDevicesObj[code].gateway\n                    finalStatus[code].layer = storageDevicesObj[code].layer\n                }\n            }\n        } else if (items[i].devtype == \"ZG#TS06012\"){\n            if (items[i].M1) {\n                localStatus[items[i].me + \"_M1\"].status = items[i].M1.v === 1 ? 'busy' : 'free'\n                let code = data.agtid + \"_\" + items[i].me + \"_M1\"\n                if (storageDevicesObj[code]) {\n                    finalStatus[code] = {}\n                    finalStatus[code].status = localStatus[items[i].me + \"_M1\"]\n                    finalStatus[code].code = code\n                    finalStatus[code].gateway = storageDevicesObj[code].gateway\n                    finalStatus[code].layer = storageDevicesObj[code].layer\n                    finalStatus[code].pushTime = parseInt(new Date().getTime() / 1000)\n                    if(storageDevicesObj[code].area){\n                        let newMsg = {}\n                        newMsg.topic = \"/iot/status/\" + storageDevicesObj[code].type + \"/\" + storageDevicesObj[code].space + \"/\" + storageDevicesObj[code].floorarea + \"/\" + storageDevicesObj[code].floor + \"/\" + storageDevicesObj[code].area.split(\"_\")[1] + \"/\" + storageDevicesObj[code].name\n                        newMsg.payload = [finalStatus[code]]\n                        let arr = [null, newMsg]\n                        node.send(arr)\n                    }\n                }\n            }\n        } else if (items[i].devtype == \"SL_SC_WA\") {\n            if (items[i].WA) {\n                localStatus[items[i].me + \"_WA\"].alarmValue = items[i].WA.v\n                if (items[i].WA.v === 0) {\n                    localStatus[items[i].me + \"_WA\"].alarm = \"normal\"\n                } else {\n                    localStatus[items[i].me + \"_WA\"].alarm = \"alarm\"\n                }\n            }\n            if (items[i].V) {\n                localStatus[items[i].me + \"_WA\"].charge = items[i].V.v\n            }\n            let code = data.agtid + \"_\" + items[i].me + \"_WA\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = localStatus[items[i].me + \"_WA\"]\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n        }\n    }\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function (code) {\n        statusSend.push(finalStatus[code])\n    });\n\n    //缓存最新状态\n    lifesmartDeviceStatus = flow.get(\"lifesmartDeviceStatus\")\n    if (!lifesmartDeviceStatus) {\n        lifesmartDeviceStatus = {}\n    }\n    lifesmartDeviceStatus[data.agtid] = localStatus\n    flow.set(\"lifesmartDeviceStatus\", lifesmartDeviceStatus)\n\n    //推送组装好的最新状态\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n\n//手动发现上报整体状态\n}else if(data.agtid && data.msg && Array.isArray(data.msg)){\n\n    //构建上报数据结构\n    let finalStatus = {}\n    let storageDevices = flow.get(\"storageDevices\")\n    let storageDevicesObj = {}\n    if (storageDevices && storageDevices[data.agtid] && storageDevices[data.agtid].layer && storageDevices[data.agtid].gateway && storageDevices[data.agtid].devices) {\n        let devices = storageDevices[data.agtid].devices\n        let gateway = storageDevices[data.agtid].gateway\n        let layer = storageDevices[data.agtid].layer\n        for (let i = 0; i < devices.length; i++) {\n            let d = devices[i]\n            d.gateway = gateway\n            d.layer = layer\n            storageDevicesObj[d.code] = d\n        }\n    }\n\n    let items = data.msg\n    let statusObj = {}\n    for(let i = 0; i < items.length; i++){\n        let d = items[i]\n        //环境传感器\n        if (d.devtype == \"SL_SC_BE\"){\n            let status = {}\n            status.status = \"on\"\n            status.online = d.stat\n            status.temperature = d.data.T.v\n            status.humidity = d.data.H.v\n            status.light = d.data.Z.v\n            status.charge = d.data.V.v\n            statusObj[d.me+\"_T\"] = status\n\n            let code = data.agtid+\"_\"+d.me+\"_T\"\n            if (storageDevicesObj[code]){\n                finalStatus[code] = {}\n                finalStatus[code].status = status\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n        //空调\n        } else if (d.devtype == \"SL_UACCB\"){\n            let status = {}\n            status.online = d.stat\n            status.temperature = d.data.T.v\n            status.pretemperature = d.data.tT.v\n            status.mode = d.data.MODE.v\n            status.modeEnum = [{\n                mode: 1,\n                name: \"自动\"\n            }, {\n                mode: 2,\n                name: \"吹风\"\n            }, {\n                mode: 3,\n                name: \"制冷\"\n            }, {\n                mode: 4,\n                name: \"制热\"\n            }, {\n                mode: 5,\n                name: \"除湿\"\n            }]\n\n            if (d.data.F.v < 30){\n                status.fan = 15\n            } else if (d.data.F.v >= 30 && d.data.F.v < 65){\n                status.fan = 45\n            }else{\n                status.fan = 75\n            }\n            status.fanEnum = [{\n                fan:15,\n                name:\"低档\"\n            }, {\n                fan: 45,\n                name: \"中档\"\n            }, {\n                fan: 75,\n                name: \"高档\"\n            }]\n\n            status.status = d.data.O.v === 1 ? 'on' : 'off'\n            status.alarmValue = d.data.ALM.v\n            if(d.data.ALM.v === 0){\n                status.alarm = \"normal\"\n            }else{\n                status.alarm = \"alarm\"\n            }\n            statusObj[d.me+\"_O\"] = status\n\n            let code = data.agtid + \"_\" + d.me + \"_O\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = status\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n        //开关\n        } else if (d.devtype == \"SL_SW_MJ3\" || d.devtype == \"SL_SW_IF3\" || items[i].devtype == \"SL_SW_IF2\" || items[i].devtype == \"SL_SW_IF1\" || d.devtype == \"SL_SW_RC\" || d.devtype == \"SL_SW_ND2\"){\n            Object.keys(d.data).forEach(function(k) {\n                let status = {}\n                status.online = d.stat\n                status.status = d.data[k].v === 1 ? 'on' : 'off'\n                statusObj[d.me+\"_\"+k] = status\n                let code = data.agtid+\"_\"+d.me+\"_\"+k\n                if (storageDevicesObj[code]){\n                    finalStatus[code] = {}\n                    finalStatus[code].status = status\n                    finalStatus[code].code = code\n                    finalStatus[code].gateway = storageDevicesObj[code].gateway\n                    finalStatus[code].layer = storageDevicesObj[code].layer\n                }\n            });\n        //人体动态感应器\n        } else if (d.devtype == \"ZG#TS06012\"){\n            let status = {}\n            status.online = d.stat\n            status.status = d.data.M1.v === 1 ? 'busy' : 'free'\n            statusObj[d.me + \"_M1\"] = status\n\n            let code = data.agtid + \"_\" + d.me + \"_M1\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = status\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n                finalStatus[code].pushTime = parseInt(new Date().getTime() / 1000)\n                if(storageDevicesObj[code].area){\n                    let newMsg = {}\n                    newMsg.topic = \"/iot/status/\" + storageDevicesObj[code].type + \"/\" + storageDevicesObj[code].space + \"/\" + storageDevicesObj[code].floorarea + \"/\" + storageDevicesObj[code].floor + \"/\" + storageDevicesObj[code].area.split(\"_\")[1] + \"/\" + storageDevicesObj[code].name\n                    newMsg.payload = [finalStatus[code]]\n                    let arr = [null, newMsg ]\n                    node.send(arr)\n                }\n            }\n        \n        //水浸传感器\n        } else if (d.devtype == \"SL_SC_WA\") {\n            let status = {}\n            status.status = \"on\"\n            status.online = d.stat\n            status.alarmValue = d.data.WA.v\n            status.charge = d.data.V.v\n            if (d.data.WA.v === 0) {\n                status.alarm = \"normal\"\n            } else {\n                status.alarm = \"alarm\"\n            }\n            statusObj[d.me + \"_WA\"] = status\n\n            let code = data.agtid + \"_\" + d.me + \"_WA\"\n            if (storageDevicesObj[code]) {\n                finalStatus[code] = {}\n                finalStatus[code].status = status\n                finalStatus[code].code = code\n                finalStatus[code].gateway = storageDevicesObj[code].gateway\n                finalStatus[code].layer = storageDevicesObj[code].layer\n            }\n        }\n    }\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function(code) {\n        statusSend.push(finalStatus[code])\n    });\n\n    //缓存最新状态\n    let lifesmartDeviceStatus = flow.get(\"lifesmartDeviceStatus\")\n    if (!lifesmartDeviceStatus){\n        lifesmartDeviceStatus = {}\n    }\n    lifesmartDeviceStatus[data.agtid] = statusObj\n    flow.set(\"lifesmartDeviceStatus\", lifesmartDeviceStatus)\n\n    //推送组装好的最新状态\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n}\n// msg.payload = data\n// msgArr[1] = msg\n// node.send(msgArr)",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 200,
        "wires": [
            [
                "d903d2f929e01914"
            ],
            [
                "9df7aa5286dc7646",
                "1f06fac8f9cfe5e2"
            ]
        ]
    },
    {
        "id": "9df7aa5286dc7646",
        "type": "debug",
        "z": "53d9bed59d4906b4",
        "name": "debug 58",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 220,
        "wires": []
    },
    {
        "id": "d903d2f929e01914",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "",
        "topic": "/iot/status/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1260,
        "y": 140,
        "wires": []
    },
    {
        "id": "1f06fac8f9cfe5e2",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "传感器自动发布单个状态",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 1310,
        "y": 260,
        "wires": []
    },
    {
        "id": "0d252dd8fc9b3586",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "AP定时上报设置",
        "func": "let apList = Object.keys(flow.get(\"apList\"))\nfor (let i = 0; i < apList.length; i++){\n    msg.ip = apList[i];\n    msg.action = \"monitor\";\n    msg.args = {\n        host: flow.get(\"apServerIp\"),\n        port: flow.get(\"apServerPort\")\n    }\n    node.send(msg)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 180,
        "wires": [
            [
                "87e7cf46346a00ed"
            ]
        ]
    },
    {
        "id": "2db61c7ef58a9c75",
        "type": "inject",
        "z": "53d9bed59d4906b4",
        "name": "",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": "1",
        "topic": "",
        "x": 170,
        "y": 180,
        "wires": [
            [
                "0d252dd8fc9b3586"
            ]
        ]
    },
    {
        "id": "e7b618814fdbb3e5",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "AP定时状态上报",
        "func": "let apList = Object.keys(flow.get(\"apList\"))\nflow.set(\"lifesmartDeviceStatus\", {})\nflow.set(\"lifesmartDeviceStatus\", {})\nfor (let i = 0; i < apList.length; i++){\n    msg.ip = apList[i];\n    msg.action = \"devices\"\n    node.send(msg)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 220,
        "wires": [
            [
                "87e7cf46346a00ed"
            ]
        ]
    },
    {
        "id": "11ba6b49cba8018a",
        "type": "inject",
        "z": "53d9bed59d4906b4",
        "name": "",
        "props": [],
        "repeat": "30",
        "crontab": "",
        "once": false,
        "onceDelay": "1",
        "topic": "",
        "x": 170,
        "y": 220,
        "wires": [
            [
                "e7b618814fdbb3e5"
            ]
        ]
    },
    {
        "id": "7c1e738a4883abec",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "过滤离线AP网关",
        "func": "let gateways = flow.get(\"gateways\")\nif (!gateways) {\n    gateways = {}\n}\nlet apList = flow.get(\"apList\")\nif (!apList) {\n    apList = {}\n}\nlet storageDevices = flow.get(\"storageDevices\")\nif (!storageDevices) {\n    storageDevices = {}\n}\n\nlet agtids = Object.keys(gateways)\nlet onlineGateway = {}\nfor (let i = 0; i < agtids.length; i++) {\n    if (!gateways[agtids[i]].ip) {\n        continue\n    }\n    onlineGateway[gateways[agtids[i]].ip] = agtids[i]\n}\n\nlet apListKeys = Object.keys(apList)\nfor (let i = 0; i < apListKeys.length; i++) {\n    let ip = apListKeys[i]\n    let area = apList[ip]\n    if (onlineGateway[ip] && storageDevices[onlineGateway[ip]] && storageDevices[onlineGateway[ip]]['devices']) {\n        continue\n    }\n    let newMsg = {}\n    newMsg.target = \"LINK_\" + area\n    node.send(newMsg)\n    await flow.get(\"sleep\")(1000)\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 260,
        "wires": [
            [
                "bc769404f4d06008",
                "1a0373318eafb89e"
            ]
        ]
    },
    {
        "id": "d113edca26f5539e",
        "type": "inject",
        "z": "53d9bed59d4906b4",
        "name": "定时检测AP在线状态",
        "props": [],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "x": 160,
        "y": 260,
        "wires": [
            [
                "7c1e738a4883abec"
            ]
        ]
    },
    {
        "id": "bc769404f4d06008",
        "type": "debug",
        "z": "53d9bed59d4906b4",
        "name": "debug 131",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 300,
        "wires": []
    },
    {
        "id": "1a0373318eafb89e",
        "type": "link call",
        "z": "53d9bed59d4906b4",
        "name": "主动发起搜索指令",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1",
        "x": 650,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "1381b6fb7e49cc56",
        "type": "modbus-getter",
        "z": "53d9bed59d4906b4",
        "name": "M1电箱设备状态查询",
        "showStatusActivities": false,
        "showErrors": true,
        "logIOActivities": false,
        "unitid": "31",
        "dataType": "HoldingRegister",
        "adr": "159",
        "quantity": "12",
        "server": "8d95443694bab17c",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "keepMsgProperties": false,
        "x": 540,
        "y": 480,
        "wires": [
            [
                "1cb94503fab1016a"
            ],
            []
        ]
    },
    {
        "id": "4ebe92d8bd9f6445",
        "type": "inject",
        "z": "53d9bed59d4906b4",
        "name": "每1分钟查询",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "67",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 320,
        "y": 480,
        "wires": [
            [
                "1381b6fb7e49cc56",
                "3887fbc15c79e553"
            ]
        ]
    },
    {
        "id": "1cb94503fab1016a",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "状态结构组装",
        "func": "let data = msg.payload\nif(data && Array.isArray(data)){\n    let code_pre = \"B-31-\"\n    let statusObj = {}\n    let rs485DeviceStatus = flow.get(\"rs485DeviceStatus\")\n    if (!rs485DeviceStatus) {\n        rs485DeviceStatus = {}\n    }\n    for (let i = 0; i < data.length; i++) {\n        let status = {}\n        status.online = 1\n        status.status = data[i] === 0 ? 'off' : 'on'\n        let idx = (i + 159) + \"\"\n        statusObj[code_pre + idx] = status\n        rs485DeviceStatus[code_pre + idx] = status\n    }\n    flow.set(\"rs485DeviceStatus\", rs485DeviceStatus)\n    let finalStatus = {}\n    let rs485Devices = flow.get(\"rs485Devices\")\n    if (!rs485Devices){\n        rs485Devices = {}\n    }\n    Object.keys(rs485Devices).forEach(function(gateway) {\n        let layerDevices = rs485Devices[gateway]\n        if (!layerDevices){\n            layerDevices = {}\n        }\n        Object.keys(layerDevices).forEach(function(layer) {\n            let devices = layerDevices[layer]\n            if (devices && Array.isArray(devices)) {\n                for (let i = 0; i < devices.length; i++){\n                    if (!statusObj[devices[i].code]){\n                        break;\n                    }\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code] = {}\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].status = statusObj[devices[i].code]\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].code = devices[i].code\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].gateway = gateway\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].layer = layer\n                    \n                    let msgArr = [null, null]\n                    let newMsg = {}\n                    newMsg.topic = \"/iot/status/\" + devices[i].type + \"/\" + devices[i].space + \"/\" + devices[i].floorarea + \"/\" + devices[i].floor + \"/\" + devices[i].area.split(\"_\")[1] + \"/\" + devices[i].name\n                    newMsg.payload = [finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code]]\n                    msgArr[1] = newMsg\n                    node.send(msgArr)\n                }\n            }\n        });\n    });\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function(code) {\n        statusSend.push(finalStatus[code])\n    });\n    let msgArr = [null, null]\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 480,
        "wires": [
            [
                "3498670a02a13cde",
                "9daac11ecafe6e1b"
            ],
            []
        ]
    },
    {
        "id": "3498670a02a13cde",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "",
        "topic": "/iot/status/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 460,
        "wires": []
    },
    {
        "id": "234306363fadecc9",
        "type": "link in",
        "z": "53d9bed59d4906b4",
        "name": "B_31_status_check",
        "links": [],
        "x": 345,
        "y": 440,
        "wires": [
            [
                "1381b6fb7e49cc56",
                "5aef54c29dbbd6e5"
            ]
        ]
    },
    {
        "id": "8adc6000aeb955ec",
        "type": "modbus-getter",
        "z": "53d9bed59d4906b4",
        "name": "M2电箱设备状态查询",
        "showStatusActivities": false,
        "showErrors": true,
        "logIOActivities": false,
        "unitid": "32",
        "dataType": "HoldingRegister",
        "adr": "159",
        "quantity": "12",
        "server": "9d637136d961055b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "keepMsgProperties": false,
        "x": 540,
        "y": 600,
        "wires": [
            [
                "fc0b9dd1fd963b40"
            ],
            []
        ]
    },
    {
        "id": "fc0b9dd1fd963b40",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "状态结构组装",
        "func": "let data = msg.payload\nif(data && Array.isArray(data)){\n    let code_pre = \"C-32-\"\n    let statusObj = {}\n    let rs485DeviceStatus = flow.get(\"rs485DeviceStatus\")\n    if (!rs485DeviceStatus) {\n        rs485DeviceStatus = {}\n    }\n    for (let i = 0; i < data.length; i++) {\n        let status = {}\n        status.online = 1\n        status.status = data[i] === 0 ? 'off' : 'on'\n        let idx = (i + 159) + \"\"\n        statusObj[code_pre + idx] = status\n        rs485DeviceStatus[code_pre + idx] = status\n    }\n    flow.set(\"rs485DeviceStatus\", rs485DeviceStatus)\n    let finalStatus = {}\n    let rs485Devices = flow.get(\"rs485Devices\")\n    if (!rs485Devices){\n        rs485Devices = {}\n    }\n    Object.keys(rs485Devices).forEach(function(gateway) {\n        let layerDevices = rs485Devices[gateway]\n        if (!layerDevices){\n            layerDevices = {}\n        }\n        Object.keys(layerDevices).forEach(function(layer) {\n            let devices = layerDevices[layer]\n            if (devices && Array.isArray(devices)) {\n                for (let i = 0; i < devices.length; i++){\n                    if (!statusObj[devices[i].code]){\n                        break;\n                    }\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code] = {}\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].status = statusObj[devices[i].code]\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].code = devices[i].code\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].gateway = gateway\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].layer = layer\n                    \n                    let msgArr = [null, null]\n                    let newMsg = {}\n                    newMsg.topic = \"/iot/status/\" + devices[i].type + \"/\" + devices[i].space + \"/\" + devices[i].floorarea + \"/\" + devices[i].floor + \"/\" + devices[i].area.split(\"_\")[1] + \"/\" + devices[i].name\n                    newMsg.payload = [finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code]]\n                    msgArr[1] = newMsg\n                    node.send(msgArr)\n                }\n            }\n        });\n    });\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function(code) {\n        statusSend.push(finalStatus[code])\n    });\n    let msgArr = [null, null]\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 600,
        "wires": [
            [
                "8865100690e89bba",
                "9daac11ecafe6e1b"
            ],
            []
        ]
    },
    {
        "id": "8865100690e89bba",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "",
        "topic": "/iot/status/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 580,
        "wires": []
    },
    {
        "id": "85deb1cf171572aa",
        "type": "link in",
        "z": "53d9bed59d4906b4",
        "name": "C_32_status_check",
        "links": [],
        "x": 345,
        "y": 560,
        "wires": [
            [
                "8adc6000aeb955ec",
                "ee2bdc45d4c2761f"
            ]
        ]
    },
    {
        "id": "a201d2bac3ab5fc7",
        "type": "modbus-getter",
        "z": "53d9bed59d4906b4",
        "name": "M3电箱设备状态查询",
        "showStatusActivities": false,
        "showErrors": true,
        "logIOActivities": false,
        "unitid": "33",
        "dataType": "HoldingRegister",
        "adr": "159",
        "quantity": "12",
        "server": "9d637136d961055b",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "keepMsgProperties": false,
        "x": 540,
        "y": 720,
        "wires": [
            [
                "ab5271bdbd355710"
            ],
            []
        ]
    },
    {
        "id": "ab5271bdbd355710",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "状态结构组装",
        "func": "let data = msg.payload\nif(data && Array.isArray(data)){\n    let code_pre = \"C-33-\"\n    let statusObj = {}\n    let rs485DeviceStatus = flow.get(\"rs485DeviceStatus\")\n    if (!rs485DeviceStatus) {\n        rs485DeviceStatus = {}\n    }\n    for (let i = 0; i < data.length; i++) {\n        let status = {}\n        status.online = 1\n        status.status = data[i] === 0 ? 'off' : 'on'\n        let idx = (i + 159) + \"\"\n        statusObj[code_pre + idx] = status\n        rs485DeviceStatus[code_pre + idx] = status\n    }\n    flow.set(\"rs485DeviceStatus\", rs485DeviceStatus)\n    let finalStatus = {}\n    let rs485Devices = flow.get(\"rs485Devices\")\n    if (!rs485Devices){\n        rs485Devices = {}\n    }\n    Object.keys(rs485Devices).forEach(function(gateway) {\n        let layerDevices = rs485Devices[gateway]\n        if (!layerDevices){\n            layerDevices = {}\n        }\n        Object.keys(layerDevices).forEach(function(layer) {\n            let devices = layerDevices[layer]\n            if (devices && Array.isArray(devices)) {\n                for (let i = 0; i < devices.length; i++){\n                    if (!statusObj[devices[i].code]){\n                        break;\n                    }\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code] = {}\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].status = statusObj[devices[i].code]\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].code = devices[i].code\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].gateway = gateway\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].layer = layer\n                    \n                    let msgArr = [null, null]\n                    let newMsg = {}\n                    newMsg.topic = \"/iot/status/\" + devices[i].type + \"/\" + devices[i].space + \"/\" + devices[i].floorarea + \"/\" + devices[i].floor + \"/\" + devices[i].area.split(\"_\")[1] + \"/\" + devices[i].name\n                    newMsg.payload = [finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code]]\n                    msgArr[1] = newMsg\n                    node.send(msgArr)\n                }\n            }\n        });\n    });\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function(code) {\n        statusSend.push(finalStatus[code])\n    });\n    let msgArr = [null, null]\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 720,
        "wires": [
            [
                "cdf0e2d3a4754b11",
                "9daac11ecafe6e1b"
            ],
            []
        ]
    },
    {
        "id": "cdf0e2d3a4754b11",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "",
        "topic": "/iot/status/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 700,
        "wires": []
    },
    {
        "id": "3b63ff2c2ddc6210",
        "type": "link in",
        "z": "53d9bed59d4906b4",
        "name": "C_33_status_check",
        "links": [],
        "x": 355,
        "y": 680,
        "wires": [
            [
                "a201d2bac3ab5fc7",
                "c7281da2e55659aa"
            ]
        ]
    },
    {
        "id": "9d02e7b9dd5387b4",
        "type": "modbus-getter",
        "z": "53d9bed59d4906b4",
        "name": "M4电箱设备状态查询",
        "showStatusActivities": false,
        "showErrors": true,
        "logIOActivities": false,
        "unitid": "34",
        "dataType": "HoldingRegister",
        "adr": "159",
        "quantity": "12",
        "server": "8d95443694bab17c",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": false,
        "keepMsgProperties": false,
        "x": 540,
        "y": 840,
        "wires": [
            [
                "9b8846dca87e64d6"
            ],
            []
        ]
    },
    {
        "id": "9b8846dca87e64d6",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "状态结构组装",
        "func": "let data = msg.payload\nif(data && Array.isArray(data)){\n    let code_pre = \"B-34-\"\n    let statusObj = {}\n    let rs485DeviceStatus = flow.get(\"rs485DeviceStatus\")\n    if (!rs485DeviceStatus) {\n        rs485DeviceStatus = {}\n    }\n    for (let i = 0; i < data.length; i++) {\n        let status = {}\n        status.online = 1\n        status.status = data[i] === 0 ? 'off' : 'on'\n        let idx = (i + 159) + \"\"\n        statusObj[code_pre + idx] = status\n        rs485DeviceStatus[code_pre + idx] = status\n    }\n    flow.set(\"rs485DeviceStatus\", rs485DeviceStatus)\n    let finalStatus = {}\n    let rs485Devices = flow.get(\"rs485Devices\")\n    if (!rs485Devices){\n        rs485Devices = {}\n    }\n    Object.keys(rs485Devices).forEach(function(gateway) {\n        let layerDevices = rs485Devices[gateway]\n        if (!layerDevices){\n            layerDevices = {}\n        }\n        Object.keys(layerDevices).forEach(function(layer) {\n            let devices = layerDevices[layer]\n            if (devices && Array.isArray(devices)) {\n                for (let i = 0; i < devices.length; i++){\n                    if (!statusObj[devices[i].code]){\n                        break;\n                    }\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code] = {}\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].status = statusObj[devices[i].code]\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].code = devices[i].code\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].gateway = gateway\n                    finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code].layer = layer\n                    \n                    let msgArr = [null, null]\n                    let newMsg = {}\n                    newMsg.topic = \"/iot/status/\" + devices[i].type + \"/\" + devices[i].space + \"/\" + devices[i].floorarea + \"/\" + devices[i].floor + \"/\" + devices[i].area.split(\"_\")[1] + \"/\" + devices[i].name\n                    newMsg.payload = [finalStatus[gateway+\"_\"+layer+\"_\"+devices[i].code]]\n                    msgArr[1] = newMsg\n                    node.send(msgArr)\n                }\n            }\n        });\n    });\n\n    let statusSend = []\n    Object.keys(finalStatus).forEach(function(code) {\n        statusSend.push(finalStatus[code])\n    });\n    let msgArr = [null, null]\n    let newMsg = {}\n    newMsg.payload = statusSend\n    msgArr[0] = newMsg\n    node.send(msgArr)\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 840,
        "wires": [
            [
                "d261f4477414cc0f",
                "9daac11ecafe6e1b"
            ],
            []
        ]
    },
    {
        "id": "d261f4477414cc0f",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "",
        "topic": "/iot/status/report",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 820,
        "wires": []
    },
    {
        "id": "c90611513a44839e",
        "type": "link in",
        "z": "53d9bed59d4906b4",
        "name": "B_34_status_check",
        "links": [],
        "x": 355,
        "y": 800,
        "wires": [
            [
                "9d02e7b9dd5387b4",
                "11df20d7d261cb01"
            ]
        ]
    },
    {
        "id": "5aef54c29dbbd6e5",
        "type": "link out",
        "z": "53d9bed59d4906b4",
        "name": "link out 1",
        "mode": "return",
        "links": [],
        "x": 465,
        "y": 440,
        "wires": []
    },
    {
        "id": "ee2bdc45d4c2761f",
        "type": "link out",
        "z": "53d9bed59d4906b4",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 465,
        "y": 560,
        "wires": []
    },
    {
        "id": "c7281da2e55659aa",
        "type": "link out",
        "z": "53d9bed59d4906b4",
        "name": "link out 3",
        "mode": "return",
        "links": [],
        "x": 465,
        "y": 680,
        "wires": []
    },
    {
        "id": "11df20d7d261cb01",
        "type": "link out",
        "z": "53d9bed59d4906b4",
        "name": "link out 4",
        "mode": "return",
        "links": [],
        "x": 465,
        "y": 800,
        "wires": []
    },
    {
        "id": "fac3e9260d21a87e",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "发布状态数据",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 860,
        "wires": []
    },
    {
        "id": "5dab89feaad256f4",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "发布状态数据",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 740,
        "wires": []
    },
    {
        "id": "f959409132264a09",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "发布状态数据",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 620,
        "wires": []
    },
    {
        "id": "9856735dc6ae27e0",
        "type": "mqtt out",
        "z": "53d9bed59d4906b4",
        "name": "发布状态数据",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "0e45c8c7cafe4e98",
        "x": 980,
        "y": 500,
        "wires": []
    },
    {
        "id": "5e818ca703ea11e9",
        "type": "delay",
        "z": "53d9bed59d4906b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "200",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 310,
        "y": 840,
        "wires": [
            [
                "9d02e7b9dd5387b4"
            ]
        ]
    },
    {
        "id": "223fee0f093895f5",
        "type": "delay",
        "z": "53d9bed59d4906b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "200",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 310,
        "y": 720,
        "wires": [
            [
                "5e818ca703ea11e9",
                "a201d2bac3ab5fc7"
            ]
        ]
    },
    {
        "id": "3887fbc15c79e553",
        "type": "delay",
        "z": "53d9bed59d4906b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "200",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 310,
        "y": 600,
        "wires": [
            [
                "223fee0f093895f5",
                "8adc6000aeb955ec"
            ]
        ]
    },
    {
        "id": "9daac11ecafe6e1b",
        "type": "debug",
        "z": "53d9bed59d4906b4",
        "name": "debug 132",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 640,
        "wires": []
    },
    {
        "id": "809df6346333bdf1",
        "type": "function",
        "z": "53d9bed59d4906b4",
        "name": "初始化",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "flow.set(\"apList\", []);",
        "finalize": "",
        "libs": [],
        "x": 150,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "c58a246da461c0e9",
        "type": "mqtt in",
        "z": "c1600d84541be6c7",
        "name": "接收传感器数据",
        "topic": "/iot/status/#",
        "qos": "1",
        "datatype": "json",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 260,
        "wires": [
            [
                "6c92b57eb8cb7817"
            ]
        ]
    },
    {
        "id": "6e6a4564e116dc88",
        "type": "batch",
        "z": "c1600d84541be6c7",
        "name": "微批处理 (200条或500ms)",
        "mode": "count",
        "count": "200",
        "overlap": 0,
        "interval": "500",
        "allowEmptySequence": false,
        "honourParts": true,
        "topics": [],
        "x": 670,
        "y": 260,
        "wires": [
            [
                "7c2a552441910178"
            ]
        ]
    },
    {
        "id": "7c2a552441910178",
        "type": "function",
        "z": "c1600d84541be6c7",
        "name": "构建批量插入SQL",
        "func": "/**\n * 高并发 IoT 数据入库逻辑\n * 功能：解析 MQTT/Batch 数据，生成标准 SQL 字符串，并彻底净化 msg 对象\n */\n\n// 1. 初始化数据源（兼容单条消息或 Batch 消息）\nconst messages = Array.isArray(msg.payload) ? msg.payload : [msg];\nlet sqlStatements = [];\nlet stats = { total: messages.length, matched: 0, skipped: 0 };\n\nconst TYPE_CONFIG = {\n    metrics: ['airsensor', 'airconditioning', 'aircleaner', 'smokesensor', 'watersensor', 'wcsensor', 'inundationsensor', 'pad'],\n    status_only: ['light', 'dlight', 'airfan', 'blind', 'humensensor', 'door', 'aicamerasensor']\n};\n\nmessages.forEach((m, idx) => {\n    // 提取有效数据载体\n    const data = m.payload || {};\n    const topic = data.originalTopic || m.topic || \"\";\n\n    // 2. 解析元数据\n    let category = \"\";\n    let campus = \"\", building = \"\", floor = \"\", area = \"\";\n    if (topic) {\n        const parts = topic.split('/');\n        category = parts[3] || \"\";\n        campus = parts[4] || \"\";\n        building = parts[5] || \"\";\n        floor = parts[6] || \"\";\n        area = parts[7] || \"\";\n    }\n\n    // 检查核心字段：没有 code 直接跳过\n    if (!data.code) {\n        node.warn(`[跳过] 第 ${idx} 条：缺少 device code`);\n        stats.skipped++;\n        return;\n    }\n\n    // 处理时间与转义\n    const statusObj = data.status || {};\n    const safeCode = data.code.replace(/'/g, \"''\");\n    const safeGateway = (data.gateway || '').replace(/'/g, \"''\");\n    const safeStatusData = JSON.stringify(statusObj).replace(/'/g, \"''\");\n\n    let isMatched = false;\n\n    // --- 分支匹配逻辑 ---\n\n    // 逻辑 1：电量\n    if (category === 'powersensor') {\n        sqlStatements.push(`INSERT INTO iot_power_data (ts, code, gateway, total_power, total_kwh, details) VALUES (CURRENT_TIMESTAMP, '${safeCode}', '${safeGateway}', ${statusObj.totalPower || 0}, ${statusObj.totalKwh || 0}, '${safeStatusData}')`);\n        isMatched = true;\n    }\n\n    // 逻辑 2：指标\n    if (TYPE_CONFIG.metrics.includes(category)) {\n        sqlStatements.push(`INSERT INTO iot_sensor_metrics (ts, code, category, gateway, campus, building, floor, area, metrics) VALUES (CURRENT_TIMESTAMP, '${safeCode}', '${category}', '${safeGateway}', '${campus}', '${building}', '${floor}', '${area}', '${safeStatusData}')`);\n        isMatched = true;\n    }\n\n    // 逻辑 3：状态\n    if (statusObj.status !== undefined) {\n        const currentStatus = statusObj.status.toString().replace(/'/g, \"''\");\n        const online = statusObj.online !== undefined ? statusObj.online : 1;\n        sqlStatements.push(`INSERT INTO iot_device_status (ts, code, category, status, online, raw_status) VALUES (CURRENT_TIMESTAMP, '${safeCode}', '${category}', '${currentStatus}', ${online}, '${safeStatusData}')`);\n        isMatched = true;\n    }\n\n    if (isMatched) stats.matched++;\n    else stats.skipped++;\n});\n\n// 3. 构建输出\nif (sqlStatements.length > 0) {\n    // 1. 合并 SQL\n    const finalSql = sqlStatements.join('; ') + ';';\n\n    node.status({ fill: \"green\", shape: \"dot\", text: `已生成: ${stats.matched} 条 SQL` });\n\n    // 2. 【核心修复】按照插件文档要求，将 SQL 放入 msg.query\n    // 同时为了保险，payload 也放一份，但真正起作用的是 query\n    return {\n        query: finalSql,\n        payload: finalSql\n    };\n} else {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"本批次无有效数据\" });\n    return null;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 260,
        "wires": [
            [
                "51a068431922b3a2",
                "f803b9a3ec4eeb3f"
            ]
        ]
    },
    {
        "id": "6c92b57eb8cb7817",
        "type": "change",
        "z": "c1600d84541be6c7",
        "name": "提取对象并保存Topic",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0]",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "payload.originalTopic",
                "pt": "msg",
                "to": "topic",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 260,
        "wires": [
            [
                "6e6a4564e116dc88"
            ]
        ]
    },
    {
        "id": "f803b9a3ec4eeb3f",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1160,
        "y": 300,
        "wires": []
    },
    {
        "id": "51a068431922b3a2",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "执行数据库操作",
        "query": "",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1180,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "e6eaef83cf7a41d0",
        "type": "inject",
        "z": "c1600d84541be6c7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 440,
        "wires": [
            [
                "580e7a5a3a163dd0"
            ]
        ]
    },
    {
        "id": "580e7a5a3a163dd0",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "房间灯光开启时长（能耗排名）",
        "query": "SELECT \n    code,\n    category,\n    -- 核心逻辑：统计状态为 'on' 的记录数\n    -- 假设你的 batch/mqtt 是 1分钟左右报一次，count 出来的数字就接近分钟数\n    COUNT(*) FILTER (WHERE status = 'on') AS active_records,\n    -- 如果是 5秒一报，则计算时长为：\n    ROUND(COUNT(*) FILTER (WHERE status = 'on') * 5 / 60.0, 1) AS estimated_active_minutes\nFROM iot_device_status\nWHERE category = 'light'\n  AND ts >= CURRENT_DATE  -- 仅统计今天\nGROUP BY code, category\nORDER BY active_records DESC;",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 410,
        "y": 440,
        "wires": [
            [
                "57170719abda4bea"
            ]
        ]
    },
    {
        "id": "57170719abda4bea",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 440,
        "wires": []
    },
    {
        "id": "edd1edd042c1f78a",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "人体传感器：10分钟内“是否有人的状态”",
        "query": "SELECT \n    code AS sensor_code,\n    -- 核心逻辑：如果在过去 10 分钟内 status 为 'on' 的记录数 > 0，则判定为有人\n    CASE \n        WHEN COUNT(*) FILTER (WHERE status = 'on') > 0 THEN '有人'\n        ELSE '无人'\n    END AS presence_status,\n    -- 记录最后一次检测到人的时间（便于管理人员追溯）\n    MAX(ts) FILTER (WHERE status = 'on') AS last_occupied_at,\n    -- 统计这 10 分钟内总共上报了多少次数据（用于判断传感器是否在线）\n    COUNT(*) AS report_count\nFROM iot_device_status\nWHERE \n    category = 'humensensor'          -- 只筛选人体传感器\n    AND ts > NOW() - INTERVAL '10 minutes' -- 只扫描最近 10 分钟的数据\nGROUP BY code\nORDER BY presence_status DESC;",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 440,
        "y": 500,
        "wires": [
            [
                "f2336ad00dbde8b7"
            ]
        ]
    },
    {
        "id": "e543dc789cb306c6",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 560,
        "wires": []
    },
    {
        "id": "82ad7630e16a72d6",
        "type": "inject",
        "z": "c1600d84541be6c7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 560,
        "wires": [
            [
                "92fbd5b0322a5a43"
            ]
        ]
    },
    {
        "id": "92fbd5b0322a5a43",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "24小时内有那些掉线2分钟以上的照明",
        "query": "WITH sensor_gaps AS (\n    SELECT \n        code,\n        category,\n        ts AS resume_time,                          -- 恢复正常的时间点\n        lag(ts) OVER (PARTITION BY code ORDER BY ts) AS last_active_time, -- 断开前最后一次活跃时间\n        ts - lag(ts) OVER (PARTITION BY code ORDER BY ts) AS gap_duration   -- 断连持续时长\n    FROM iot_device_status\n    WHERE \n        category = 'light'\n        AND ts > now() - INTERVAL '24 hours'        -- 只查过去 24 小时\n)\nSELECT \n    code,\n    last_active_time AS offline_start,              -- 离线开始时刻\n    resume_time AS offline_end,                     -- 离线结束时刻（恢复上线）\n    gap_duration AS duration                        -- 持续时长\nFROM sensor_gaps\nWHERE \n    gap_duration > INTERVAL '10 minutes'             -- 核心逻辑：找出所有超过 2 分钟的间隙\nORDER BY gap_duration DESC;",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 430,
        "y": 560,
        "wires": [
            [
                "e543dc789cb306c6"
            ]
        ]
    },
    {
        "id": "36b91fce67ded8d5",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "哪个设备最“弱不禁风”，",
        "query": "WITH sensor_gaps AS (\n    SELECT \n        code,\n        ts - lag(ts) OVER (PARTITION BY code ORDER BY ts) AS gap_duration\n    FROM iot_device_status\n    WHERE category = 'light' AND ts > now() - INTERVAL '24 hours'\n)\nSELECT \n    code,\n    COUNT(*) AS failure_count,                       -- 过去 24 小时断连次数\n    SUM(gap_duration) AS total_offline_time,         -- 总离线时长\n    MAX(gap_duration) AS longest_failure             -- 最长一次断连时间\nFROM sensor_gaps\nWHERE gap_duration > INTERVAL '2 minutes'\nGROUP BY code\nORDER BY total_offline_time DESC;",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 390,
        "y": 620,
        "wires": [
            [
                "e08a927c767e859b"
            ]
        ]
    },
    {
        "id": "8ab969e57e454c49",
        "type": "inject",
        "z": "c1600d84541be6c7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 620,
        "wires": [
            [
                "36b91fce67ded8d5"
            ]
        ]
    },
    {
        "id": "e08a927c767e859b",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 620,
        "wires": []
    },
    {
        "id": "09d339305a995389",
        "type": "inject",
        "z": "c1600d84541be6c7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 500,
        "wires": [
            [
                "edd1edd042c1f78a"
            ]
        ]
    },
    {
        "id": "f2336ad00dbde8b7",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 500,
        "wires": []
    },
    {
        "id": "8bfa617a3bada937",
        "type": "inject",
        "z": "c1600d84541be6c7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 860,
        "wires": [
            [
                "dace5f0089ef1c0e"
            ]
        ]
    },
    {
        "id": "dace5f0089ef1c0e",
        "type": "postgresql",
        "z": "c1600d84541be6c7",
        "name": "今天每个小时的用电增量曲线",
        "query": "SELECT \n    time_bucket('1 hour', ts) AS hour_slot,\n    code,\n    MAX((raw_status->>'total_kwh')::numeric) - MIN((raw_status->>'total_kwh')::numeric) AS hourly_usage\nFROM iot_device_status\nWHERE category = 'powersensor'\n  AND ts > NOW() - INTERVAL '24 hours'\nGROUP BY hour_slot, code\nORDER BY hour_slot DESC;",
        "postgreSQLConfig": "3b690b97c528cfca",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 660,
        "y": 940,
        "wires": [
            [
                "65c56a12b9762761"
            ]
        ]
    },
    {
        "id": "65c56a12b9762761",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1140,
        "y": 900,
        "wires": []
    },
    {
        "id": "d06a79fa6bff51bc",
        "type": "mqtt in",
        "z": "c1600d84541be6c7",
        "name": "空气数据存入时序数据库",
        "topic": "/iot/airsensor/data/report",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "0e45c8c7cafe4e98",
        "nl": false,
        "rap": false,
        "rh": "1",
        "inputs": 0,
        "x": 170,
        "y": 160,
        "wires": [
            [
                "eeee9118a26e280e"
            ]
        ]
    },
    {
        "id": "eeee9118a26e280e",
        "type": "function",
        "z": "c1600d84541be6c7",
        "name": "数处理",
        "func": "let data = msg.payload\nlet cloums = Object.keys(data)\nlet values = []\nlet keys = \"\"\nlet zw = \"\"\nfor (let i = 0; i < cloums.length; i++){\n   if(i == cloums.length - 1){\n       keys += cloums[i]\n       zw += \"?\"\n   }else{\n       keys += cloums[i]+\", \"\n       zw += \"?, \"\n   }\n   if(cloums[i] == \"ts\"){\n       data[cloums[i]] = moment.tz(data[cloums[i]], \"Asia/Shanghai\").format();\n   }\n   values.push(data[cloums[i]])\n}\n//await global.get(\"mysql_query\")('insert into  tsh_airsensor(' + keys + ') values ('+zw+')', values)\nmsg.query = \"insert into  tsh_airsensor(' + keys + ') values ('+zw+')', values)\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "moment",
                "module": "moment"
            }
        ],
        "x": 400,
        "y": 160,
        "wires": [
            [
                "51a068431922b3a2",
                "bf2edebc242997d0"
            ]
        ]
    },
    {
        "id": "bf2edebc242997d0",
        "type": "debug",
        "z": "c1600d84541be6c7",
        "name": "收到空气传感数据",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 890,
        "y": 120,
        "wires": []
    },
    {
        "id": "42017d0dd241936c",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-postgresql": "0.15.4",
            "node-red-contrib-modbus": "5.45.1",
            "node-red-contrib-weather": "0.1.2",
            "node-red-contrib-lifesmart": "2.0.1"
        }
    }
]