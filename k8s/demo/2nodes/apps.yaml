apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: buildingos-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      imagePullSecrets:
      - name: swr-registry-key
      containers:
      - name: backend
        image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-backend:latest
        env:
        - name: NODE_ENV
          value: "production"
        # Update DB connection to High Available Cluster (Read-Write Service)
        - name: DATABASE_URL
          value: "postgresql://buildingos:buildingos_prod_2024@postgres-ha-rw:5432/buildingos"
        - name: DB_TYPE
          value: "postgres"
        - name: DB_HOST
          value: "postgres-ha-rw"
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "buildingos"
        - name: DB_PASSWORD
          value: "buildingos_prod_2024"
        - name: DB_NAME
          value: "buildingos"
        - name: REDIS_URL
          value: "redis://:redis_prod_2024@redis:6379"
        - name: TDENGINE_URL
          value: "tdengine:6030"
        - name: MQTT_BROKER_URL
          value: "ws://emqx:8083/mqtt"
        - name: MQTT_USERNAME
          value: "buildingos"
        - name: MQTT_PASSWORD
          value: "buildingos_emqx_2024"
        - name: LOG_LEVEL
          value: "info"
        - name: MAX_FILE_SIZE
          value: "10MB"
        - name: ZLM_HOST
          value: "zlmediakit"
        - name: ZLM_PORT
          value: "8080"
        - name: ZLM_SECRET
          value: "buildingos"
        - name: ZLM_API_HOST
          value: "zlmediakit"
        - name: ZLM_API_PORT
          value: "80"
        - name: AI_PROVIDER
          value: "deepseek"
        - name: AI_MODEL
          value: "deepseek-chat"
        - name: AI_ENABLE_LOCAL
          value: "false"
        livenessProbe:
          exec:
            command: ["curl", "-f", "http://localhost:3001/api"]
          initialDelaySeconds: 60
          periodSeconds: 30
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: buildingos-demo
spec:
  type: NodePort
  selector:
    app: backend
  ports:
  - port: 3001
    nodePort: 30001
---
apiVersion: v1
kind: Service
metadata:
  name: buildingos-backend
  namespace: buildingos-demo
spec:
  selector:
    app: backend
  ports:
  - port: 3001
---
# ConfigMap for Frontend Runtime Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: buildingos-demo
data:
  config.js: |
    window.config = {
      // 这里的 /v1 必须与 Ingress 中配置的路径一致
      // 前端代码必须从 window.APP_CONFIG.API_BASE_URL 读取，而不是 .env
      VITE_APP_BASE_URL: "/v1",
      TITLE: "BuildingOS Demo"
    };
---
# ConfigMap for Frontend Nginx Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-nginx-config
  namespace: buildingos-demo
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        # 日志格式
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        # 基本设置
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Gzip 压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/json
            application/javascript
            application/xml+rss
            application/atom+xml
            image/svg+xml;

        server {
            listen       80;
            server_name  localhost;
            root   /mnt/frontend/webroot;
            index  index.html index.htm;
            
            # 增加 access_log 以便调试
            access_log /var/log/nginx/host.access.log main;
            error_log /var/log/nginx/error.log debug;

            location / {
                try_files $uri $uri/ /index.html;
            }

            # Proxy API requests to backend
        # 使用 Service 名称进行反向代理，实现 K8s 环境下的标准化部署
        location /v1/ {
            # 关键配置：
            # 1. 使用 K8s Service 名称 "backend" (同命名空间下)
            # 2. 端口 3001
            # 3. 尾部的斜杠 / 是必须的，利用 Nginx 特性自动去除匹配的 /v1/ 前缀
            proxy_pass http://backend:3001/;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # MQTT WebSocket 代理
        location /mqtt {
            proxy_pass http://emqx:8083/mqtt;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
            
            location /health {
                return 200 'OK';
                add_header Content-Type text/plain;
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: buildingos-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
      - name: swr-registry-key
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - frontend
            topologyKey: kubernetes.io/hostname
      initContainers:
      - name: inject-config
        image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-web:latest
        command: ["sh", "-c"]
        args:
          - |
            # 等待 frontend-init Job 完成（通过检测文件）
            # 或者简单的覆盖（假设 Job 已经运行）
            # 为了稳健，我们检查目录是否存在
            for dir in os h5 pad meetingpad; do
              if [ -d "/mnt/frontend/webroot/$dir" ]; then
                cp /config/config.js "/mnt/frontend/webroot/$dir/config.js"
                echo "Injected config into $dir"
              else
                echo "Warning: Directory $dir not found, skipping config injection"
              fi
            done
        volumeMounts:
        - name: frontend-data
          mountPath: /mnt/frontend/webroot
        - name: config-volume
          mountPath: /config
      containers:
      - name: frontend
        image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-web:latest
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 40
          periodSeconds: 30
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        volumeMounts:
        - name: frontend-data
          mountPath: /mnt/frontend/webroot
        # 挂载 config.js 覆盖默认文件
        # 使用 initContainer 注入，移除直接挂载以避免覆盖问题
        # Mount custom Nginx configuration
        - name: nginx-config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
      volumes:
      - name: frontend-data
        persistentVolumeClaim:
          claimName: frontend-pvc
      - name: config-volume
        configMap:
          name: frontend-config
      - name: nginx-config-volume
        configMap:
          name: frontend-nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: buildingos-demo
spec:
  selector:
    app: frontend
  ports:
  - port: 80
