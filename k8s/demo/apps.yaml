apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: buildingos-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      imagePullSecrets:
      - name: swr-registry-key
      containers:
      - name: backend
        image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-backend:latest
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          value: "postgresql://buildingos:buildingos_prod_2024@postgres:5432/buildingos"
        - name: DB_TYPE
          value: "postgres"
        - name: DB_HOST
          value: "postgres"
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "buildingos"
        - name: DB_PASSWORD
          value: "buildingos_prod_2024"
        - name: DB_NAME
          value: "buildingos"
        - name: REDIS_URL
          value: "redis://:redis_prod_2024@redis:6379"
        - name: TDENGINE_URL
          value: "tdengine:6030"
        - name: MQTT_BROKER_URL
          value: "ws://emqx:8083/mqtt"
        - name: MQTT_USERNAME
          value: "buildingos"
        - name: MQTT_PASSWORD
          value: "buildingos_emqx_2024"
        - name: LOG_LEVEL
          value: "info"
        - name: MAX_FILE_SIZE
          value: "10MB"
        - name: ZLM_HOST
          value: "zlmediakit"
        - name: ZLM_PORT
          value: "8080"
        - name: ZLM_SECRET
          value: "buildingos"
        - name: ZLM_API_HOST
          value: "zlmediakit"
        - name: ZLM_API_PORT
          value: "80"
        - name: AI_PROVIDER
          value: "deepseek"
        - name: AI_MODEL
          value: "deepseek-chat"
        - name: AI_ENABLE_LOCAL
          value: "false"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: buildingos-demo
spec:
  selector:
    app: backend
  ports:
  - port: 3001
---
apiVersion: v1
kind: Service
metadata:
  name: buildingos-backend
  namespace: buildingos-demo
spec:
  selector:
    app: backend
  ports:
  - port: 3001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: buildingos-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
      - name: swr-registry-key
      containers:
      - name: frontend
        image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-web:latest
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        volumeMounts:
        - name: frontend-data
          mountPath: /mnt/frontend/webroot
      volumes:
      - name: frontend-data
        persistentVolumeClaim:
          claimName: frontend-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: buildingos-demo
spec:
  selector:
    app: frontend
  ports:
  - port: 80
