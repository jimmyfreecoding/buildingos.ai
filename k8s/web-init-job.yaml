apiVersion: batch/v1
kind: Job
metadata:
  name: web-init
  namespace: buildingos-prod
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        job: web-init
    spec:
      imagePullSecrets:
        - name: swr-cred
      restartPolicy: Never
      containers:
        - name: web-init
          image: swr.cn-east-3.myhuaweicloud.com/geeqee/buildingos-web:latest
          command:
            - sh
            - -lc
            - |
              set -e
              if [ -f /mnt/frontend/webroot/.initialized ]; then echo 'webroot already initialized, skip'; exit 0; fi
              for z in /tmp/*.zip; do [ -f "$z" ] || continue; app=$(basename "$z" .zip); dest="/mnt/frontend/webroot/$app"; mkdir -p "$dest"; unzip -o "$z" -d "$dest"; done
              mkdir -p /mnt/frontend/webroot/releases /mnt/frontend/webroot/uploads
              chown -R 1001:1001 /mnt/frontend/webroot
              touch /mnt/frontend/webroot/.initialized
          volumeMounts:
            - name: frontend-data
              mountPath: /mnt/frontend/webroot
      volumes:
        - name: frontend-data
          persistentVolumeClaim:
            claimName: buildingos-prod-frontend-data

